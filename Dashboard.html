<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Operix - Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  /* Out of Stock Animation */
  @keyframes pulse-red {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .out-of-stock-badge {
    animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

// Lucide Icons as SVG components
const Package = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
  </svg>
);

const ShoppingCart = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
  </svg>
);

const FileText = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
  </svg>
);

const Settings = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
  </svg>
);

const TrendingUp = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
  </svg>
);

const AlertTriangle = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
  </svg>
);

const DollarSign = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
);

const Bell = () => (
  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
  </svg>
);

const Search = () => (
  <svg className="w-4 h-4 absolute left-3 top-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
  </svg>
);

const Menu = () => (
  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
  </svg>
);

const X = () => (
  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
  </svg>
);

const ChevronDown = () => (
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
  </svg>
);

const LogOut = () => (
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
  </svg>
);

const Plus = () => (
  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
  </svg>
);

const Edit = () => (
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
  </svg>
);

const Trash = () => (
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
  </svg>
);

const Users = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
  </svg>
);

const BarChart = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
  </svg>
);

const Image = () => (
  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
  </svg>
);

const XCircle = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
);

// Operix Logo Component (same as login page)
const OperixLogo = ({ size = 'default' }) => {
  const dimensions = size === 'small' ? { w: 40, h: 40, iconW: 6, iconH: 6, rectW: 4, rectH: 4 } 
                    : { w: 60, h: 60, iconW: 6, iconH: 6, rectW: 4, rectH: 4 };
  
  return (
    <svg width={dimensions.w} height={dimensions.h} viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" rx="8" fill="#050C9C"/>
      <path d="M20 10 C25 10 28 13 28 18 C28 23 25 26 20 26 C15 26 12 23 12 18 C12 13 15 10 20 10 Z M20 14 C17 14 16 15.5 16 18 C16 20.5 17 22 20 22 C23 22 24 20.5 24 18 C24 15.5 23 14 20 14 Z" fill="white"/>
      <rect x="18" y="26" width="4" height="4" fill="white"/>
    </svg>
  );
};

function Dashboard() {

  const RENDER_CONFIG = {
    BACKEND_URL: 'https://operix-inventory-webhooks.onrender.com',
    WEBHOOK_SECRET: 'banana_pizza_unicorn_777_secret'
  };

  // Email notification function
  const sendEmailNotification = async (type, data) => {
  try {
    const RENDER_BACKEND_URL = RENDER_CONFIG.BACKEND_URL;
    const WEBHOOK_SECRET = RENDER_CONFIG.WEBHOOK_SECRET;
    
    let endpoint = '';
    let body = {};
    
    if (type === 'invoice') {
      endpoint = '/webhook/send-invoice';
      body = {
        orderNumber: data.orderNumber,
        customerEmail: data.customerEmail,
        customerName: data.customerName,
        items: data.items,
        total: data.totalAmount,
        invoiceUrl: data.invoiceUrl || ''
      };
      
      console.log(`üìß Sending ${type} email to ${endpoint}...`, body);
      
      const response = await fetch(`${RENDER_BACKEND_URL}${endpoint}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${WEBHOOK_SECRET}`
        },
        body: JSON.stringify(body)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('‚ùå Email notification failed:', errorText);
      } else {
        const result = await response.json();
        console.log('‚úÖ Email sent successfully:', result);
      }
      
    } else if (type === 'low-stock') {
      // Get all admin emails
      const adminEmails = await getAllAdminEmails();
      
      // Send alert to EACH admin
      for (const adminEmail of adminEmails) {
        endpoint = '/webhook/low-stock-alert';
        body = {
          productName: data.name,
          productId: data.id,
          currentStock: data.stock,
          threshold: data.threshold,
          adminEmail: adminEmail
        };
        
        console.log(`üìß Sending low-stock alert to admin: ${adminEmail}...`, body);
        
        const response = await fetch(`${RENDER_BACKEND_URL}${endpoint}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${WEBHOOK_SECRET}`
          },
          body: JSON.stringify(body)
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error(`‚ùå Email notification failed for ${adminEmail}:`, errorText);
        } else {
          const result = await response.json();
          console.log(`‚úÖ Email sent to ${adminEmail}:`, result);
        }
      }
      
    } else if (type === 'order-status') {
      endpoint = '/webhook/order-status';
      body = {
        orderNumber: data.orderNumber,
        customerEmail: data.customerEmail,
        customerName: data.customerName,
        status: data.status,
        trackingUrl: data.trackingUrl || ''
      };
      
      console.log(`üìß Sending ${type} email to ${endpoint}...`, body);
      
      const response = await fetch(`${RENDER_BACKEND_URL}${endpoint}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${WEBHOOK_SECRET}`
        },
        body: JSON.stringify(body)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('‚ùå Email notification failed:', errorText);
      } else {
        const result = await response.json();
        console.log('‚úÖ Email sent successfully:', result);
      }
    }
    
  } catch (error) {
    console.error('‚ùå Email error:', error);
  }
};

  // Get admin email from Firestore
// Get ALL admin emails from Firestore
const getAllAdminEmails = async () => {
  try {
    const db = firebase.firestore();
    const adminSnapshot = await db.collection('users')
      .where('role', '==', 'admin')
      .where('isAdmin', '==', true)
      .get();
    
    if (!adminSnapshot.empty) {
      const adminEmails = adminSnapshot.docs.map(doc => doc.data().email);
      console.log('üì¨ Admin emails found:', adminEmails);
      return adminEmails; // Return array of all admin emails
    }
    
    console.warn('‚ö†Ô∏è No admins found, using fallback');
    return ['darkgenesis09@gmail.com']; // Fallback to your email
  } catch (error) {
    console.error('Error fetching admin emails:', error);
    return ['darkgenesis09@gmail.com']; // Fallback
  }
};

  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeModule, setActiveModule] = useState('dashboard');
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [showUserMenu, setShowUserMenu] = useState(false);
  const [notifications, setNotifications] = useState([]);
  const [showNotificationDropdown, setShowNotificationDropdown] = useState(false);
  const [userRole, setUserRole] = useState(null);
  
  const [stats, setStats] = useState({
    totalProducts: 0,
    lowStock: 0,
    outOfStock: 0,
    pendingOrders: 0,
    todaySales: 0,
    totalOrders: 0,
    completedOrders: 0,
  });

  const [recentOrders, setRecentOrders] = useState([]);
  const [lowStockItems, setLowStockItems] = useState([]);
  const [outOfStockItems, setOutOfStockItems] = useState([]);
  
  // Inventory state
  const [products, setProducts] = useState([]);
  const [showAddProduct, setShowAddProduct] = useState(false);
  const [editingProduct, setEditingProduct] = useState(null);
  const [productForm, setProductForm] = useState({
    name: '', 
    sku: '', 
    category: '', 
    price: '', 
    stock: '', 
    threshold: '', 
    unit: 'pieces', 
    description: '', 
    imageUrl: '', 
    supplier: ''
  });
  const [uploadingImage, setUploadingImage] = useState(false);
  
  // Orders state
  const [orders, setOrders] = useState([]);
  const [showCreateOrder, setShowCreateOrder] = useState(false);
  const [cart, setCart] = useState([]);
  const [orderForm, setOrderForm] = useState({
    customerName: '', 
    customerEmail: '', 
    customerPhone: '',
    deliveryAddress: '', 
    paymentMethod: 'Cash', 
    notes: ''
  });

  // Search and filter
  const [searchQuery, setSearchQuery] = useState('');
  const [categoryFilter, setCategoryFilter] = useState('all');
  const [submittingOrder, setSubmittingOrder] = useState(false);
  const [stockFilter, setStockFilter] = useState('all'); // New: all, in-stock, low-stock, out-of-stock
  
  useEffect(() => {
    const checkAuth = () => {
      const firebaseConfig = {
        apiKey: "AIzaSyB56dPmBwgO4uWyXakhY9SJBCAz7bk0Do8",
        authDomain: "operix-c8a8c.firebaseapp.com",
        projectId: "operix-c8a8c",
        storageBucket: "operix-c8a8c.firebasestorage.app",
        messagingSenderId: "794223223499",
        appId: "1:794223223499:web:f059007b909cc15766f14e",
        measurementId: "G-6E4BD657K1"
      };

      const initFirebase = setInterval(() => {
        if (window.firebase) {
          clearInterval(initFirebase);
          
          if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
          }
          
          const auth = firebase.auth();
          const db = firebase.firestore();

          auth.onAuthStateChanged(async (currentUser) => {
            if (currentUser) {
              const userDoc = await db.collection('users').doc(currentUser.uid).get();
              if (userDoc.exists) {
                const userData = userDoc.data();
                
                if (userData.role === 'admin' || userData.status === 'approved') {
                  setUser({
                    uid: currentUser.uid,
                    email: currentUser.email,
                    displayName: userData.fullName || currentUser.email,
                    ...userData
                  });
                  setUserRole(userData.role || 'user');
                  await loadDashboardData(currentUser.uid, userData.role || 'user', db);
                } else {
                  window.location.href = 'login.html';
                }
              } else {
                window.location.href = 'login.html';
              }
            } else {
              window.location.href = 'login.html';
            }
            setLoading(false);
          });
        }
      }, 100);
    };

    checkAuth();
  }, []);

  const loadDashboardData = async (userId, role, db) => {
    try {
      // Load products
      const productsSnapshot = await db.collection('products').orderBy('createdAt', 'desc').get();
      const productsData = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setProducts(productsData);
      
      // Load orders
      let ordersQuery = db.collection('orders').orderBy('createdAt', 'desc');
      if (role !== 'admin') {
        ordersQuery = ordersQuery.where('customerId', '==', userId);
      }
      const ordersSnapshot = await ordersQuery.get();
      const ordersData = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setOrders(ordersData);
      
      // Calculate stats - SEPARATE out of stock and low stock
      const outOfStockProducts = productsData.filter(p => p.stock === 0);
      const lowStockProducts = productsData.filter(p => p.stock > 0 && p.stock <= p.threshold);
      const pendingOrdersCount = ordersData.filter(o => o.status === 'pending').length;
      const completedOrdersCount = ordersData.filter(o => o.status === 'completed').length;
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todaySalesTotal = ordersData
        .filter(o => 
          o.createdAt && 
          o.createdAt.toDate() >= today && 
          o.status !== 'cancelled'
        )
        .reduce((sum, o) => sum + (o.totalAmount || 0), 0);
      
      setStats({
        totalProducts: productsData.length,
        lowStock: lowStockProducts.length,
        outOfStock: outOfStockProducts.length,
        pendingOrders: pendingOrdersCount,
        todaySales: todaySalesTotal,
        totalOrders: ordersData.length,
        completedOrders: completedOrdersCount,
      });
      
      setRecentOrders(ordersData.slice(0, 5));
      setLowStockItems(lowStockProducts.slice(0, 5));
      setOutOfStockItems(outOfStockProducts.slice(0, 5));
       
      // Load notifications
      await loadNotifications(db);
    } catch (error) {
      console.error('Error loading dashboard data:', error);
    }
  };
  
  
  
  
  
  // ADD THESE NEW FUNCTIONS HERE:
  const createNotification = async (type, message, details = {}) => {
    try {
      const db = firebase.firestore();
      const notificationData = {
        type, // 'order', 'stock-alert', 'product-edit', 'order-status'
        message,
        details,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        read: false,
        userId: user.uid,
        userRole: userRole
      };
      
      await db.collection('notifications').add(notificationData);
      
      // Reload notifications
      await loadNotifications(db);
    } catch (error) {
      console.error('Error creating notification:', error);
    }
  };

  const loadNotifications = async (db) => {
  try {
    // Safety check: if user is not loaded yet, skip
    if (!user || !user.uid) {
      console.log('User not loaded yet, skipping notifications');
      return;
    }
    
    let notificationsQuery = db.collection('notifications')
      .orderBy('timestamp', 'desc')
      .limit(20);
    
    // Admins see all notifications, users see only their own
    if (userRole !== 'admin') {
      notificationsQuery = notificationsQuery.where('userId', '==', user.uid);
    }
    
    const snapshot = await notificationsQuery.get();
    const notifs = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      timeAgo: getTimeAgo(doc.data().timestamp)
    }));
    
    setNotifications(notifs);
  } catch (error) {
    console.error('Error loading notifications:', error);
  }
};

  const getTimeAgo = (timestamp) => {
    if (!timestamp) return 'Just now';
    
    const now = new Date();
    const time = timestamp.toDate();
    const diffMs = now - time;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    return `${diffDays}d ago`;
  };

const markNotificationAsRead = async (notificationId) => {
  try {
    const db = firebase.firestore();
    const notifRef = db.collection('notifications').doc(String(notificationId));
    const notifDoc = await notifRef.get();
    
    if (notifDoc.exists) {
      await notifRef.update({ read: true });
      await loadNotifications(db);
    }
  } catch (error) {
    console.error('Error marking notification as read:', error);
  }
};

const markAllAsRead = async () => {
  try {
    const db = firebase.firestore();
    const batch = db.batch();
    
    notifications.filter(n => !n.read).forEach(notif => {
      const ref = db.collection('notifications').doc(String(notif.id));
      batch.update(ref, { read: true });
    });
    
    await batch.commit();
    await loadNotifications(db);
  } catch (error) {
    console.error('Error marking all as read:', error);
  }
};
  
  
  
  

  const uploadToCloudinary = (file) => {
    if (!file) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const selectedFile = e.target.files[0];
        if (selectedFile) {
          uploadToCloudinary(selectedFile);
        }
      };
      input.click();
      return;
    }

    setUploadingImage(true);

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'operix_products');
    formData.append('folder', 'operix-products');

    const xhr = new XMLHttpRequest();

    xhr.upload.addEventListener('progress', (e) => {
      if (e.lengthComputable) {
        const percentComplete = Math.round((e.loaded / e.total) * 100);
        console.log(`Upload progress: ${percentComplete}%`);
      }
    });

    xhr.addEventListener('load', () => {
      if (xhr.status === 200) {
        const response = JSON.parse(xhr.responseText);
        setProductForm(prev => ({ ...prev, imageUrl: response.secure_url }));
        setUploadingImage(false);
        console.log('Image uploaded successfully:', response.secure_url);
      } else {
        console.error('Upload failed with status:', xhr.status);
        alert('Failed to upload image. Please try again.');
        setUploadingImage(false);
      }
    });

    xhr.addEventListener('error', () => {
      console.error('Upload error');
      alert('Failed to upload image. Please try again.');
      setUploadingImage(false);
    });

    xhr.open('POST', 'https://api.cloudinary.com/v1_1/dmrtrl4er/image/upload');
    xhr.send(formData);
  };

  // Product CRUD operations
  const saveProduct = async () => {
    try {
      if (!productForm.name || !productForm.sku || !productForm.price || productForm.stock === '') {
        alert('Please fill in all required fields');
        return;
      }

      const db = firebase.firestore();
      const newStock = parseInt(productForm.stock);
      const threshold = parseInt(productForm.threshold) || 10;
      
      const productData = {
        ...productForm,
        price: parseFloat(productForm.price),
        stock: newStock,
        threshold: threshold,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (editingProduct) {
        await db.collection('products').doc(editingProduct.id).update(productData);
        
        await db.collection('adminLogs').add({
          adminId: user.uid,
          adminName: user.displayName,
          action: 'Updated Product',
          details: `Updated product: ${productForm.name} (${productForm.sku})`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create notification for product update
        await createNotification(
          'product-edit',
          `Product updated: ${productForm.name}`,
          {
            productName: productForm.name,
            sku: productForm.sku,
            action: 'updated',
            changes: 'Product details modified'
          }
        );
      } else {
        await db.collection('products').add({
          ...productData,
          createdBy: user.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        await db.collection('adminLogs').add({
        adminId: user.uid,
        adminName: user.displayName,
        action: 'Added Product',
        details: `Added new product: ${productForm.name} (${productForm.sku})`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Create notification for product addition
      await createNotification(
        'product-edit',
        `Product added: ${productForm.name}`,
        {
          productName: productForm.name,
          sku: productForm.sku,
          action: 'added',
          changes: 'New product created'
        }
      );
    }

      // Check for low stock and send alert
      if (newStock > 0 && newStock <= threshold) {
        console.log('üîî Low stock detected, sending email...');
        await sendEmailNotification('low-stock', {
          name: productForm.name,
          id: editingProduct?.id || 'new-product',
          stock: newStock,
          threshold: threshold
        });
      }

      await loadDashboardData(user.uid, userRole, db);
      setShowAddProduct(false);
      setEditingProduct(null);
      resetProductForm();
      alert('Product saved successfully!');
    } catch (error) {
      console.error('Error saving product:', error);
      alert('Error saving product. Please try again.');
    }
  };

  const deleteProduct = async (productId) => {
    if (!confirm('Are you sure you want to delete this product?')) return;
    try {
      const db = firebase.firestore();
      const product = products.find(p => p.id === productId);
      
      await db.collection('products').doc(productId).delete();
      
      await db.collection('adminLogs').add({
        adminId: user.uid,
        adminName: user.displayName,
        action: 'Deleted Product',
        details: `Deleted product: ${product.name} (${product.sku})`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      await loadDashboardData(user.uid, userRole, db);
      alert('Product deleted successfully!');
    } catch (error) {
      console.error('Error deleting product:', error);
      alert('Error deleting product. Please try again.');
    }
  };

  const resetProductForm = () => {
    setProductForm({
      name: '', 
      sku: '', 
      category: '', 
      price: '', 
      stock: '', 
      threshold: '', 
      unit: 'pieces', 
      description: '', 
      imageUrl: '', 
      supplier: ''
    });
  };

  // Order operations
  const addToCart = (product) => {
    if (product.stock === 0) {
      alert('This product is out of stock!');
      return;
    }
    
    const existing = cart.find(item => item.id === product.id);
    if (existing) {
      setCart(cart.map(item => 
        item.id === product.id 
          ? { ...item, quantity: Math.min(item.quantity + 1, product.stock) }
          : item
      ));
    } else {
      setCart([...cart, { ...product, quantity: 1 }]);
    }
  };

  const updateCartQuantity = (productId, quantity) => {
    const product = products.find(p => p.id === productId);
    if (quantity <= 0) {
      setCart(cart.filter(item => item.id !== productId));
    } else if (quantity > product.stock) {
      alert(`Only ${product.stock} ${product.unit} available in stock`);
    } else {
      setCart(cart.map(item => 
        item.id === productId ? { ...item, quantity } : item
      ));
    }
  };

  const removeFromCart = (productId) => {
    setCart(cart.filter(item => item.id !== productId));
  };

  const calculateTotal = () => {
    return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  };

const submitOrder = async () => {
  if (cart.length === 0) {
    alert('Please add items to cart');
    return;
  }
  if (!orderForm.customerName || !orderForm.customerEmail || !orderForm.deliveryAddress) {
    alert('Please fill in all required fields (Name, Email, Delivery Address)');
    return;
  }
  
  // Prevent multiple submissions
  if (submittingOrder) {
    return;
  }

  try {
    setSubmittingOrder(true); // Disable button
    
    const db = firebase.firestore();
    const batch = db.batch();

    // Generate unique sequential order number
    const counterRef = db.collection('counters').doc('orderCounter');
    const counterDoc = await counterRef.get();

    let orderCount = 1;
    if (counterDoc.exists) {
      orderCount = counterDoc.data().count + 1;
      await counterRef.update({ count: firebase.firestore.FieldValue.increment(1) });
    } else {
      await counterRef.set({ count: 1 });
    }

    const orderNumber = `ORD-${String(orderCount).padStart(4, '0')}`;

    // Create order
    const orderRef = db.collection('orders').doc();
    const orderData = {
      orderNumber,
      customerId: user.uid,
      customerName: orderForm.customerName,
      customerEmail: orderForm.customerEmail,
      customerPhone: orderForm.customerPhone,
      deliveryAddress: orderForm.deliveryAddress,
      paymentMethod: orderForm.paymentMethod,
      notes: orderForm.notes,
      items: cart.map(item => ({
        productId: item.id,
        name: item.name,
        sku: item.sku,
        quantity: item.quantity,
        price: item.price,
        unit: item.unit,
        subtotal: item.price * item.quantity
      })),
      totalAmount: calculateTotal(),
      status: 'pending',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    batch.set(orderRef, orderData);

    // Update product stock and check for low stock alerts
    const stockAlerts = [];
    for (const item of cart) {
      const productRef = db.collection('products').doc(item.id);
      const productDoc = await productRef.get();
      const productData = productDoc.data();
      
      const newStock = productData.stock - item.quantity;
      const threshold = productData.threshold || 10;
      
      // Update stock in batch
      batch.update(productRef, {
        stock: firebase.firestore.FieldValue.increment(-item.quantity)
      });
      
      // Check if stock alert is needed
      if (newStock === 0) {
        // Out of stock alert
        stockAlerts.push({
          type: 'out-of-stock',
          product: { ...productData, id: item.id, stock: newStock }
        });
      } else if (newStock > 0 && newStock <= threshold && productData.stock > threshold) {
        // Just crossed threshold - send low stock alert
        stockAlerts.push({
          type: 'low-stock',
          product: { ...productData, id: item.id, stock: newStock, threshold }
        });
      }
    }

    await batch.commit();
    
    // Send stock alerts after order is committed
      for (const alert of stockAlerts) {
        console.log(`üìß Sending ${alert.type} alert for ${alert.product.name}...`);
        await sendEmailNotification('low-stock', {
          name: alert.product.name,
          id: alert.product.id,
          stock: alert.product.stock,
          threshold: alert.product.threshold || 10
        });
        
        // CREATE NOTIFICATION FOR STOCK ALERT
        await createNotification(
          'stock-alert',
          `${alert.type === 'out-of-stock' ? 'OUT OF STOCK' : 'LOW STOCK'}: ${alert.product.name}`,
          {
            productName: alert.product.name,
            productId: alert.product.id,
            stock: alert.product.stock,
            threshold: alert.product.threshold,
            alertType: alert.type
          }
        );
      }
    
    // Send invoice email
    console.log('üìß Sending invoice email...');
    await sendEmailNotification('invoice', {
      orderNumber: orderNumber,
      customerEmail: orderForm.customerEmail,
      customerName: orderForm.customerName,
      items: cart.map(item => ({
        name: item.name,
        quantity: item.quantity,
        price: item.price.toFixed(2)
      })),
      totalAmount: calculateTotal().toFixed(2)
    });
    
     // CREATE NOTIFICATION FOR ORDER
    await createNotification(
      'order',
      `Order ${orderNumber} placed successfully`,
      {
        orderNumber,
        customerName: orderForm.customerName,
        totalAmount: calculateTotal(),
        status: 'pending'
      }
    );
    
    await loadDashboardData(user.uid, userRole, db);
    
    setShowCreateOrder(false);
    setCart([]);
    setOrderForm({
      customerName: '', 
      customerEmail: '', 
      customerPhone: '',
      deliveryAddress: '', 
      paymentMethod: 'Cash', 
      notes: ''
    });
    
    alert(`Order ${orderNumber} created successfully! Invoice sent to ${orderForm.customerEmail}`);
  } catch (error) {
    console.error('Error creating order:', error);
    alert('Error creating order. Please try again.');
  } finally {
    setSubmittingOrder(false); // Re-enable button
  }
};

  const updateOrderStatus = async (orderId, newStatus) => {
    try {
      const db = firebase.firestore();
      const order = orders.find(o => o.id === orderId);
      
      if (newStatus === 'cancelled' && order.status === 'cancelled') {
        alert('This order is already cancelled!');
        return;
      }
      
      if (newStatus === 'cancelled' && order.status === 'completed') {
        if (!confirm('This order is already completed. Are you sure you want to cancel it?')) {
          return;
        }
      }
      
      // If cancelling an order, return stock to inventory
      if (newStatus === 'cancelled' && order.status !== 'cancelled') {
        const batch = db.batch();
        
        order.items.forEach(item => {
          const productRef = db.collection('products').doc(item.productId);
          batch.update(productRef, {
            stock: firebase.firestore.FieldValue.increment(item.quantity)
          });
        });
        
        const orderRef = db.collection('orders').doc(orderId);
        batch.update(orderRef, {
          status: newStatus,
          cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        await batch.commit();
      } else {
        await db.collection('orders').doc(orderId).update({
          status: newStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      
      // Send status update email
      console.log('üìß Sending order status update email...');
      await sendEmailNotification('order-status', {
        orderNumber: order.orderNumber,
        customerEmail: order.customerEmail,
        customerName: order.customerName,
        status: newStatus
      });

     await db.collection('adminLogs').add({
        adminId: user.uid,
        adminName: user.displayName,
        action: 'Updated Order Status',
        details: `Changed order ${order.orderNumber} status to ${newStatus}`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // CREATE NOTIFICATION FOR ORDER STATUS
      await createNotification(
        'order-status',
        `Order ${order.orderNumber} ${newStatus}`,
        {
          orderNumber: order.orderNumber,
          customerName: order.customerName,
          oldStatus: order.status,
          newStatus: newStatus
        }
      );
      
      await loadDashboardData(user.uid, userRole, db);
      alert(`Order status updated to ${newStatus}. Email notification sent to ${order.customerEmail}`);
    } catch (error) {
      console.error('Error updating order:', error);
      alert('Error updating order. Please try again.');
    }
  };

  const handleLogout = async () => {
    try {
      const auth = firebase.auth();
      await auth.signOut();
      window.location.href = 'login.html';
    } catch (error) {
      console.error('Logout error:', error);
    }
  };

  // Get unique categories
  const categories = [...new Set(products.map(p => p.category).filter(Boolean))];

  // Filter products
  const filteredProducts = products.filter(product => {
    const matchesSearch = product.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                         product.sku.toLowerCase().includes(searchQuery.toLowerCase());
    const matchesCategory = categoryFilter === 'all' || product.category === categoryFilter;
    
    let matchesStock = true;
    if (stockFilter === 'out-of-stock') {
      matchesStock = product.stock === 0;
    } else if (stockFilter === 'low-stock') {
      matchesStock = product.stock > 0 && product.stock <= product.threshold;
    } else if (stockFilter === 'in-stock') {
      matchesStock = product.stock > product.threshold;
    }
    
    return matchesSearch && matchesCategory && matchesStock;
  });

  const modules = userRole === 'admin' 
    ? [
        { id: 'dashboard', name: 'Dashboard', icon: TrendingUp, color: 'from-purple-500 to-pink-500' },
        { id: 'inventory', name: 'Inventory', icon: Package, color: 'from-blue-500 to-cyan-500' },
        { id: 'orders', name: 'Orders', icon: ShoppingCart, color: 'from-orange-500 to-yellow-500' },
        { id: 'reports', name: 'Reports', icon: BarChart, color: 'from-green-500 to-emerald-500' },
        { id: 'settings', name: 'Settings', icon: Settings, color: 'from-gray-500 to-slate-500' },
      ]
    : [
        { id: 'dashboard', name: 'Dashboard', icon: TrendingUp, color: 'from-purple-500 to-pink-500' },
        { id: 'create-order', name: 'Create Order', icon: ShoppingCart, color: 'from-orange-500 to-yellow-500' },
        { id: 'my-orders', name: 'My Orders', icon: FileText, color: 'from-green-500 to-emerald-500' },
        { id: 'settings', name: 'Settings', icon: Settings, color: 'from-gray-500 to-slate-500' },
      ];

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 via-white to-pink-50 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-gray-600 font-medium">Loading Operix...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-white to-pink-50">
      {/* Sidebar */}
      <aside className={`fixed left-0 top-0 h-full bg-white shadow-2xl transition-all duration-300 z-40 ${sidebarOpen ? 'w-64' : 'w-20'}`}>
        <div className="p-6 flex items-center justify-between border-b border-gray-100">
          {sidebarOpen ? (
            <div className="flex items-center gap-3">
              <OperixLogo size="small" />
              <span className="font-bold text-xl bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Operix</span>
            </div>
          ) : (
            <div className="mx-auto">
              <OperixLogo size="small" />
            </div>
          )}
        </div>

        <nav className="p-4 space-y-2">
          {modules.map((module) => {
            const Icon = module.icon;
            return (
              <button
                key={module.id}
                onClick={() => setActiveModule(module.id)}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${
                  activeModule === module.id
                    ? `bg-gradient-to-r ${module.color} text-white shadow-lg transform scale-105`
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
              >
                <Icon />
                {sidebarOpen && <span className="font-medium">{module.name}</span>}
              </button>
            );
          })}
        </nav>

        <button
          onClick={() => setSidebarOpen(!sidebarOpen)}
          className="absolute -right-3 top-20 w-6 h-6 bg-white rounded-full shadow-lg flex items-center justify-center border border-gray-200 hover:scale-110 transition-transform"
        >
          {sidebarOpen ? <X /> : <Menu />}
        </button>
      </aside>
{/* Main Content */}
      <div className={`transition-all duration-300 ${sidebarOpen ? 'ml-64' : 'ml-20'}`}>
        {/* Header */}
        <header className="bg-white shadow-sm border-b border-gray-100 sticky top-0 z-30">
          <div className="px-8 py-4 flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-gray-800">
                {modules.find(m => m.id === activeModule)?.name || 'Dashboard'}
              </h1>
              <p className="text-sm text-gray-500 mt-1">
                Welcome back, {user?.displayName || 'User'} 
                <span className="ml-2 px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold">
                  {userRole === 'admin' ? 'Admin' : 'User'}
                </span>
              </p>
            </div>

            <div className="flex items-center gap-4">
              <div className="relative">
                <button 
                  onClick={() => setShowNotificationDropdown(!showNotificationDropdown)}
                  className="relative p-2 hover:bg-gray-100 rounded-lg transition-colors"
                >
                  <Bell />
                  {notifications.filter(n => !n.read).length > 0 && (
                    <span className="absolute top-1 right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs flex items-center justify-center font-bold">
                      {notifications.filter(n => !n.read).length}
                    </span>
                  )}
                </button>
                
                {showNotificationDropdown && (
                  <div className="absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-50 max-h-[500px] overflow-hidden">
                    <div className="p-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-purple-50 to-pink-50">
                      <h3 className="font-semibold text-gray-800">Notifications</h3>
                      {notifications.filter(n => !n.read).length > 0 && (
                        <button
                          onClick={markAllAsRead}
                          className="text-xs text-purple-600 hover:text-purple-800"
                        >
                          Mark all as read
                        </button>
                      )}
                    </div>
                    
                    <div className="overflow-y-auto max-h-[400px]">
                      {notifications.length > 0 ? (
                        notifications.map(notif => (
                          <div
  key={notif.id}
  onClick={(e) => {
    if (!notif.read) {
      markNotificationAsRead(notif.id);
    }
  }}
  className={`p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors ${
    !notif.read ? 'bg-purple-50' : ''
  }`}
>
                            <div className="flex items-start gap-3">
                              <div className={`w-2 h-2 rounded-full mt-2 ${!notif.read ? 'bg-purple-600' : 'bg-gray-300'}`}></div>
                              <div className="flex-1">
                                <div className="flex items-center justify-between mb-1">
                                  <span className={`text-xs px-2 py-1 rounded-full ${
                                    notif.type === 'order' ? 'bg-green-100 text-green-700' :
                                    notif.type === 'stock-alert' ? 'bg-red-100 text-red-700' :
                                    notif.type === 'product-edit' ? 'bg-blue-100 text-blue-700' :
                                    'bg-yellow-100 text-yellow-700'
                                  }`}>
                                    {notif.type === 'order' ? 'üõí Order' :
                                     notif.type === 'stock-alert' ? '‚ö†Ô∏è Stock Alert' :
                                     notif.type === 'product-edit' ? 'üì¶ Product' :
                                     'üîÑ Status Update'}
                                  </span>
                                  <span className="text-xs text-gray-500">{notif.timeAgo}</span>
                                </div>
                                <p className="text-sm font-medium text-gray-800 mb-1">{notif.message}</p>
                                {notif.details && (
                                  <div className="text-xs text-gray-600 space-y-1">
                                    {notif.details.orderNumber && <p>Order: {notif.details.orderNumber}</p>}
                                    {notif.details.customerName && <p>Customer: {notif.details.customerName}</p>}
                                    {notif.details.totalAmount && <p>Amount: ${notif.details.totalAmount.toFixed(2)}</p>}
                                    {notif.details.stock !== undefined && <p>Stock: {notif.details.stock} units</p>}
                                    {notif.details.productName && <p>Product: {notif.details.productName}</p>}
                                    {notif.details.changes && <p>Changes: {notif.details.changes}</p>}
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        ))
                      ) : (
                        <div className="p-8 text-center text-gray-500">
                          <Bell className="w-12 h-12 mx-auto mb-2 text-gray-300" />
                          <p>No notifications yet</p>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>

              <div className="relative">
                <button
                  onClick={() => setShowUserMenu(!showUserMenu)}
                  className="flex items-center gap-2 p-2 hover:bg-gray-100 rounded-lg transition-colors"
                >
                  <div className="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                    {user?.displayName?.charAt(0) || 'U'}
                  </div>
                  <ChevronDown />
                </button>

                {showUserMenu && (
                  <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-100 py-2">
                    <div className="px-4 py-2 border-b border-gray-100">
                      <p className="text-sm font-medium text-gray-700">{user?.displayName}</p>
                      <p className="text-xs text-gray-500">{user?.email}</p>
                    </div>
                    <button
                      onClick={handleLogout}
                      className="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-gray-700"
                    >
                      <LogOut /> Log Out
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        </header>

        {/* Main Content Area */}
        <main className="p-8">
          {/* Dashboard Module */}
          {activeModule === 'dashboard' && (
            <div className="space-y-6">
              {/* Stats Cards */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-gray-500 text-sm font-medium">Total Products</p>
                      <h2 className="text-3xl font-bold text-gray-800 mt-2">{stats.totalProducts}</h2>
                    </div>
                    <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                      <Package className="w-6 h-6 text-purple-600" />
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-gray-500 text-sm font-medium">Out of Stock</p>
                      <h2 className="text-3xl font-bold text-gray-800 mt-2">{stats.outOfStock}</h2>
                    </div>
                    <div className="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                      <XCircle className="w-6 h-6 text-red-600" />
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-gray-500 text-sm font-medium">Low Stock Items</p>
                      <h2 className="text-3xl font-bold text-gray-800 mt-2">{stats.lowStock}</h2>
                    </div>
                    <div className="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                      <AlertTriangle className="w-6 h-6 text-yellow-600" />
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-gray-500 text-sm font-medium">Pending Orders</p>
                      <h2 className="text-3xl font-bold text-gray-800 mt-2">{stats.pendingOrders}</h2>
                    </div>
                    <div className="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                      <ShoppingCart className="w-6 h-6 text-orange-600" />
                    </div>
                  </div>
                </div>
              </div>

              {/* Additional Stats Row */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-gray-500 text-sm font-medium">Today's Sales</p>
                      <h2 className="text-3xl font-bold text-gray-800 mt-2">${stats.todaySales.toFixed(2)}</h2>
                    </div>
                    <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                      <DollarSign className="w-6 h-6 text-green-600" />
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-gray-500 text-sm font-medium">Completed Orders</p>
                      <h2 className="text-3xl font-bold text-gray-800 mt-2">{stats.completedOrders}</h2>
                    </div>
                    <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                      <ShoppingCart className="w-6 h-6 text-blue-600" />
                    </div>
                  </div>
                </div>
              </div>

              {/* Recent Orders & Stock Alerts */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Recent Orders */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <ShoppingCart className="w-5 h-5 text-orange-500" />
                    Recent Orders
                  </h3>
                  <div className="space-y-3">
                    {recentOrders.length > 0 ? (
                      recentOrders.map(order => (
                        <div key={order.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div>
                            <p className="font-medium text-gray-800">{order.orderNumber}</p>
                            <p className="text-sm text-gray-500">{order.customerName}</p>
                          </div>
                          <div className="text-right">
                            <p className="font-semibold text-gray-800">${order.totalAmount.toFixed(2)}</p>
                            <span className={`text-xs px-2 py-1 rounded-full ${
                              order.status === 'completed' ? 'bg-green-100 text-green-700' :
                              order.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                              order.status === 'processing' ? 'bg-blue-100 text-blue-700' :
                              'bg-gray-100 text-gray-700'
                            }`}>
                              {order.status}
                            </span>
                          </div>
                        </div>
                      ))
                    ) : (
                      <p className="text-gray-500 text-center py-4">No recent orders</p>
                    )}
                  </div>
                </div>

                {/* Stock Alerts */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <AlertTriangle className="w-5 h-5 text-yellow-500" />
                    Stock Alerts
                  </h3>
                  <div className="space-y-3 max-h-96 overflow-y-auto">
                    {/* Out of Stock Items */}
                    {outOfStockItems.length > 0 && (
                      <div>
                        <p className="text-xs font-semibold text-red-600 mb-2">OUT OF STOCK</p>
                        {outOfStockItems.map(item => (
                          <div key={item.id} className="flex items-center justify-between p-3 bg-red-50 rounded-lg border-l-4 border-red-500 mb-2">
                            <div>
                              <p className="font-medium text-gray-800">{item.name}</p>
                              <p className="text-sm text-gray-500">{item.sku}</p>
                            </div>
                            <div className="text-right">
                              <p className="font-semibold text-red-700 flex items-center gap-1">
                                <XCircle className="w-4 h-4" />
                                0 {item.unit}
                              </p>
                              <p className="text-xs text-gray-500">Restock needed!</p>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                    
                    {/* Low Stock Items */}
                    {lowStockItems.length > 0 && (
                      <div>
                        <p className="text-xs font-semibold text-yellow-600 mb-2 mt-4">LOW STOCK</p>
                        {lowStockItems.map(item => (
                          <div key={item.id} className="flex items-center justify-between p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-500 mb-2">
                            <div>
                              <p className="font-medium text-gray-800">{item.name}</p>
                              <p className="text-sm text-gray-500">{item.sku}</p>
                            </div>
                            <div className="text-right">
                              <p className="font-semibold text-yellow-700">{item.stock} {item.unit}</p>
                              <p className="text-xs text-gray-500">Threshold: {item.threshold}</p>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                    
                    {outOfStockItems.length === 0 && lowStockItems.length === 0 && (
                      <p className="text-gray-500 text-center py-4">All stock levels are good!</p>
                    )}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Inventory Module (Admin Only) */}
          {activeModule === 'inventory' && userRole === 'admin' && (
            <div className="space-y-6">
              {/* Controls */}
              <div className="bg-white rounded-xl shadow-lg p-6">
                <div className="flex flex-col gap-4">
                  {/* Search and Filters */}
                  <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div className="flex-1 flex gap-4">
                      <input
                        type="text"
                        placeholder="Search products..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                      />
                      <select
                        value={categoryFilter}
                        onChange={(e) => setCategoryFilter(e.target.value)}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                      >
                        <option value="all">All Categories</option>
                        {categories.map(cat => (
                          <option key={cat} value={cat}>{cat}</option>
                        ))}
                      </select>
                    </div>
                    <button
                      onClick={() => { setShowAddProduct(true); resetProductForm(); setEditingProduct(null); }}
                      className="flex items-center gap-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all"
                    >
                      <Plus /> Add Product
                    </button>
                  </div>

                  {/* Stock Filter Tabs */}
                  <div className="flex gap-2 border-b border-gray-200">
                    <button
                      onClick={() => setStockFilter('all')}
                      className={`px-4 py-2 font-medium transition-all ${
                        stockFilter === 'all'
                          ? 'text-purple-600 border-b-2 border-purple-600'
                          : 'text-gray-500 hover:text-gray-700'
                      }`}
                    >
                      All Products ({products.length})
                    </button>
                    <button
                      onClick={() => setStockFilter('in-stock')}
                      className={`px-4 py-2 font-medium transition-all ${
                        stockFilter === 'in-stock'
                          ? 'text-green-600 border-b-2 border-green-600'
                          : 'text-gray-500 hover:text-gray-700'
                      }`}
                    >
                      In Stock ({products.filter(p => p.stock > p.threshold).length})
                    </button>
                    <button
                      onClick={() => setStockFilter('low-stock')}
                      className={`px-4 py-2 font-medium transition-all ${
                        stockFilter === 'low-stock'
                          ? 'text-yellow-600 border-b-2 border-yellow-600'
                          : 'text-gray-500 hover:text-gray-700'
                      }`}
                    >
                      Low Stock ({stats.lowStock})
                    </button>
                    <button
                      onClick={() => setStockFilter('out-of-stock')}
                      className={`px-4 py-2 font-medium transition-all ${
                        stockFilter === 'out-of-stock'
                          ? 'text-red-600 border-b-2 border-red-600'
                          : 'text-gray-500 hover:text-gray-700'
                      }`}
                    >
                      Out of Stock ({stats.outOfStock})
                    </button>
                  </div>
                </div>
              </div>

              {/* Products Grid */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {filteredProducts.map(product => {
                  const isOutOfStock = product.stock === 0;
                  const isLowStock = product.stock > 0 && product.stock <= product.threshold;
                  
                  return (
                    <div 
                      key={product.id} 
                      className={`bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow ${
                        isOutOfStock ? 'opacity-75 border-2 border-red-300' : ''
                      }`}
                    >
                      {/* Product Image */}
                      <div className="h-48 bg-gray-100 relative overflow-hidden">
                        {product.imageUrl ? (
                          <img src={product.imageUrl} alt={product.name} className={`w-full h-full object-cover ${isOutOfStock ? 'grayscale' : ''}`} />
                        ) : (
                          <div className={`w-full h-full flex items-center justify-center ${
                            isOutOfStock 
                              ? 'bg-gradient-to-br from-red-100 to-red-200' 
                              : isLowStock 
                                ? 'bg-gradient-to-br from-yellow-100 to-yellow-200'
                                : 'bg-gradient-to-br from-purple-100 to-pink-100'
                          }`}>
                            {isOutOfStock ? (
                              <XCircle className="w-16 h-16 text-red-400" />
                            ) : (
                              <Package className="w-16 h-16 text-gray-400" />
                            )}
                          </div>
                        )}
                        
                        {/* Stock Badge */}
                        {isOutOfStock ? (
                          <div className="absolute top-2 right-2 bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 out-of-stock-badge">
                            <XCircle className="w-3 h-3" />
                            OUT OF STOCK
                          </div>
                        ) : isLowStock ? (
                          <div className="absolute top-2 right-2 bg-yellow-500 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                            <AlertTriangle className="w-3 h-3" />
                            LOW STOCK
                          </div>
                        ) : null}
                      </div>

                      {/* Product Info */}
                      <div className="p-4">
                        <h3 className="font-semibold text-lg text-gray-800 mb-1">{product.name}</h3>
                        <p className="text-sm text-gray-500 mb-2">{product.sku}</p>
                        
                        <div className="flex items-center justify-between mb-3">
                          <span className="text-2xl font-bold text-purple-600">${product.price.toFixed(2)}</span>
                          <span className={`text-sm font-semibold ${
                            isOutOfStock ? 'text-red-600' : isLowStock ? 'text-yellow-600' : 'text-green-600'
                          }`}>
                            {product.stock} {product.unit}
                          </span>
                        </div>

                        {product.category && (
                          <span className="inline-block px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs mb-3">
                            {product.category}
                          </span>
                        )}

                        {product.supplier && (
                          <p className="text-xs text-gray-500 mb-3">Supplier: {product.supplier}</p>
                        )}

                        {/* Out of Stock Warning */}
                        {isOutOfStock && (
                          <div className="mb-3 p-2 bg-red-50 border border-red-200 rounded-lg">
                            <p className="text-xs text-red-700 font-medium flex items-center gap-1">
                              <XCircle className="w-3 h-3" />
                              Restock immediately!
                            </p>
                          </div>
                        )}

                        {/* Actions */}
                        <div className="flex gap-2 pt-3 border-t border-gray-100">
                          <button
                            onClick={() => {
                              setEditingProduct(product);
                              setShowAddProduct(true);
                              setProductForm(product);
                            }}
                            className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors"
                          >
                            <Edit /> Edit
                          </button>
                          <button
                            onClick={() => deleteProduct(product.id)}
                            className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors"
                          >
                            <Trash /> Delete
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>

              {filteredProducts.length === 0 && (
                <div className="text-center py-12">
                  <Package className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                  <p className="text-gray-500">No products found</p>
                </div>
              )}
            </div>
          )}

          {/* Orders Module (Admin) */}
{activeModule === 'orders' && userRole === 'admin' && (
            <div className="space-y-6">
              <div className="flex justify-between items-center">
                <h2 className="text-xl font-semibold">All Orders</h2>
                <button
                  onClick={() => setShowCreateOrder(true)}
                  className="flex items-center gap-2 bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all"
                >
                  <Plus /> New Order
                </button>
              </div>

              <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order #</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {orders.map(order => (
                        <tr key={order.id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900">{order.orderNumber}</td>
                          <td className="px-6 py-4">
                            <div className="text-sm">
                              <div className="font-medium text-gray-900">{order.customerName}</div>
                              <div className="text-gray-500">{order.customerEmail}</div>
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {order.items?.length || 0} items
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                            ${order.totalAmount.toFixed(2)}
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                              order.status === 'completed' ? 'bg-green-100 text-green-800' :
                              order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                              order.status === 'processing' ? 'bg-blue-100 text-blue-800' :
                              'bg-red-100 text-red-800'
                            }`}>
                              {order.status}
                            </span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm">
                            <div className="flex gap-2">
                              {order.status === 'pending' && (
                                <button
                                  onClick={() => updateOrderStatus(order.id, 'processing')}
                                  className="text-blue-600 hover:text-blue-900"
                                >
                                  Process
                                </button>
                              )}
                              {(order.status === 'pending' || order.status === 'processing') && (
                                <button
                                  onClick={() => updateOrderStatus(order.id, 'completed')}
                                  className="text-green-600 hover:text-green-900"
                                >
                                  Complete
                                </button>
                              )}
                              {order.status !== 'cancelled' && (
                                <button
                                  onClick={() => {
                                    if (confirm('Are you sure you want to cancel this order? Stock will be returned.')) {
                                      updateOrderStatus(order.id, 'cancelled');
                                    }
                                  }}
                                  className="text-red-600 hover:text-red-900"
                                >
                                  Cancel
                                </button>
                              )}
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                {orders.length === 0 && (
                  <div className="text-center py-12">
                    <ShoppingCart className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                    <p className="text-gray-500">No orders yet</p>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Create Order Module (Regular Users) */}
          {(activeModule === 'create-order' || (activeModule === 'orders' && userRole !== 'admin')) && (
            <div className="space-y-6">
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-xl font-semibold mb-4">Create New Order</h2>
                
                {/* Search Products */}
                <div className="mb-6">
                  <input
                    type="text"
                    placeholder="Search products to add..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                  />
                </div>

                {/* Available Products */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                  {products
                    .filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()) && p.stock > 0)
                    .map(product => (
                      <div key={product.id} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div className="flex items-start gap-3">
                          {product.imageUrl ? (
                            <img src={product.imageUrl} alt={product.name} className="w-16 h-16 object-cover rounded-lg" />
                          ) : (
                            <div className="w-16 h-16 bg-gradient-to-br from-purple-100 to-pink-100 rounded-lg flex items-center justify-center">
                              <Package className="w-8 h-8 text-gray-400" />
                            </div>
                          )}
                          <div className="flex-1">
                            <h3 className="font-medium text-gray-800">{product.name}</h3>
                            <p className="text-sm text-gray-500">{product.sku}</p>
                            <p className="text-lg font-semibold text-purple-600 mt-1">${product.price.toFixed(2)}</p>
                            <p className="text-xs text-gray-500">Stock: {product.stock} {product.unit}</p>
                            <button
                              onClick={() => addToCart(product)}
                              disabled={product.stock === 0}
                              className="mt-2 w-full px-3 py-1 bg-purple-500 text-white rounded-lg hover:bg-purple-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm"
                            >
                              Add to Cart
                            </button>
                          </div>
                        </div>
                      </div>
                    ))}
                </div>

                {/* Cart */}
                {cart.length > 0 && (
                  <div className="border-t border-gray-200 pt-6">
                    <h3 className="text-lg font-semibold mb-4">Cart ({cart.length} items)</h3>
                    <div className="space-y-3 mb-4">
                      {cart.map(item => (
                        <div key={item.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div className="flex-1">
                            <p className="font-medium text-gray-800">{item.name}</p>
                            <p className="text-sm text-gray-500">${item.price.toFixed(2)} per {item.unit}</p>
                          </div>
                          <div className="flex items-center gap-3">
                            <input
                              type="number"
                              min="1"
                              max={item.stock}
                              value={item.quantity}
                              onChange={(e) => updateCartQuantity(item.id, parseInt(e.target.value) || 1)}
                              className="w-20 px-2 py-1 border border-gray-300 rounded-lg text-center"
                            />
                            <span className="font-semibold text-gray-800 w-24 text-right">
                              ${(item.price * item.quantity).toFixed(2)}
                            </span>
                            <button
                              onClick={() => removeFromCart(item.id)}
                              className="text-red-500 hover:text-red-700"
                            >
                              <Trash />
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                    
                    <div className="flex justify-between items-center text-xl font-bold text-gray-800 mb-6 p-4 bg-purple-50 rounded-lg">
                      <span>Total:</span>
                      <span>${calculateTotal().toFixed(2)}</span>
                    </div>

                    {/* Customer Details */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <input
                        type="text"
                        placeholder="Customer Name *"
                        value={orderForm.customerName}
                        onChange={(e) => setOrderForm({...orderForm, customerName: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                      />
                      <input
                        type="email"
                        placeholder="Customer Email *"
                        value={orderForm.customerEmail}
                        onChange={(e) => setOrderForm({...orderForm, customerEmail: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                      />
                      <input
                        type="tel"
                        placeholder="Customer Phone"
                        value={orderForm.customerPhone}
                        onChange={(e) => setOrderForm({...orderForm, customerPhone: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                      />
                      <select
                        value={orderForm.paymentMethod}
                        onChange={(e) => setOrderForm({...orderForm, paymentMethod: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                      >
                        <option value="Cash">Cash</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                      </select>
                    </div>
                    <input
                      type="text"
                      placeholder="Delivery Address *"
                      value={orderForm.deliveryAddress}
                      onChange={(e) => setOrderForm({...orderForm, deliveryAddress: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none mb-4"
                    />
                    <textarea
                      placeholder="Notes / Special Instructions"
                      value={orderForm.notes}
                      onChange={(e) => setOrderForm({...orderForm, notes: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none mb-4"
                      rows="3"
                    />
                    <button
                      onClick={submitOrder}
                      className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all font-semibold"
                    >
                      Submit Order
                    </button>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* My Orders Module (Regular Users) */}
          {activeModule === 'my-orders' && (
            <div className="space-y-6">
              <h2 className="text-xl font-semibold">My Orders</h2>
              
              <div className="grid grid-cols-1 gap-4">
                {orders.map(order => (
                  <div key={order.id} className="bg-white rounded-xl shadow-lg p-6">
                    <div className="flex items-center justify-between mb-4">
                      <div>
                        <h3 className="text-lg font-semibold text-gray-800">{order.orderNumber}</h3>
                        <p className="text-sm text-gray-500">
                          {order.createdAt?.toDate().toLocaleDateString()}
                        </p>
                      </div>
                      <span className={`px-4 py-2 rounded-full text-sm font-semibold ${
                        order.status === 'completed' ? 'bg-green-100 text-green-800' :
                        order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                        order.status === 'processing' ? 'bg-blue-100 text-blue-800' :
                        'bg-red-100 text-red-800'
                      }`}>
                        {order.status}
                      </span>
                    </div>

                    <div className="border-t border-gray-200 pt-4">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                          <p className="text-sm text-gray-500">Customer</p>
                          <p className="font-medium text-gray-800">{order.customerName}</p>
                          <p className="text-sm text-gray-600">{order.customerEmail}</p>
                        </div>
                        <div>
                          <p className="text-sm text-gray-500">Delivery Address</p>
                          <p className="font-medium text-gray-800">{order.deliveryAddress}</p>
                        </div>
                      </div>

                      <div className="mb-4">
                        <p className="text-sm text-gray-500 mb-2">Items</p>
                        <div className="space-y-2">
                          {order.items?.map((item, idx) => (
                            <div key={idx} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                              <span className="text-sm text-gray-800">{item.name} x{item.quantity}</span>
                              <span className="text-sm font-medium text-gray-900">${item.subtotal.toFixed(2)}</span>
                            </div>
                          ))}
                        </div>
                      </div>

                      <div className="flex items-center justify-between pt-4 border-t border-gray-200">
                        <span className="text-sm text-gray-500">Payment Method</span>
                        <span className="font-medium text-gray-800">{order.paymentMethod}</span>
                      </div>

                      <div className="flex items-center justify-between pt-2">
                        <span className="text-lg font-semibold text-gray-800">Total</span>
                        <span className="text-2xl font-bold text-purple-600">${order.totalAmount.toFixed(2)}</span>
                      </div>

                      {order.notes && (
                        <div className="mt-4 p-3 bg-blue-50 rounded-lg">
                          <p className="text-sm text-gray-500 mb-1">Notes</p>
                          <p className="text-sm text-gray-700">{order.notes}</p>
                        </div>
                      )}
                    </div>
                  </div>
                ))}

                {orders.length === 0 && (
                  <div className="text-center py-12 bg-white rounded-xl shadow-lg">
                    <ShoppingCart className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                    <p className="text-gray-500">You haven't placed any orders yet</p>
                    <button
                      onClick={() => setActiveModule('create-order')}
                      className="mt-4 px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600"
                    >
                      Create Your First Order
                    </button>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Reports Module (Admin Only) */}
          {activeModule === 'reports' && userRole === 'admin' && (
            <div className="space-y-6">
              <h2 className="text-xl font-semibold">Reports & Analytics</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-lg font-semibold mb-4">Sales Summary</h3>
                  <div className="space-y-3">
                    <div className="flex justify-between">
                      <span className="text-gray-600">Total Orders</span>
                      <span className="font-semibold">{stats.totalOrders}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Completed</span>
                      <span className="font-semibold text-green-600">{stats.completedOrders}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Pending</span>
                      <span className="font-semibold text-yellow-600">{stats.pendingOrders}</span>
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-lg font-semibold mb-4">Inventory Summary</h3>
                  <div className="space-y-3">
                    <div className="flex justify-between">
                      <span className="text-gray-600">Total Products</span>
                      <span className="font-semibold">{stats.totalProducts}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Out of Stock</span>
                      <span className="font-semibold text-red-600">{stats.outOfStock}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Low Stock</span>
                      <span className="font-semibold text-yellow-600">{stats.lowStock}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Categories</span>
                      <span className="font-semibold">{categories.length}</span>
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-lg font-semibold mb-4">Revenue</h3>
                  <div className="space-y-3">
                    <div className="flex justify-between">
                      <span className="text-gray-600">Today</span>
                      <span className="font-semibold text-green-600">${stats.todaySales.toFixed(2)}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Total</span>
                      <span className="font-semibold">
                        ${orders
                          .filter(o => o.status !== 'cancelled')
                          .reduce((sum, o) => sum + o.totalAmount, 0)
                          .toFixed(2)}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              {/* Admin Activity Logs */}
              <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 className="text-lg font-semibold mb-4">Recent Admin Activity</h3>
                <div className="space-y-3 max-h-96 overflow-y-auto">
                  {notifications
                    .filter(n => n.type === 'product-edit' || n.type === 'order-status')
                    .slice(0, 10)
                    .map(log => (
                      <div key={log.id} className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                        <div className="w-2 h-2 bg-blue-600 rounded-full mt-2"></div>
                        <div className="flex-1">
                          <p className="text-sm font-medium text-gray-800">{log.message}</p>
                          {log.details && (
                            <div className="text-xs text-gray-600 mt-1">
                              {log.details.productName && <p>Product: {log.details.productName}</p>}
                              {log.details.sku && <p>SKU: {log.details.sku}</p>}
                              {log.details.action && <p>Action: {log.details.action}</p>}
                              {log.details.changes && <p>{log.details.changes}</p>}
                              {log.details.orderNumber && <p>Order: {log.details.orderNumber}</p>}
                              {log.details.oldStatus && <p>Changed from: {log.details.oldStatus} ‚Üí {log.details.newStatus}</p>}
                            </div>
                          )}
                          <p className="text-xs text-gray-500 mt-1">{log.timeAgo}</p>
                        </div>
                      </div>
                    ))}
                    {notifications.filter(n => n.type === 'product-edit' || n.type === 'order-status').length === 0 && (
                      <p className="text-center text-gray-500 py-4">No activity logs yet</p>
                    )}
                </div>
              </div>

              <div className="bg-white rounded-xl shadow-lg p-6">
                <h3 className="text-lg font-semibold mb-4">Export Data</h3>
                <h3 className="text-lg font-semibold mb-4">Export Data</h3>
                <div className="flex gap-4">
                  <button className="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                    Export Products (CSV)
                  </button>
                  <button className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    Export Orders (CSV)
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Settings Module */}
          {activeModule === 'settings' && (
            <div className="space-y-6">
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-xl font-semibold mb-4">Account Settings</h2>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input
                      type="text"
                      value={user?.displayName || ''}
                      readOnly
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input
                      type="email"
                      value={user?.email || ''}
                      readOnly
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <input
                      type="text"
                      value={userRole === 'admin' ? 'Administrator' : 'Regular User'}
                      readOnly
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50"
                    />
                  </div>
                  {user?.companyName && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Company</label>
                      <input
                        type="text"
                        value={user.companyName}
                        readOnly
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50"
                      />
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}
        </main>
      </div>

      {/* Add/Edit Product Modal */}
{showAddProduct && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
          <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl my-8">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold">{editingProduct ? 'Edit Product' : 'Add New Product'}</h2>
              <button
                onClick={() => {
                  setShowAddProduct(false);
                  setEditingProduct(null);
                  resetProductForm();
                }}
                className="text-gray-400 hover:text-gray-600"
              >
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Product Name *</label>
                <input
                  type="text"
                  placeholder="Enter product name"
                  value={productForm.name}
                  onChange={(e) => setProductForm({...productForm, name: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">SKU *</label>
                <input
                  type="text"
                  placeholder="Enter SKU"
                  value={productForm.sku}
                  onChange={(e) => setProductForm({...productForm, sku: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <input
                  type="text"
                  placeholder="Enter category"
                  value={productForm.category}
                  onChange={(e) => setProductForm({...productForm, category: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Price *</label>
                <input
                  type="number"
                  step="0.01"
                  placeholder="0.00"
                  value={productForm.price}
                  onChange={(e) => setProductForm({...productForm, price: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Stock Quantity *</label>
                <input
                  type="number"
                  placeholder="0"
                  value={productForm.stock}
                  onChange={(e) => setProductForm({...productForm, stock: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Low Stock Threshold</label>
                <input
                  type="number"
                  placeholder="10"
                  value={productForm.threshold}
                  onChange={(e) => setProductForm({...productForm, threshold: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Unit of Measurement</label>
                <select
                  value={productForm.unit}
                  onChange={(e) => setProductForm({...productForm, unit: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                >
                  <option value="pieces">Pieces</option>
                  <option value="kg">Kilograms (kg)</option>
                  <option value="liters">Liters</option>
                  <option value="boxes">Boxes</option>
                  <option value="packs">Packs</option>
                  <option value="meters">Meters</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Supplier Name</label>
                <input
                  type="text"
                  placeholder="Enter supplier name"
                  value={productForm.supplier}
                  onChange={(e) => setProductForm({...productForm, supplier: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                />
              </div>
            </div>

            <div className="mt-4">
              <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
              <textarea
                placeholder="Enter product description"
                value={productForm.description}
                onChange={(e) => setProductForm({...productForm, description: e.target.value})}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                rows="3"
              />
            </div>

            <div className="mt-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">Product Image</label>
              <div className="flex items-center gap-4">
                <input
                  type="file"
                  id="productImage"
                  accept="image/*"
                  style={{ display: 'none' }}
                  onChange={(e) => {
                    const file = e.target.files[0];
                    if (file) uploadToCloudinary(file);
                  }}
                />

                <button
                  onClick={() => document.getElementById('productImage').click()}
                  disabled={uploadingImage}
                  className={`flex items-center gap-2 px-4 py-2 rounded-lg text-white transition-all ${
                    uploadingImage ? 'bg-gray-400 cursor-not-allowed' : 'bg-purple-500 hover:bg-purple-600'
                  }`}
                >
                  <Image />
                  {uploadingImage ? 'Uploading...' : 'Upload Image'}
                </button>

                {productForm.imageUrl && (
                  <div className="relative">
                    <img 
                      src={productForm.imageUrl} 
                      alt="Preview" 
                      className="w-20 h-20 object-cover rounded-lg border-2 border-purple-200"
                    />
                    <button
                      onClick={() => setProductForm({...productForm, imageUrl: ''})}
                      className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600"
                    >
                      <X />
                    </button>
                  </div>
                )}
              </div>
            </div>

            <div className="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
              <button
                onClick={() => {
                  setShowAddProduct(false);
                  setEditingProduct(null);
                  resetProductForm();
                }}
                className="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={saveProduct}
                className="px-6 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:shadow-lg transition-all"
              >
                {editingProduct ? 'Update Product' : 'Add Product'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Create Order Modal */}
      {showCreateOrder && userRole === 'admin' && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
          <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl my-8 max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6 sticky top-0 bg-white pb-4 border-b">
              <h2 className="text-2xl font-bold">Create New Order</h2>
              <button
                onClick={() => {
                  setShowCreateOrder(false);
                  setCart([]);
                  setOrderForm({
                    customerName: '', 
                    customerEmail: '', 
                    customerPhone: '',
                    deliveryAddress: '', 
                    paymentMethod: 'Cash', 
                    notes: ''
                  });
                }}
                className="text-gray-400 hover:text-gray-600"
              >
                <X className="w-6 h-6" />
              </button>
            </div>
            
            {/* Product Selection */}
            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">Add Products to Order</label>
              <input
                type="text"
                placeholder="Search products..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none mb-4"
              />
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-64 overflow-y-auto p-2 border border-gray-200 rounded-lg">
                {products
                  .filter(p => p.stock > 0 && p.name.toLowerCase().includes(searchQuery.toLowerCase()))
                  .map(product => (
                    <div key={product.id} className="border border-gray-200 rounded-lg p-3 hover:shadow-md transition-shadow">
                      <div className="flex items-center gap-3">
                        {product.imageUrl ? (
                          <img src={product.imageUrl} alt={product.name} className="w-12 h-12 object-cover rounded" />
                        ) : (
                          <div className="w-12 h-12 bg-purple-100 rounded flex items-center justify-center">
                            <Package className="w-6 h-6 text-purple-600" />
                          </div>
                        )}
                        <div className="flex-1">
                          <p className="font-medium text-sm">{product.name}</p>
                          <p className="text-xs text-gray-500">${product.price.toFixed(2)} | Stock: {product.stock}</p>
                        </div>
                        <button
                          onClick={() => addToCart(product)}
                          className="px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm"
                        >
                          Add
                        </button>
                      </div>
                    </div>
                  ))}
              </div>
            </div>

            {/* Cart */}
            {cart.length > 0 && (
              <div className="mb-6 border-t border-gray-200 pt-6">
                <h3 className="font-semibold mb-3">Order Items ({cart.length})</h3>
                <div className="space-y-2 mb-4">
                  {cart.map(item => (
                    <div key={item.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <div className="flex-1">
                        <p className="font-medium">{item.name}</p>
                        <p className="text-sm text-gray-500">${item.price.toFixed(2)} per {item.unit}</p>
                      </div>
                      <div className="flex items-center gap-3">
                        <input
                          type="number"
                          min="1"
                          max={item.stock}
                          value={item.quantity}
                          onChange={(e) => updateCartQuantity(item.id, parseInt(e.target.value) || 1)}
                          className="w-20 px-2 py-1 border border-gray-300 rounded text-center"
                        />
                        <span className="font-semibold w-24 text-right">${(item.price * item.quantity).toFixed(2)}</span>
                        <button
                          onClick={() => removeFromCart(item.id)}
                          className="text-red-500 hover:text-red-700"
                        >
                          <Trash />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="flex justify-between items-center text-xl font-bold p-4 bg-purple-50 rounded-lg">
                  <span>Total:</span>
                  <span>${calculateTotal().toFixed(2)}</span>
                </div>
              </div>
            )}

            {/* Customer Details */}
            {cart.length > 0 && (
              <div>
                <h3 className="font-semibold mb-3">Customer Details</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <input
                    type="text"
                    placeholder="Customer Name *"
                    value={orderForm.customerName}
                    onChange={(e) => setOrderForm({...orderForm, customerName: e.target.value})}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                  />
                  <input
                    type="email"
                    placeholder="Customer Email *"
                    value={orderForm.customerEmail}
                    onChange={(e) => setOrderForm({...orderForm, customerEmail: e.target.value})}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                  />
                  <input
                    type="tel"
                    placeholder="Customer Phone"
                    value={orderForm.customerPhone}
                    onChange={(e) => setOrderForm({...orderForm, customerPhone: e.target.value})}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                  />
                  <select
                    value={orderForm.paymentMethod}
                    onChange={(e) => setOrderForm({...orderForm, paymentMethod: e.target.value})}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                  >
                    <option value="Cash">Cash</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Debit Card">Debit Card</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                  </select>
                </div>
                <input
                  type="text"
                  placeholder="Delivery Address *"
                  value={orderForm.deliveryAddress}
                  onChange={(e) => setOrderForm({...orderForm, deliveryAddress: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none mb-4"
                />
                <textarea
                  placeholder="Notes / Special Instructions"
                  value={orderForm.notes}
                  onChange={(e) => setOrderForm({...orderForm, notes: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none mb-4"
                  rows="3"
                />

                <div className="flex justify-end gap-3 pt-6 border-t border-gray-200">
                  <button
                    onClick={() => {
                      setShowCreateOrder(false);
                      setCart([]);
                      setOrderForm({
                        customerName: '', 
                        customerEmail: '', 
                        customerPhone: '',
                        deliveryAddress: '', 
                        paymentMethod: 'Cash', 
                        notes: ''
                      });
                    }}
                    className="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors"
                  >
                    Cancel
                  </button>
                  <button
  onClick={submitOrder}
  disabled={cart.length === 0 || submittingOrder}
  className="px-6 py-2 rounded-lg bg-gradient-to-r from-orange-500 to-yellow-500 text-white hover:shadow-lg transition-all disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2"
>
  {submittingOrder ? (
    <>
      <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
      Processing...
    </>
  ) : (
    'Submit Order'
  )}
</button>
                </div>
              </div>
            )}

            {cart.length === 0 && (
              <div className="text-center py-8">
                <ShoppingCart className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                <p className="text-gray-500">Add products to create an order</p>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.render(<Dashboard />, document.getElementById('root'));

</script>
</body>
</html>