<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Operix - Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  /* Out of Stock Animation */
  @keyframes pulse-red {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .out-of-stock-badge {
    animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  /* Smooth Scroll */
  html {
    scroll-behavior: smooth;
  }

  /* Fade In Animation for Reports */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .animate-fadeIn {
    animation: fadeIn 0.5s ease-out;
  }

</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

// Lucide Icons as SVG components
const Package = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
  </svg>
);

const ShoppingCart = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
  </svg>
);

const FileText = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
  </svg>
);

const Settings = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
  </svg>
);

const TrendingUp = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
  </svg>
);

const AlertTriangle = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
  </svg>
);

const DollarSign = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
);

const Bell = () => (
  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
  </svg>
);

const Search = () => (
  <svg className="w-4 h-4 absolute left-3 top-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
  </svg>
);

const Menu = () => (
  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
  </svg>
);

const X = () => (
  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
  </svg>
);

const ChevronDown = () => (
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
  </svg>
);

const LogOut = () => (
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
  </svg>
);

const Plus = () => (
  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
  </svg>
);

const Edit = () => (
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
  </svg>
);

const Trash = () => (
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
  </svg>
);

const Users = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
  </svg>
);

const BarChart = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
  </svg>
);

const Image = () => (
  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
  </svg>
);

const XCircle = () => (
  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
);

// Operix Logo Component (same as login page)
const OperixLogo = ({ size = 'default' }) => {
  const dimensions = size === 'small' ? { w: 40, h: 40, iconW: 6, iconH: 6, rectW: 4, rectH: 4 } 
                    : { w: 60, h: 60, iconW: 6, iconH: 6, rectW: 4, rectH: 4 };
  
  return (
    <svg width={dimensions.w} height={dimensions.h} viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" rx="8" fill="#050C9C"/>
      <path d="M20 10 C25 10 28 13 28 18 C28 23 25 26 20 26 C15 26 12 23 12 18 C12 13 15 10 20 10 Z M20 14 C17 14 16 15.5 16 18 C16 20.5 17 22 20 22 C23 22 24 20.5 24 18 C24 15.5 23 14 20 14 Z" fill="white"/>
      <rect x="18" y="26" width="4" height="4" fill="white"/>
    </svg>
  );
};



// Cancellation Requests Component
function CancellationRequestsList() {
  const [requests, setRequests] = React.useState([]);
  
  React.useEffect(() => {
    const loadRequests = async () => {
      try {
        const db = firebase.firestore();
        const snapshot = await db.collection('cancellationRequests')
          .where('status', '==', 'pending')
          .orderBy('requestedAt', 'desc')
          .get();
        
        const requestsData = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        setRequests(requestsData);
      } catch (error) {
        console.error('Error loading cancellation requests:', error);
      }
    };
    
    loadRequests();
  }, []);
  
const handleApprove = async (requestId, orderId) => {
    if (!confirm('Approve this cancellation request? Order will be cancelled and stock will be returned.')) {
      return;
    }
    
    try {
      const db = firebase.firestore();
      
      // Get cancellation request and order details
      const cancelReqDoc = await db.collection('cancellationRequests').doc(requestId).get();
      const cancelReq = cancelReqDoc.data();
      
      // Update cancellation request status
      await db.collection('cancellationRequests').doc(requestId).update({
        status: 'approved',
        approvedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Get order details to return stock
      const orderDoc = await db.collection('orders').doc(orderId).get();
      const order = orderDoc.data();
      
      // Return stock
      const batch = db.batch();
      order.items.forEach(item => {
        const productRef = db.collection('products').doc(item.productId);
        batch.update(productRef, {
          stock: firebase.firestore.FieldValue.increment(item.quantity)
        });
      });
      
      // Update order status - REMOVE cancellation flags
      const orderRef = db.collection('orders').doc(orderId);
      batch.update(orderRef, {
        status: 'cancelled',
        cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
        cancellationApproved: true,
        cancellationRequested: false, // Clear the flag
        cancellationRejected: false
      });
      
      await batch.commit();
      
// Send notifications
try {
  // Notification for CUSTOMER
  await db.collection('notifications').add({
    type: 'cancellation-approved',
    message: `Your cancellation request for order ${order.orderNumber} has been approved`,
    details: {
      orderNumber: order.orderNumber,
      status: 'approved',
      refundNote: 'Stock has been returned. Your order is now cancelled.'
    },
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    read: false,
    userId: cancelReq.customerId,
    userRole: 'user'
  });
  
  // Notification for ALL ADMINS
  const adminsSnapshot = await db.collection('users')
    .where('role', '==', 'admin')
    .get();
  
  for (const adminDoc of adminsSnapshot.docs) {
    await db.collection('notifications').add({
      type: 'cancellation-approved',
      message: `Cancellation approved for order ${order.orderNumber} from ${cancelReq.customerName}`,
      details: {
        orderNumber: order.orderNumber,
        customerName: cancelReq.customerName,
        status: 'approved',
        action: 'Stock returned, order cancelled'
      },
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false,
      userId: adminDoc.id,
      userRole: 'admin'
    });
  }
  
  console.log('âœ… Approval notifications sent to customer and admins');
} catch (notifError) {
  console.error('âš ï¸ Failed to send notification (non-critical):', notifError);
}
      
      // Reload requests
      const snapshot = await db.collection('cancellationRequests')
        .where('status', '==', 'pending')
        .orderBy('requestedAt', 'desc')
        .get();
      
      setRequests(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
      
      alert('Cancellation approved. Order has been cancelled and stock returned.');
    } catch (error) {
      console.error('Error approving cancellation:', error);
      alert('Error approving cancellation. Please try again.');
    }
  };
  
const handleReject = async (requestId) => {
    const reason = prompt('Enter reason for rejection (optional):');
    
    try {
      const db = firebase.firestore();
      
      // Get cancellation request details
      const cancelReqDoc = await db.collection('cancellationRequests').doc(requestId).get();
      const cancelReq = cancelReqDoc.data();
      
      // Update cancellation request
      await db.collection('cancellationRequests').doc(requestId).update({
        status: 'rejected',
        rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
        rejectionReason: reason || 'No reason provided'
      });
      
      // Update order to remove cancellation flags
      await db.collection('orders').doc(cancelReq.orderId).update({
        cancellationRequested: false,
        cancellationRejected: true,
        rejectionReason: reason || 'No reason provided'
      });
      
// Send notifications
try {
  // Notification for CUSTOMER
  await db.collection('notifications').add({
    type: 'cancellation-rejected',
    message: `Your cancellation request for order ${cancelReq.orderNumber} has been rejected`,
    details: {
      orderNumber: cancelReq.orderNumber,
      status: 'rejected',
      reason: reason || 'No reason provided'
    },
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    read: false,
    userId: cancelReq.customerId,
    userRole: 'user'
  });
  
  // Notification for ALL ADMINS
  const adminsSnapshot = await db.collection('users')
    .where('role', '==', 'admin')
    .get();
  
  for (const adminDoc of adminsSnapshot.docs) {
    await db.collection('notifications').add({
      type: 'cancellation-rejected',
      message: `Cancellation rejected for order ${cancelReq.orderNumber} from ${cancelReq.customerName}`,
      details: {
        orderNumber: cancelReq.orderNumber,
        customerName: cancelReq.customerName,
        status: 'rejected',
        reason: reason || 'No reason provided'
      },
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false,
      userId: adminDoc.id,
      userRole: 'admin'
    });
  }
  
  console.log('âœ… Rejection notifications sent to customer and admins');
} catch (notifError) {
  console.error('âš ï¸ Failed to send notification (non-critical):', notifError);
}
      
      // Reload requests
      const snapshot = await db.collection('cancellationRequests')
        .where('status', '==', 'pending')
        .orderBy('requestedAt', 'desc')
        .get();
      
      setRequests(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
      
      alert('Cancellation request rejected.');
    } catch (error) {
      console.error('Error rejecting cancellation:', error);
      alert('Error rejecting cancellation. Please try again.');
    }
  };
  
  if (requests.length === 0) {
    return <p className="text-gray-500 text-center py-4">No pending cancellation requests</p>;
  }
  
  return (
    <div className="space-y-3">
      {requests.map(request => (
        <div key={request.id} className="p-4 bg-orange-50 border border-orange-200 rounded-lg">
          <div className="flex items-start justify-between mb-3">
            <div>
              <p className="font-semibold text-gray-800">{request.orderNumber}</p>
              <p className="text-sm text-gray-600">Customer: {request.customerName}</p>
              <p className="text-sm text-gray-600">Email: {request.customerEmail}</p>
              {request.requestedAt && (
                <p className="text-xs text-gray-500 mt-1">
                  Requested: {request.requestedAt.toDate().toLocaleString()}
                </p>
              )}
            </div>
            <span className="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-semibold">
              Pending Review
            </span>
          </div>
          
          <div className="mb-3 p-3 bg-white rounded border border-orange-100">
            <p className="text-xs text-gray-500 font-semibold mb-1">REASON:</p>
            <p className="text-sm text-gray-700">{request.reason}</p>
          </div>
          
          <div className="flex gap-2">
            <button
              onClick={() => handleApprove(request.id, request.orderId)}
              className="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm font-medium"
            >
              Approve Cancellation
            </button>
            <button
              onClick={() => handleReject(request.id)}
              className="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-medium"
            >
              Reject Request
            </button>
          </div>
        </div>
      ))}
    </div>
  );
}






function Dashboard() {

  const RENDER_CONFIG = {
    BACKEND_URL: 'https://operix-inventory-webhooks.onrender.com',
    WEBHOOK_SECRET: 'banana_pizza_unicorn_777_secret'
  };

  // Email notification function
const sendEmailNotification = async (type, data) => {
  try {
    const RENDER_BACKEND_URL = RENDER_CONFIG.BACKEND_URL;
    const WEBHOOK_SECRET = RENDER_CONFIG.WEBHOOK_SECRET;
    
    let endpoint = '';
    let body = {};
    
    if (type === 'invoice') {
      endpoint = '/webhook/send-invoice';
      body = {
        orderNumber: data.orderNumber,
        customerEmail: data.customerEmail,
        customerName: data.customerName,
        items: data.items,
        total: data.totalAmount,
        invoiceUrl: data.invoiceUrl || ''
      };
      
      console.log(`ðŸ“§ Sending invoice email to customer: ${data.customerEmail}...`, body);
      
      const response = await fetch(`${RENDER_BACKEND_URL}${endpoint}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${WEBHOOK_SECRET}`
        },
        body: JSON.stringify(body)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('âŒ Email notification failed:', errorText);
      } else {
        const result = await response.json();
        console.log('âœ… Invoice email sent to customer:', result);
      }
      
    } else if (type === 'low-stock') {
      // Get the admin who created this product
      const db = firebase.firestore();
      const productRef = await db.collection('products').doc(data.id).get();
      const productData = productRef.data();
      
      if (productData && productData.createdBy) {
        // Get admin's email
        const adminDoc = await db.collection('users').doc(productData.createdBy).get();
        const adminEmail = adminDoc.data()?.email;
        
        if (adminEmail) {
          endpoint = '/webhook/low-stock-alert';
          body = {
            productName: data.name,
            productId: data.id,
            currentStock: data.stock,
            threshold: data.threshold,
            adminEmail: adminEmail
          };
          
          console.log(`ðŸ“§ Sending low-stock alert to product owner: ${adminEmail}...`, body);
          
          const response = await fetch(`${RENDER_BACKEND_URL}${endpoint}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${WEBHOOK_SECRET}`
            },
            body: JSON.stringify(body)
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error(`âŒ Email notification failed for ${adminEmail}:`, errorText);
          } else {
            const result = await response.json();
            console.log(`âœ… Low-stock email sent to ${adminEmail}:`, result);
          }
        }
      }
      
    } else if (type === 'order-status') {
      // Only send to customer
      endpoint = '/webhook/order-status';
      body = {
        orderNumber: data.orderNumber,
        customerEmail: data.customerEmail,
        customerName: data.customerName,
        status: data.status,
        trackingUrl: data.trackingUrl || ''
      };
      
      console.log(`ðŸ“§ Sending order status email to customer: ${data.customerEmail}...`, body);
      
      const response = await fetch(`${RENDER_BACKEND_URL}${endpoint}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${WEBHOOK_SECRET}`
        },
        body: JSON.stringify(body)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('âŒ Email notification failed:', errorText);
      } else {
        const result = await response.json();
        console.log('âœ… Order status email sent to customer:', result);
      }
    }
    
  } catch (error) {
    console.error('âŒ Email error:', error);
  }
};

 

  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeModule, setActiveModule] = useState('dashboard');
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [showUserMenu, setShowUserMenu] = useState(false);
  const [notifications, setNotifications] = useState([]);
  const [showNotificationDropdown, setShowNotificationDropdown] = useState(false);
  const [userRole, setUserRole] = useState(null);
  
// My Orders filters
const [orderSearchQuery, setOrderSearchQuery] = useState('');
const [orderStatusFilter, setOrderStatusFilter] = useState('all');
const [orderDateRange, setOrderDateRange] = useState({ start: '', end: '' });
const [selectedOrder, setSelectedOrder] = useState(null);
const [showOrderDetails, setShowOrderDetails] = useState(false);
const [showCancelRequest, setShowCancelRequest] = useState(false);
const [cancelReason, setCancelReason] = useState('');


  const [stats, setStats] = useState({
    totalProducts: 0,
    lowStock: 0,
    outOfStock: 0,
    pendingOrders: 0,
    todaySales: 0,
    totalOrders: 0,
    completedOrders: 0,
  });

  const [recentOrders, setRecentOrders] = useState([]);
  const [lowStockItems, setLowStockItems] = useState([]);
  const [outOfStockItems, setOutOfStockItems] = useState([]);
  
  // Inventory state
  const [products, setProducts] = useState([]);
  const [showAddProduct, setShowAddProduct] = useState(false);
  const [editingProduct, setEditingProduct] = useState(null);
const [productForm, setProductForm] = useState({
  name: '', 
  sku: '', 
  category: '', 
  price: '', 
  stock: '', 
  threshold: '', 
  unit: 'pieces', 
  description: '', 
  imageUrl: '', 
  supplier: '',
  moq: '', // Minimum Order Quantity
  leadTime: '' // Lead time in days
});

  const [uploadingImage, setUploadingImage] = useState(false);
  
  // Orders state
  const [orders, setOrders] = useState([]);
  const [showCreateOrder, setShowCreateOrder] = useState(false);
  const [cart, setCart] = useState([]);
  const [orderForm, setOrderForm] = useState({
    customerName: '', 
    customerEmail: '', 
    customerPhone: '',
    deliveryAddress: '', 
    paymentMethod: 'Cash', 
    notes: ''
  });

  // Search and filter
  const [searchQuery, setSearchQuery] = useState('');
  const [categoryFilter, setCategoryFilter] = useState('all');
  const [submittingOrder, setSubmittingOrder] = useState(false);
  const [stockFilter, setStockFilter] = useState('all'); // New: all, in-stock, low-stock, out-of-stock

// Invoice Template states
const [showInvoiceTemplateModal, setShowInvoiceTemplateModal] = useState(false);
const [invoiceTemplate, setInvoiceTemplate] = useState(null);
const [uploadingTemplate, setUploadingTemplate] = useState(false);
const [templateFieldMapping, setTemplateFieldMapping] = useState({
  invoice_number: '',
  invoice_date: '',
  seller_name: '',
  seller_tin: '',
  seller_address: '',
  buyer_name: '',
  buyer_tin: '',
  buyer_address: '',
  items_table_start_y: '',
  subtotal_y: '',
  tax_y: '',
  total_y: '',
  signature_y: '',
  vat_percentage: '12' // Default 12% VAT
});

const [activeReport, setActiveReport] = useState(null);
const [invoiceLayoutConfig, setInvoiceLayoutConfig] = useState(null);


// Supplier Management states
const [suppliers, setSuppliers] = useState([]);
const [showAddSupplier, setShowAddSupplier] = useState(false);
const [editingSupplier, setEditingSupplier] = useState(null);
const [supplierForm, setSupplierForm] = useState({
  supplierCode: '',
  name: '',
  contactPerson: '',
  email: '',
  address: '',
  paymentTerms: '30 Days',
  currency: 'PHP',
  modeOfShipment: 'Air Freight'
});

// Supplier Settings states
const [showSupplierSettings, setShowSupplierSettings] = useState(false);
const [supplierSettings, setSupplierSettings] = useState({
  codePrefix: 'SUP',
  startingNumber: 1,
  paymentTermsOptions: ['30 Days', '60 Days', '90 Days', 'COD', 'Net 15'],
  currencyOptions: ['PHP', 'USD', 'EUR', 'JPY'],
  shipmentModeOptions: ['Air Freight', 'Sea Freight', 'Land Transport', 'Courier']
});

// Invoice settings states
const [showInvoiceSettings, setShowInvoiceSettings] = useState(false);
const [invoiceSettings, setInvoiceSettings] = useState({
  companyName: '',
  companyTIN: '',
  companyAddress: '',
  defaultVAT: '12',
  invoicePrefix: 'INV',
  startingInvoiceNumber: 1
});






// Load invoice template when user becomes available
useEffect(() => {
  if (user && user.uid && userRole === 'admin') {
    loadInvoiceTemplate();
  }
}, [user?.uid, userRole]); // Re-run when user or role changes

useEffect(() => {
  const checkAuth = () => {
    const firebaseConfig = {
        apiKey: "AIzaSyB56dPmBwgO4uWyXakhY9SJBCAz7bk0Do8",
        authDomain: "operix-c8a8c.firebaseapp.com",
        projectId: "operix-c8a8c",
        storageBucket: "operix-c8a8c.firebasestorage.app",
        messagingSenderId: "794223223499",
        appId: "1:794223223499:web:f059007b909cc15766f14e",
        measurementId: "G-6E4BD657K1"
      };

      const initFirebase = setInterval(() => {
        if (window.firebase) {
          clearInterval(initFirebase);
          
          if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
          }
          
          const auth = firebase.auth();
          const db = firebase.firestore();

          auth.onAuthStateChanged(async (currentUser) => {
            if (currentUser) {
              const userDoc = await db.collection('users').doc(currentUser.uid).get();
if (userDoc.exists) {
  const userData = userDoc.data();
  
  if (userData.role === 'admin' || userData.status === 'approved') {
    setUser({
      uid: currentUser.uid,
      email: currentUser.email,
      displayName: userData.fullName || currentUser.email,
      assignedAdminId: userData.assignedAdminId || null,
      assignedAdminName: userData.assignedAdminName || null,
      ...userData
    });
    // Set userRole - treat 'user' as regular user (not admin)
    setUserRole(userData.role === 'admin' ? 'admin' : 'user');
    await loadDashboardData(currentUser.uid, userData.role === 'admin' ? 'admin' : 'user', db);
  } else {
    window.location.href = 'login.html';
  }
} else {
                window.location.href = 'login.html';
              }
            } else {
              window.location.href = 'login.html';
            }
            setLoading(false);
          });
        }
      }, 100);
    };

    checkAuth();
  }, []);

const loadDashboardData = async (userId, role, db) => {
  try {
    let assignedAdminId = null;
    
    // For non-admin users, check if they have an assigned admin first
    if (role !== 'admin') {
      const userDoc = await db.collection('users').doc(userId).get();
      const userData = userDoc.data();
      
      // If user doesn't have an assigned admin, clear all data and exit
      if (!userData.assignedAdminId) {
        setProducts([]);
        setOrders([]);
        setStats({
          totalProducts: 0,
          lowStock: 0,
          outOfStock: 0,
          pendingOrders: 0,
          todaySales: 0,
          totalOrders: 0,
          completedOrders: 0,
        });
        setRecentOrders([]);
        setLowStockItems([]);
        setOutOfStockItems([]);
        // Still load notifications even without admin assignment
        await loadNotifications(db, userId, role);
        return; // Exit early - don't load any products or orders
      }
      
      // Store the assigned admin ID to filter products
      assignedAdminId = userData.assignedAdminId;
    }
    
// Load products - FILTER BY CREATOR FOR ADMINS, BY ASSIGNED ADMIN FOR USERS
let productsQuery = db.collection('products');

if (role === 'admin') {
  // Admins only see products THEY created
  productsQuery = productsQuery.where('createdBy', '==', userId);
} else if (assignedAdminId) {
  // Regular users only see products created by their assigned admin
  productsQuery = productsQuery.where('createdBy', '==', assignedAdminId);
}

const productsSnapshot = await productsQuery.get();
const productsData = productsSnapshot.docs
  .map(doc => ({ id: doc.id, ...doc.data() }))
  .sort((a, b) => {
    // Sort by createdAt in descending order (newest first)
    if (!a.createdAt || !b.createdAt) return 0;
    return b.createdAt.toMillis() - a.createdAt.toMillis();
  });
setProducts(productsData);
    
// Load orders - FILTER BY ADMIN'S PRODUCTS
let ordersData = [];
const ordersSnapshot = await db.collection('orders').orderBy('createdAt', 'desc').get();

if (role === 'admin') {
  // Admins only see orders containing THEIR products
  const adminProductIds = new Set(productsData.map(p => p.id));
  
  ordersData = ordersSnapshot.docs
    .map(doc => ({ id: doc.id, ...doc.data() }))
    .filter(order => {
      // Check if ANY item in the order is from this admin's products
      return order.items?.some(item => adminProductIds.has(item.productId));
    });
} else if (assignedAdminId) {
  // Regular users only see their own orders
  ordersData = ordersSnapshot.docs
    .map(doc => ({ id: doc.id, ...doc.data() }))
    .filter(order => order.customerId === userId);
} else {
  ordersData = [];
}

setOrders(ordersData);
      
      // Calculate stats - SEPARATE out of stock and low stock
      const outOfStockProducts = productsData.filter(p => p.stock === 0);
      const lowStockProducts = productsData.filter(p => p.stock > 0 && p.stock <= p.threshold);
      const pendingOrdersCount = ordersData.filter(o => o.status === 'pending').length;
      const completedOrdersCount = ordersData.filter(o => o.status === 'completed').length;
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todaySalesTotal = ordersData
        .filter(o => 
          o.createdAt && 
          o.createdAt.toDate() >= today && 
          o.status !== 'cancelled'
        )
        .reduce((sum, o) => sum + (o.totalAmount || 0), 0);
      
      setStats({
        totalProducts: productsData.length,
        lowStock: lowStockProducts.length,
        outOfStock: outOfStockProducts.length,
        pendingOrders: pendingOrdersCount,
        todaySales: todaySalesTotal,
        totalOrders: ordersData.length,
        completedOrders: completedOrdersCount,
      });
      
      setRecentOrders(ordersData.slice(0, 5));
      setLowStockItems(lowStockProducts.slice(0, 5));
      setOutOfStockItems(outOfStockProducts.slice(0, 5));
       
// Load notifications
await loadNotifications(db, userId, role);

// Load suppliers, invoice settings, and layout config for admins
if (role === 'admin') {
  await loadSuppliers(db, userId);
  await loadInvoiceSettings(db, userId);
  await loadLayoutConfig(db, userId);
}

    } catch (error) {
      console.error('Error loading dashboard data:', error);
    }
  };
  

const loadSuppliers = async (db, userId) => {
  try {
    const suppliersSnapshot = await db.collection('suppliers')
      .where('createdBy', '==', userId)
      .orderBy('createdAt', 'desc')
      .get();
    
    const suppliersData = suppliersSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    setSuppliers(suppliersData);
  } catch (error) {
    console.error('Error loading suppliers:', error);
  }
};


const calculateSupplierCompletion = (supplier) => {
  const fields = [
    // Basic Info - 7 fields
    supplier.name,
    supplier.contactPerson,
    supplier.email,
    supplier.address,
    supplier.paymentTerms,
    supplier.currency,
    supplier.modeOfShipment,
    
    // Company Profile - 5 fields
    supplier.registrationNumber,
    supplier.dateEstablished,
    supplier.businessType,
    supplier.industry,
    supplier.phoneNumber,
    
    // Tax Information - 1 field (TIN OR VAT)
    supplier.taxId || supplier.vatNumber ? 'filled' : '',
    
    // Financial Details - 2 fields (Bank Name + Account Holder + one of Account/IBAN)
    supplier.bankName,
    supplier.accountHolderName,
    supplier.accountNumber || supplier.iban ? 'filled' : ''
  ];
  
  const filledFields = fields.filter(field => field && String(field).trim() !== '').length;
  const totalFields = fields.length;
  const percentage = Math.round((filledFields / totalFields) * 100);
  
  return { percentage, filledFields, totalFields };
};



const loadSupplierSettings = async (db) => {
  try {
    const settingsDoc = await db.collection('supplierSettings').doc(user.uid).get();
    if (settingsDoc.exists) {
      setSupplierSettings(settingsDoc.data());
    }
  } catch (error) {
    console.error('Error loading supplier settings:', error);
  }
};

const loadInvoiceSettings = async (db, userId) => {
  try {
    const settingsDoc = await db.collection('invoiceSettings').doc(userId).get();
    if (settingsDoc.exists) {
      const settings = settingsDoc.data();
      console.log('Loaded invoice settings:', settings); // â† DEBUG LOG
      setInvoiceSettings({
        companyName: settings.companyName || '',
        companyTIN: settings.companyTIN || '',
        companyAddress: settings.companyAddress || '',
        defaultVAT: settings.defaultVAT || '12',
        invoicePrefix: settings.invoicePrefix || 'INV',
        startingInvoiceNumber: settings.startingInvoiceNumber || 1,
        termsAndConditions: settings.termsAndConditions || '', // â† ADD THIS
        signatureUrl: settings.signatureUrl || '', // â† ADD THIS
        signedBy: settings.signedBy || '' // â† ADD THIS
      });
    } else {
      console.log('No invoice settings found'); // â† DEBUG LOG
    }
  } catch (error) {
    console.error('Error loading invoice settings:', error);
  }
};


const loadLayoutConfig = async (db, userId) => {
  try {
    const layoutDoc = await db.collection('invoiceLayoutConfigs').doc(userId).get();
    
    if (layoutDoc.exists) {
      const loadedConfig = layoutDoc.data();
      setInvoiceLayoutConfig(loadedConfig);
      console.log('âœ… Layout config loaded from Firestore:', loadedConfig);
      return loadedConfig; // Return the config so it can be used immediately
    } else {
      // Set default layout config if none exists
const defaultConfig = {
  sections: {
    header: { visible: true, order: 1 },
    companyInfo: { visible: true, order: 2, columns: 2 },
    itemsTable: { visible: true, order: 3 },
    totals: { visible: true, order: 4, position: 'right' },
    paymentMethod: { visible: true, order: 5 },
    terms: { visible: true, order: 6 },
    signature: { visible: true, order: 7, columns: 2 },
    footer: { visible: true, order: 8 }
  },
        styling: {
          primaryColor: '#050C9C',
          secondaryColor: '#3B82F6',
          fontFamily: 'Arial',
          fontSize: 10,
          headerSize: 24
        },
        logoUrl: '',
        logoPosition: 'top',
        customFields: []
      };
      setInvoiceLayoutConfig(defaultConfig);
      console.log('âš ï¸ Using default layout config');
      return defaultConfig;
    }
  } catch (error) {
    console.error('âŒ Error loading layout config:', error);
    return null;
  }
};








  
  
  
  
  // ADD THESE NEW FUNCTIONS HERE:
  const createNotification = async (type, message, details = {}, notifyAdmins = false) => {
  try {
    const db = firebase.firestore();
    
    // Create notification for the current user
    const notificationData = {
      type,
      message,
      details,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false,
      userId: user.uid,
      userRole: userRole
    };
    
    await db.collection('notifications').add(notificationData);
    
    // If notifyAdmins is true, also create notifications for all admins
    if (notifyAdmins && userRole !== 'admin') {
      const adminsSnapshot = await db.collection('users')
        .where('role', '==', 'admin')
        .get();
      
      const adminNotifications = adminsSnapshot.docs.map(doc => ({
        type,
        message,
        details,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        read: false,
        userId: doc.id,
        userRole: 'admin'
      }));
      
      // Create notifications for all admins
      const batch = db.batch();
      adminNotifications.forEach(notif => {
        const notifRef = db.collection('notifications').doc();
        batch.set(notifRef, notif);
      });
      await batch.commit();
    }
    
// Reload notifications
await loadNotifications(db, user.uid, userRole);
  } catch (error) {
    console.error('Error creating notification:', error);
  }
};

const loadNotifications = async (db, userId, role) => {
  try {
    // Safety check: if userId is not provided, skip
    if (!userId) {
      console.log('User ID not provided, skipping notifications');
      return;
    }
    
    let notificationsQuery = db.collection('notifications')
      .orderBy('timestamp', 'desc')
      .limit(20);
    
    // Both admins and users only see their own notifications
    notificationsQuery = notificationsQuery.where('userId', '==', userId);
    
    const snapshot = await notificationsQuery.get();
    const notifs = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      timeAgo: getTimeAgo(doc.data().timestamp)
    }));
    
    setNotifications(notifs);
  } catch (error) {
    console.error('Error loading notifications:', error);
  }
};

  const getTimeAgo = (timestamp) => {
    if (!timestamp) return 'Just now';
    
    const now = new Date();
    const time = timestamp.toDate();
    const diffMs = now - time;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    return `${diffDays}d ago`;
  };

const markNotificationAsRead = async (notificationId) => {
  try {
    const db = firebase.firestore();
    const notifRef = db.collection('notifications').doc(String(notificationId));
    const notifDoc = await notifRef.get();
    
    if (notifDoc.exists) {
      await notifRef.update({ read: true });
      await loadNotifications(db, user.uid, userRole);
    }
  } catch (error) {
    console.error('Error marking notification as read:', error);
  }
};

const markAllAsRead = async () => {
  try {
    const db = firebase.firestore();
    const batch = db.batch();
    
    notifications.filter(n => !n.read).forEach(notif => {
      const ref = db.collection('notifications').doc(String(notif.id));
      batch.update(ref, { read: true });
    });
    
    await batch.commit();
    await loadNotifications(db, user.uid, userRole);
  } catch (error) {
    console.error('Error marking all as read:', error);
  }
};
  
  
  
  

  const uploadToCloudinary = (file) => {
    if (!file) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const selectedFile = e.target.files[0];
        if (selectedFile) {
          uploadToCloudinary(selectedFile);
        }
      };
      input.click();
      return;
    }

    setUploadingImage(true);

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'operix_products');
    formData.append('folder', 'operix-products');

    const xhr = new XMLHttpRequest();

    xhr.upload.addEventListener('progress', (e) => {
      if (e.lengthComputable) {
        const percentComplete = Math.round((e.loaded / e.total) * 100);
        console.log(`Upload progress: ${percentComplete}%`);
      }
    });

    xhr.addEventListener('load', () => {
      if (xhr.status === 200) {
        const response = JSON.parse(xhr.responseText);
        setProductForm(prev => ({ ...prev, imageUrl: response.secure_url }));
        setUploadingImage(false);
        console.log('Image uploaded successfully:', response.secure_url);
      } else {
        console.error('Upload failed with status:', xhr.status);
        alert('Failed to upload image. Please try again.');
        setUploadingImage(false);
      }
    });

    xhr.addEventListener('error', () => {
      console.error('Upload error');
      alert('Failed to upload image. Please try again.');
      setUploadingImage(false);
    });

    xhr.open('POST', 'https://api.cloudinary.com/v1_1/dmrtrl4er/image/upload');
    xhr.send(formData);
  };





const uploadTemplateToCloudinary = (file) => {
  if (!file) return;
  
  if (file.type !== 'application/pdf') {
    alert('Please upload a PDF file');
    return;
  }

  setUploadingTemplate(true);

  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', 'operix_products');
  formData.append('folder', 'operix-invoice-templates');
  formData.append('resource_type', 'raw'); // Important for PDFs

  const xhr = new XMLHttpRequest();

  xhr.addEventListener('load', () => {
    if (xhr.status === 200) {
      const response = JSON.parse(xhr.responseText);
      saveInvoiceTemplate(response.secure_url);
    } else {
      console.error('Upload failed with status:', xhr.status);
      alert('Failed to upload template. Please try again.');
      setUploadingTemplate(false);
    }
  });

  xhr.addEventListener('error', () => {
    console.error('Upload error');
    alert('Failed to upload template. Please try again.');
    setUploadingTemplate(false);
  });

  xhr.open('POST', 'https://api.cloudinary.com/v1_1/dmrtrl4er/upload');
  xhr.send(formData);
};

const saveInvoiceTemplate = async (templateUrl) => {
  try {
    const db = firebase.firestore();
    
    const templateData = {
      templateUrl,
      fieldMapping: templateFieldMapping,
      uploadedBy: user.uid,
      uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // Save or update template (one per admin)
    await db.collection('invoiceTemplates').doc(user.uid).set(templateData);
    
    setInvoiceTemplate(templateData);
    setShowInvoiceTemplateModal(false);
    setUploadingTemplate(false);
    
    alert('Invoice template saved successfully!');
  } catch (error) {
    console.error('Error saving template:', error);
    alert('Error saving template. Please try again.');
    setUploadingTemplate(false);
  }
};

const loadInvoiceTemplate = async () => {
  try {
    // Safety check: only load if user exists
    if (!user || !user.uid) {
      console.log('User not ready yet, skipping template load');
      return;
    }
    
    const db = firebase.firestore();
    const templateDoc = await db.collection('invoiceTemplates').doc(user.uid).get();
    
    if (templateDoc.exists) {
      const data = templateDoc.data();
      setInvoiceTemplate(data);
      
      // Safely merge field mapping with defaults
      setTemplateFieldMapping({
        invoice_number: '',
        invoice_date: '',
        seller_name: '',
        seller_tin: '',
        seller_address: '',
        buyer_name: '',
        buyer_tin: '',
        buyer_address: '',
        items_table_start_y: '',
        subtotal_y: '',
        tax_y: '',
        total_y: '',
        signature_y: '',
        vat_percentage: '12',
        ...(data.fieldMapping || {})
      });
    }
  } catch (error) {
    console.error('Error loading template:', error);
  }
};










// Product CRUD operations
const saveProduct = async () => {
  try {
    if (!productForm.name || !productForm.sku || !productForm.price || productForm.stock === '') {
      alert('Please fill in all required fields');
      return;
    }

    const db = firebase.firestore();
    const newStock = parseInt(productForm.stock);
    const threshold = parseInt(productForm.threshold) || 10;
    
    const productData = {
      ...productForm,
      price: parseFloat(productForm.price),
      stock: newStock,
      threshold: threshold,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if (editingProduct) {
      await db.collection('products').doc(editingProduct.id).update(productData);
      
      await db.collection('adminLogs').add({
        adminId: user.uid,
        adminName: user.displayName,
        action: 'Updated Product',
        details: `Updated product: ${productForm.name} (${productForm.sku})`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      await createNotification(
        'product-edit',
        `Product updated: ${productForm.name}`,
        {
          productName: productForm.name,
          sku: productForm.sku,
          action: 'updated',
          changes: 'Product details modified'
        }
      );
    } else {
      await db.collection('products').add({
        ...productData,
        createdBy: user.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      await db.collection('adminLogs').add({
        adminId: user.uid,
        adminName: user.displayName,
        action: 'Added Product',
        details: `Added new product: ${productForm.name} (${productForm.sku})`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      await createNotification(
        'product-edit',
        `Product added: ${productForm.name}`,
        {
          productName: productForm.name,
          sku: productForm.sku,
          action: 'added',
          changes: 'New product created'
        }
      );
    }

    if (newStock > 0 && newStock <= threshold) {
      console.log('ðŸ”” Low stock detected, sending email...');
      await sendEmailNotification('low-stock', {
        name: productForm.name,
        id: editingProduct?.id || 'new-product',
        stock: newStock,
        threshold: threshold
      });
    }

    await loadDashboardData(user.uid, userRole, db);
    setShowAddProduct(false);
    setEditingProduct(null);
    resetProductForm();
    alert('Product saved successfully!');
  } catch (error) {
    console.error('Error saving product:', error);
    alert('Error saving product. Please try again.');
  }
};

// At the end of loadDashboardData, before the catch block:



  const deleteProduct = async (productId) => {
    if (!confirm('Are you sure you want to delete this product?')) return;
    try {
      const db = firebase.firestore();
      const product = products.find(p => p.id === productId);
      
      await db.collection('products').doc(productId).delete();
      
      await db.collection('adminLogs').add({
        adminId: user.uid,
        adminName: user.displayName,
        action: 'Deleted Product',
        details: `Deleted product: ${product.name} (${product.sku})`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      await loadDashboardData(user.uid, userRole, db);
      alert('Product deleted successfully!');
    } catch (error) {
      console.error('Error deleting product:', error);
      alert('Error deleting product. Please try again.');
    }
  };


// Supplier CRUD operations
const generateSupplierCode = async () => {
  const db = firebase.firestore();
  const counterRef = db.collection('supplierCounters').doc(user.uid);
  
  try {
    const counterDoc = await counterRef.get();
    let nextNumber = supplierSettings.startingNumber;
    
    if (counterDoc.exists) {
      nextNumber = counterDoc.data().count + 1;
      await counterRef.update({ count: firebase.firestore.FieldValue.increment(1) });
    } else {
      await counterRef.set({ count: supplierSettings.startingNumber });
    }
    
    return `${supplierSettings.codePrefix}-${String(nextNumber).padStart(4, '0')}`;
  } catch (error) {
    console.error('Error generating supplier code:', error);
    return `${supplierSettings.codePrefix}-0001`;
  }
};

const saveSupplier = async () => {
  try {
    if (!supplierForm.name || !supplierForm.email) {
      alert('Please fill in supplier name and email');
      return;
    }

    const db = firebase.firestore();
    let supplierCode = supplierForm.supplierCode;
    
    // Generate supplier code if adding new supplier
    if (!editingSupplier) {
      supplierCode = await generateSupplierCode();
    }
    
    const supplierData = {
      ...supplierForm,
      supplierCode,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if (editingSupplier) {
      await db.collection('suppliers').doc(editingSupplier.id).update(supplierData);
      alert('Supplier updated successfully!');
    } else {
      await db.collection('suppliers').add({
        ...supplierData,
        createdBy: user.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('Supplier added successfully!');
    }

    await loadSuppliers(db, user.uid);
    setShowAddSupplier(false);
    setEditingSupplier(null);
    resetSupplierForm();
  } catch (error) {
    console.error('Error saving supplier:', error);
    alert('Error saving supplier. Please try again.');
  }
};

const deleteSupplier = async (supplierId) => {
  if (!confirm('Are you sure you want to delete this supplier?')) return;
  
  try {
    const db = firebase.firestore();
    await db.collection('suppliers').doc(supplierId).delete();
    await loadSuppliers(db);
    alert('Supplier deleted successfully!');
  } catch (error) {
    console.error('Error deleting supplier:', error);
    alert('Error deleting supplier. Please try again.');
  }
};

const resetSupplierForm = () => {
  setSupplierForm({
    supplierCode: '',
    name: '',
    contactPerson: '',
    email: '',
    address: '',
    paymentTerms: '30 Days',
    currency: 'PHP',
    modeOfShipment: 'Air Freight'
  });
};

const saveSupplierSettings = async () => {
  try {
    const db = firebase.firestore();
    await db.collection('supplierSettings').doc(user.uid).set({
      ...supplierSettings,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    setShowSupplierSettings(false);
    alert('Supplier settings saved successfully!');
  } catch (error) {
    console.error('Error saving supplier settings:', error);
    alert('Error saving settings. Please try again.');
  }
};

const saveInvoiceSettings = async () => {
  try {
    const db = firebase.firestore();
    await db.collection('invoiceSettings').doc(user.uid).set({
      ...invoiceSettings,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    setShowInvoiceSettings(false);
    alert('Invoice settings saved successfully!');
  } catch (error) {
    console.error('Error saving invoice settings:', error);
    alert('Error saving settings. Please try again.');
  }
}; // â† Make sure this closing brace and semicolon are here







const resetProductForm = () => {
  setProductForm({
    name: '', 
    sku: '', 
    category: '', 
    price: '', 
    stock: '', 
    threshold: '', 
    unit: 'pieces', 
    description: '', 
    imageUrl: '', 
    supplier: '',
    moq: '',
    leadTime: ''
  });
};

  // Order operations
  const addToCart = (product) => {
    if (product.stock === 0) {
      alert('This product is out of stock!');
      return;
    }
    
    const existing = cart.find(item => item.id === product.id);
    if (existing) {
      setCart(cart.map(item => 
        item.id === product.id 
          ? { ...item, quantity: Math.min(item.quantity + 1, product.stock) }
          : item
      ));
    } else {
      setCart([...cart, { ...product, quantity: 1 }]);
    }
  };

  const updateCartQuantity = (productId, quantity) => {
    const product = products.find(p => p.id === productId);
    if (quantity <= 0) {
      setCart(cart.filter(item => item.id !== productId));
    } else if (quantity > product.stock) {
      alert(`Only ${product.stock} ${product.unit} available in stock`);
    } else {
      setCart(cart.map(item => 
        item.id === productId ? { ...item, quantity } : item
      ));
    }
  };

  const removeFromCart = (productId) => {
    setCart(cart.filter(item => item.id !== productId));
  };

  const calculateTotal = () => {
    return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  };

const submitOrder = async () => {
  if (cart.length === 0) {
    alert('Please add items to cart');
    return;
  }
  if (!orderForm.customerName || !orderForm.customerEmail || !orderForm.deliveryAddress) {
    alert('Please fill in all required fields (Name, Email, Delivery Address)');
    return;
  }
  
  // Prevent multiple submissions
  if (submittingOrder) {
    return;
  }

  try {
    setSubmittingOrder(true);
    
    const db = firebase.firestore();
    const batch = db.batch();

    console.log('=== ORDER CREATION DEBUG ===');
    console.log('Current user:', user);
    console.log('User UID:', user.uid);
    console.log('User role:', userRole);
    
// Generate unique sequential order number
const counterRef = db.collection('counters').doc('orderCounter');
let orderCount = 1;

try {
  const counterDoc = await counterRef.get();
  
  if (counterDoc.exists) {
    orderCount = counterDoc.data().count + 1;
    await counterRef.update({ count: firebase.firestore.FieldValue.increment(1) });
  } else {
    await counterRef.set({ count: 1 });
  }
} catch (counterError) {
  console.error('Error with counter:', counterError);
  // Fallback to timestamp-based order number if counter fails
  orderCount = Date.now();
}

// Load invoice settings to get custom prefix
let orderPrefix = 'ORD'; // Default prefix
try {
  const settingsDoc = await db.collection('invoiceSettings').doc(user.uid).get();
  if (settingsDoc.exists && settingsDoc.data().invoicePrefix) {
    orderPrefix = settingsDoc.data().invoicePrefix;
  }
} catch (prefixError) {
  console.warn('Could not load invoice prefix, using default:', prefixError);
}

const orderNumber = `${orderPrefix}-${String(orderCount).padStart(4, '0')}`;

// Load invoice settings to get prefix
const settingsDoc = await db.collection('invoiceSettings').doc(user.uid).get();
const prefix = settingsDoc.exists ? settingsDoc.data().invoicePrefix || 'ORD' : 'ORD';


    // Create order
    const orderRef = db.collection('orders').doc();
    const orderData = {
      orderNumber,
      customerId: user.uid,
      customerName: orderForm.customerName,
      customerEmail: orderForm.customerEmail,
      customerPhone: orderForm.customerPhone,
      deliveryAddress: orderForm.deliveryAddress,
      paymentMethod: orderForm.paymentMethod,
      notes: orderForm.notes,
      items: cart.map(item => ({
        productId: item.id,
        name: item.name,
        sku: item.sku,
        quantity: item.quantity,
        price: item.price,
        unit: item.unit,
        subtotal: item.price * item.quantity
      })),
      totalAmount: calculateTotal(),
      status: 'pending',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    batch.set(orderRef, orderData);

    // Update product stock
    const stockAlerts = [];
    for (const item of cart) {
      const productRef = db.collection('products').doc(item.id);
      const productDoc = await productRef.get();
      const productData = productDoc.data();
      
      const newStock = productData.stock - item.quantity;
      const threshold = productData.threshold || 10;
      
      // Update stock in batch
      batch.update(productRef, {
        stock: firebase.firestore.FieldValue.increment(-item.quantity)
      });
      
      // Check if stock alert is needed
      if (newStock === 0) {
        // Out of stock alert
        stockAlerts.push({
          type: 'out-of-stock',
          product: { ...productData, id: item.id, stock: newStock }
        });
      } else if (newStock > 0 && newStock <= threshold && productData.stock > threshold) {
        // Just crossed threshold - send low stock alert
        stockAlerts.push({
          type: 'low-stock',
          product: { ...productData, id: item.id, stock: newStock, threshold }
        });
      }
    }

    // *** COMMIT THE BATCH FIRST - BEFORE SENDING ANY EMAILS ***
    await batch.commit();
    console.log('âœ… Order saved to database successfully');


// *** NOW CREATE NOTIFICATIONS - AFTER DATABASE SUCCESS ***
try {
  // Get all admin users
  const adminsSnapshot = await db.collection('users')
    .where('role', '==', 'admin')
    .get();

  const notifBatch = db.batch();

  // If current user is NOT admin, create notification for them
  if (userRole !== 'admin') {
    const userNotifRef = db.collection('notifications').doc();
    notifBatch.set(userNotifRef, {
      type: 'order',
      message: `Order ${orderNumber} placed successfully`,
      details: {
        orderNumber,
        customerName: orderForm.customerName,
        totalAmount: calculateTotal(),
        status: 'pending'
      },
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false,
      userId: user.uid,
      userRole: userRole
    });
  }

  // Create ONE notification per admin (NOT including current user if they're admin)
  adminsSnapshot.docs.forEach(doc => {
    // Skip if this admin is the current user (avoid duplicate)
    if (doc.id !== user.uid) {
      const adminNotifRef = db.collection('notifications').doc();
      notifBatch.set(adminNotifRef, {
        type: 'order',
        message: `New order ${orderNumber} from ${orderForm.customerName}`,
        details: {
          orderNumber,
          customerName: orderForm.customerName,
          totalAmount: calculateTotal(),
          status: 'pending'
        },
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        read: false,
        userId: doc.id,
        userRole: 'admin'
      });
    }
  });

  await notifBatch.commit();
  console.log('âœ… Notifications created successfully');
} catch (notifError) {
  // Don't fail the order if notifications fail
  console.error('âš ï¸ Failed to create notifications (non-critical):', notifError);
}


    console.log('âœ… Notifications created successfully');
    
    // *** NOW SEND EMAILS - ONLY AFTER EVERYTHING ELSE SUCCEEDED ***
    
    // Send stock alerts after order is committed
    for (const alert of stockAlerts) {
      console.log(`ðŸ“§ Sending ${alert.type} alert for ${alert.product.name}...`);
      await sendEmailNotification('low-stock', {
        name: alert.product.name,
        id: alert.product.id,
        stock: alert.product.stock,
        threshold: alert.product.threshold || 10
      });
    }
    
    // Send invoice email
    console.log('ðŸ“§ Sending invoice email...');
    await sendEmailNotification('invoice', {
      orderNumber: orderNumber,
      customerEmail: orderForm.customerEmail,
      customerName: orderForm.customerName,
      items: cart.map(item => ({
        name: item.name,
        quantity: item.quantity,
        price: item.price.toFixed(2)
      })),
      totalAmount: calculateTotal().toFixed(2)
    });
    
    // Reload dashboard data
    await loadDashboardData(user.uid, userRole, db);
    
    // Reset form and close modal
    setShowCreateOrder(false);
    setCart([]);
    setOrderForm({
      customerName: '', 
      customerEmail: '', 
      customerPhone: '',
      deliveryAddress: '', 
      paymentMethod: 'Cash', 
      notes: ''
    });
    
    alert(`Order ${orderNumber} created successfully! Invoice sent to ${orderForm.customerEmail}`);
  } catch (error) {
    console.error('Error creating order:', error);
    alert('Error creating order: ' + error.message + '\nPlease try again or contact support.');
  } finally {
    setSubmittingOrder(false);
  }
};

const updateOrderStatus = async (orderId, newStatus) => {
    try {
      const db = firebase.firestore();
      const order = orders.find(o => o.id === orderId);
      
      if (newStatus === 'cancelled' && order.status === 'cancelled') {
        alert('This order is already cancelled!');
        return;
      }
      
      if (newStatus === 'cancelled' && order.status === 'completed') {
        if (!confirm('This order is already completed. Are you sure you want to cancel it?')) {
          return;
        }
      }
      
      // If cancelling an order, return stock to inventory
      if (newStatus === 'cancelled' && order.status !== 'cancelled') {
        const batch = db.batch();
        
        order.items.forEach(item => {
          const productRef = db.collection('products').doc(item.productId);
          batch.update(productRef, {
            stock: firebase.firestore.FieldValue.increment(item.quantity)
          });
        });
        
        const orderRef = db.collection('orders').doc(orderId);
        batch.update(orderRef, {
          status: newStatus,
          cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        await batch.commit();
        
        // ONLY send email when cancelling
        console.log('ðŸ“§ Sending order cancellation email...');
        await sendEmailNotification('order-status', {
          orderNumber: order.orderNumber,
          customerEmail: order.customerEmail,
          customerName: order.customerName,
          status: newStatus
        });
      } else {
        // For processing/completed, just update status WITHOUT sending email
        await db.collection('orders').doc(orderId).update({
          status: newStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log('âœ… Order status updated (no email sent for processing/completed)');
      }

await db.collection('adminLogs').add({
        adminId: user.uid,
        adminName: user.displayName,
        action: 'Updated Order Status',
        details: `Changed order ${order.orderNumber} status to ${newStatus}`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      
// CREATE NOTIFICATION FOR ORDER STATUS - for the customer who placed the order
const customerNotificationData = {
  type: 'order-status',
  message: `Your order ${order.orderNumber} is now ${newStatus}`,
  details: {
    orderNumber: order.orderNumber,
    customerName: order.customerName,
    oldStatus: order.status,
    newStatus: newStatus,
    totalAmount: order.totalAmount
  },
  timestamp: firebase.firestore.FieldValue.serverTimestamp(),
  read: false,
  userId: order.customerId, // â† This is the customer's ID, not the admin
  userRole: 'user'
};

await db.collection('notifications').add(customerNotificationData);

// Also create notification for admin if current user is not admin
if (userRole !== 'admin') {
  const adminsSnapshot = await db.collection('users')
    .where('role', '==', 'admin')
    .get();
  
  const adminNotifications = adminsSnapshot.docs.map(doc => ({
    type: 'order-status',
    message: `Order ${order.orderNumber} updated to ${newStatus}`,
    details: {
      orderNumber: order.orderNumber,
      customerName: order.customerName,
      oldStatus: order.status,
      newStatus: newStatus
    },
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    read: false,
    userId: doc.id,
    userRole: 'admin'
  }));
  
  const batch = db.batch();
  adminNotifications.forEach(notif => {
    const notifRef = db.collection('notifications').doc();
    batch.set(notifRef, notif);
  });
  await batch.commit();
}

// Reload notifications
await loadNotifications(db, user.uid, userRole);
      
      await loadDashboardData(user.uid, userRole, db);
if (newStatus === 'cancelled') {
  alert(`Order cancelled. Stock returned and email sent to ${order.customerEmail}`);
} else {
  alert(`Order status updated to ${newStatus}.`);
}
    } catch (error) {
      console.error('Error updating order:', error);
      alert('Error updating order. Please try again.');
    }
  };

const requestOrderCancellation = async (orderId, reason) => {
  try {
    const db = firebase.firestore();
    const order = orders.find(o => o.id === orderId);
    
    if (!order) {
      alert('Order not found');
      return;
    }
    
    if (order.status === 'cancelled') {
      alert('This order is already cancelled');
      return;
    }
    
    if (order.status === 'completed') {
      alert('Cannot cancel a completed order. Please contact support.');
      return;
    }
    
    // Create cancellation request
    await db.collection('cancellationRequests').add({
      orderId: order.id,
      orderNumber: order.orderNumber,
      customerId: user.uid,
      customerName: order.customerName,
      customerEmail: order.customerEmail,
      reason: reason,
      status: 'pending',
      requestedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Update order with cancellation request flag
    await db.collection('orders').doc(orderId).update({
      cancellationRequested: true,
      cancellationReason: reason,
      cancellationRequestedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Create notification for user first (this will always succeed)
    await db.collection('notifications').add({
      type: 'cancellation-request',
      message: `Cancellation request submitted for order ${order.orderNumber}`,
      details: {
        orderNumber: order.orderNumber,
        status: 'pending review'
      },
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false,
      userId: user.uid,
      userRole: userRole
    });
    
    // Try to notify admins (non-critical - don't fail if this doesn't work)
    try {
      const adminsSnapshot = await db.collection('users')
        .where('role', '==', 'admin')
        .get();
      
      // Create individual notification documents for each admin
      for (const adminDoc of adminsSnapshot.docs) {
        await db.collection('notifications').add({
          type: 'cancellation-request',
          message: `Cancellation request for order ${order.orderNumber}`,
          details: {
            orderNumber: order.orderNumber,
            customerName: order.customerName,
            reason: reason,
            orderId: order.id
          },
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          read: false,
          userId: adminDoc.id,
          userRole: 'admin'
        });
      }
      console.log('âœ… Admin notifications created successfully');
    } catch (notifError) {
      console.warn('âš ï¸ Failed to create admin notifications (non-critical):', notifError);
      // Don't fail the whole operation if admin notifications fail
    }
    
    await loadDashboardData(user.uid, userRole, db);
    setShowCancelRequest(false);
    setCancelReason('');
    alert('Cancellation request submitted successfully. An admin will review it soon.');
  } catch (error) {
    console.error('Error requesting cancellation:', error);
    alert('Error submitting cancellation request: ' + error.message);
  }
};





const generateInvoicePDF = async (order) => {
  try {
    const db = firebase.firestore();

    // Load the LATEST layout config from Firestore
    console.log('Loading latest layout config...');
    const layoutDoc = await db.collection('invoiceLayoutConfigs').doc(user.uid).get();
    
    let currentLayout;
    if (layoutDoc.exists) {
      currentLayout = layoutDoc.data();
      console.log('âœ… Loaded layout from Firestore:', currentLayout);
    } else {
      // Use default if not found
      currentLayout = {
        sections: {
          header: { visible: true, order: 1 },
          companyInfo: { visible: true, order: 2, columns: 2 },
          itemsTable: { visible: true, order: 3 },
          totals: { visible: true, order: 4, position: 'right' },
          paymentMethod: { visible: true, order: 5 },
          terms: { visible: true, order: 6 },
          signature: { visible: true, order: 7, columns: 2 },
          footer: { visible: true, order: 8 }
        },
        styling: {
          primaryColor: '#050C9C',
          secondaryColor: '#3B82F6',
          fontFamily: 'Arial',
          fontSize: 10,
          headerSize: 24
        },
        logoUrl: '',
        logoPosition: 'top'
      };
      console.log('âš ï¸ Using default layout');
    }

    // Check if invoice already exists
    if (order.invoiceData && order.invoiceData.terms_and_conditions !== undefined && order.invoiceData.signature_url !== undefined) {
      console.log('Using saved invoice data');
      const invoiceHTML = generateInvoiceHTML(order.invoiceData, currentLayout);
      const printWindow = window.open('', '_blank');
      printWindow.document.write(invoiceHTML);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => printWindow.print(), 500);
      return;
    } else if (order.invoiceData) {
      console.log('âš ï¸ Invoice data exists but missing terms/signature - regenerating...');
    }
    
    // Load latest invoice settings from Firestore
    console.log('Loading invoice settings for user:', user.uid);
    const settingsDoc = await db.collection('invoiceSettings').doc(user.uid).get();

    if (!settingsDoc.exists) {
      console.error('No invoice settings document found');
      alert('Please configure invoice settings first in Reports > Invoice Template Manager');
      return;
    }

    const settings = settingsDoc.data();
    console.log('âœ… Full settings object:', settings);

    // Validate required fields
    if (!settings || !settings.companyName || !settings.companyTIN || !settings.companyAddress) {
      console.error('Invoice settings incomplete:', settings);
      alert('Please complete all company information in Invoice Settings.');
      return;
    }

    console.log('âœ… All invoice settings validated');
    
    const vatPercent = parseFloat(settings.defaultVAT || '12');
    const vatDecimal = vatPercent / 100;
    
    // Create invoice data
    const invoiceData = {
      invoice_number: order.orderNumber,
      invoice_date: order.createdAt?.toDate().toLocaleDateString() || new Date().toLocaleDateString(),
      seller_name: settings.companyName,
      seller_tin: settings.companyTIN,
      seller_address: settings.companyAddress,
      buyer_name: order.customerName,
      buyer_tin: 'N/A',
      buyer_address: order.deliveryAddress,
      payment_method: order.paymentMethod || 'N/A',
      items: order.items.map((item) => ({
        description: item.name,
        qty: item.quantity,
        unit: item.unit,
        price: item.price.toFixed(2),
        total: item.subtotal.toFixed(2)
      })),
      subtotal: order.totalAmount.toFixed(2),
      vat_percentage: vatPercent.toFixed(0),
      tax: (order.totalAmount * vatDecimal).toFixed(2),
      grand_total: (order.totalAmount * (1 + vatDecimal)).toFixed(2),
      terms_and_conditions: settings.termsAndConditions || '',
      special_instructions: order.notes || '',
      signature_url: settings.signatureUrl || '',
      signed_by: settings.signedBy || '',
      generated_at: new Date().toISOString()
    };

    console.log('Invoice data created:', invoiceData);

    // Save invoice data to order
    await db.collection('orders').doc(order.id).update({
      invoiceData: invoiceData,
      invoiceGeneratedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    console.log('Invoice data saved to order');

    // Generate and open invoice HTML with CURRENT layout config
    const invoiceHTML = generateInvoiceHTML(invoiceData, currentLayout);
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(invoiceHTML);
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => {
      printWindow.print();
    }, 500);
    
    await loadDashboardData(user.uid, userRole, db);
    
  } catch (error) {
    console.error('Error generating invoice:', error);
    alert('Error generating invoice: ' + error.message);
  }
};

const generateInvoiceHTML = (data, layoutConfig = null) => {
  // Get layout config or use defaults
const layout = layoutConfig || invoiceLayoutConfig || {
sections: {
  header: { visible: true, order: 1 },
  companyInfo: { visible: true, order: 2, columns: 2 },
  itemsTable: { visible: true, order: 3 },
  totals: { visible: true, order: 4, position: 'right' },
  paymentMethod: { visible: true, order: 5 },
  terms: { visible: true, order: 6 },
  signature: { visible: true, order: 7, columns: 2 },
  footer: { visible: true, order: 8 }
},

    styling: {
      primaryColor: '#050C9C',
      secondaryColor: '#3B82F6',
      fontFamily: 'Arial',
      fontSize: 10,
      headerSize: 24
    },
    logoUrl: ''
  };

  const primaryColor = layout.styling.primaryColor;
  const secondaryColor = layout.styling.secondaryColor;
  const fontFamily = layout.styling.fontFamily;
  const fontSize = layout.styling.fontSize;
  const headerSize = layout.styling.headerSize;

// Create sections array with order
const sections = Object.entries(layout.sections)
  .filter(([key, section]) => section.visible)
  .sort((a, b) => a[1].order - b[1].order)
  .map(([key]) => key);

// Build section HTML dynamically
const buildSectionHTML = (sectionKey) => {
  switch(sectionKey) {
case 'header':
        const logoPosition = layout.logoPosition || 'top';
        const isLogoLeft = logoPosition === 'left' && layout.logoUrl;
        
        return `
          <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid ${primaryColor}; ${(isLogoLeft && layout.logoUrl) ? 'display: flex; align-items: center; gap: 20px;' : 'text-align: center;'}">
            ${layout.logoUrl && logoPosition === 'top' ? `
              <div style="margin-bottom: 10px; text-align: center;">
                <img src="${layout.logoUrl}" alt="Logo" style="height: 48px; max-width: 200px; object-fit: contain; display: block; margin: 0 auto;" />
              </div>
            ` : ''}
            
            ${layout.logoUrl && logoPosition === 'left' ? `
              <div style="flex-shrink: 0;">
                <img src="${layout.logoUrl}" alt="Logo" style="height: 48px; max-width: 120px; object-fit: contain;" />
              </div>
            ` : ''}
            
            <div style="${isLogoLeft ? 'flex: 1;' : ''}">
              <h1 style="color: ${primaryColor}; font-size: ${headerSize}px; font-weight: bold; margin: 10px 0;">INVOICE</h1>
              <div style="font-size: ${fontSize}px; margin-top: 5px; ${isLogoLeft ? 'text-align: left;' : ''}">
                <strong>Invoice No:</strong> ${data.invoice_number} | <strong>Date:</strong> ${data.invoice_date}
              </div>
            </div>
          </div>
        `;

case 'companyInfo':
        const cols = layout.sections.companyInfo?.columns || 2;
        return `
          <div style="display: grid; grid-template-columns: ${cols === 2 ? '1fr 1fr' : '1fr'}; gap: 15px; margin-bottom: 20px;">
            <div style="border: 1px solid #ddd; padding: 12px; border-radius: 4px;">
              <h3 style="color: ${primaryColor}; font-size: ${fontSize + 1}px; font-weight: bold; margin: 0 0 8px 0; border-bottom: 1px solid ${primaryColor}; padding-bottom: 5px;">Seller Information</h3>
              <p style="margin: 4px 0; font-size: ${fontSize - 1}px;"><strong>Name:</strong> ${data.seller_name}</p>
              <p style="margin: 4px 0; font-size: ${fontSize - 1}px;"><strong>TIN:</strong> ${data.seller_tin}</p>
              <p style="margin: 4px 0; font-size: ${fontSize - 1}px;"><strong>Address:</strong> ${data.seller_address}</p>
            </div>
            <div style="border: 1px solid #ddd; padding: 12px; border-radius: 4px;">
              <h3 style="color: ${primaryColor}; font-size: ${fontSize + 1}px; font-weight: bold; margin: 0 0 8px 0; border-bottom: 1px solid ${primaryColor}; padding-bottom: 5px;">Buyer Information</h3>
              <p style="margin: 4px 0; font-size: ${fontSize - 1}px;"><strong>Name:</strong> ${data.buyer_name}</p>
              <p style="margin: 4px 0; font-size: ${fontSize - 1}px;"><strong>TIN:</strong> ${data.buyer_tin}</p>
              <p style="margin: 4px 0; font-size: ${fontSize - 1}px;"><strong>Address:</strong> ${data.buyer_address}</p>
            </div>
          </div>
        `;
      
      
case 'itemsTable':
        return `
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: ${fontSize - 1}px;">
            <thead>
              <tr style="background-color: ${primaryColor}; color: white;">
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 50%;">Item Description</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 10%;">Qty</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 15%;">Unit</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; width: 12.5%;">Unit Price</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; width: 12.5%;">Total</th>
              </tr>
            </thead>
            <tbody>
              ${data.items.map(item => `
                <tr>
                  <td style="border: 1px solid #ddd; padding: 6px;">${item.description}</td>
                  <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${item.qty}</td>
                  <td style="border: 1px solid #ddd; padding: 6px;">${item.unit}</td>
                  <td style="border: 1px solid #ddd; padding: 6px; text-align: right;">â‚±${item.price}</td>
                  <td style="border: 1px solid #ddd; padding: 6px; text-align: right; font-weight: bold;">â‚±${item.total}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      
case 'totals':
        const position = layout.sections.totals?.position || 'right';
        return `
          <div style="width: 280px; ${position === 'right' ? 'margin-left: auto;' : ''} margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; padding: 6px 10px; border-bottom: 1px solid #ddd; font-size: ${fontSize}px;">
              <span>Subtotal:</span>
              <span>â‚±${data.subtotal}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 6px 10px; border-bottom: 1px solid #ddd; font-size: ${fontSize}px;">
              <span>VAT (${data.vat_percentage}%):</span>
              <span>â‚±${data.tax}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px; background-color: ${primaryColor}; color: white; font-weight: bold; font-size: ${fontSize + 2}px; border-radius: 4px; margin-top: 3px;">
              <span>Grand Total:</span>
              <span>â‚±${data.grand_total}</span>
            </div>
          </div>
          <div style="clear: both;"></div>
        `;
      
      
case 'signature':
        const sigCols = layout.sections.signature?.columns || 2;
        return `
          <div style="display: ${sigCols === 2 ? 'grid' : 'flex'}; ${sigCols === 2 ? 'grid-template-columns: 1fr 1fr;' : 'flex-direction: column; align-items: center;'} gap: 30px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
            <div style="text-align: center;">
              <div style="height: 60px; display: flex; align-items: flex-end; justify-content: center;">
                <div style="width: 180px; border-bottom: 1px solid #333;"></div>
              </div>
              <p style="font-size: ${fontSize - 2}px; color: #666; margin: 5px 0 0 0;">Customer Signature</p>
            </div>
            <div style="text-align: center;">
              ${data.signature_url ? `
                <div style="height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                  <img src="${data.signature_url}" alt="Signature" style="max-width: 150px; max-height: 50px; object-fit: contain; display: block; margin-bottom: 5px;" />
                  <div style="width: 180px; border-bottom: 1px solid #333;"></div>
                </div>
              ` : `
                <div style="height: 60px; display: flex; align-items: flex-end; justify-content: center;">
                  <div style="width: 180px; border-bottom: 1px solid #333;"></div>
                </div>
              `}
              <p style="font-weight: bold; color: ${primaryColor}; font-size: ${fontSize - 1}px; margin: 5px 0 2px 0;">${data.signed_by || 'Authorized Signatory'}</p>
              <p style="font-size: ${fontSize - 2}px; color: #666; margin: 0;">Company Representative</p>
            </div>
          </div>
        `;
      
case 'footer':
  return layout.sections.footer?.visible ? `
    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center;">
      <p style="margin: 0 0 10px 0; font-size: ${fontSize + 2}px; font-weight: bold; color: ${primaryColor};">Thank you for your business!</p>
      <p style="margin: 0 0 5px 0; font-size: ${fontSize - 2}px; color: #666;">This is a computer-generated invoice.</p>
      <p style="margin: 0; font-size: ${fontSize - 3}px; color: #999;">Generated on: ${new Date().toLocaleString()}</p>
    </div>
  ` : '';


case 'terms':
        return `
          ${data.terms_and_conditions ? `
            <div style="margin-top: 20px; padding: 12px; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb;">
              <p style="margin: 0 0 8px 0; font-size: ${fontSize}px; font-weight: bold; color: ${primaryColor};">Terms and Conditions</p>
              <p style="margin: 0; font-size: ${fontSize - 2}px; color: #555; line-height: 1.5; white-space: pre-line;">${data.terms_and_conditions}</p>
            </div>
          ` : ''}

          ${data.special_instructions ? `
            <div style="margin-top: 15px; padding: 12px; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb;">
              <p style="margin: 0 0 8px 0; font-size: ${fontSize}px; font-weight: bold; color: #28a745;">Special Instructions</p>
              <p style="margin: 0; font-size: ${fontSize - 2}px; color: #555; line-height: 1.5; white-space: pre-line;">${data.special_instructions}</p>
            </div>
          ` : ''}
        `;

case 'paymentMethod':
        return layout.sections.paymentMethod?.visible ? `
          <div style="margin-top: 25px; padding: 12px; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb;">
            <p style="margin: 0; font-size: ${fontSize}px;">
              <span style="font-weight: bold; color: ${primaryColor};">Payment Method: </span>
              <span style="font-weight: 600;">${data.payment_method || 'Cash'}</span>
            </p>
          </div>
        ` : '';
      
      
      default:
        return '';
    }
  };

  // Generate sections HTML
  const sectionsHTML = sections.map(sectionKey => buildSectionHTML(sectionKey)).join('\n');

  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Invoice - ${data.invoice_number}</title>
<style>
  @page {
    size: A4;
    margin: 10mm;
  }
  
  body { 
    font-family: '${fontFamily}', sans-serif; 
    margin: 0;
    padding: 15px;
    color: #333;
    font-size: ${fontSize}px;
    line-height: 1.3;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
    font-size: ${fontSize - 1}px;
  }
  
  th, td {
    border: 1px solid #ddd;
    padding: 6px 8px;
    text-align: left;
  }
  
  th {
    background-color: ${primaryColor};
    color: white;
    font-weight: bold;
    font-size: ${fontSize - 1}px;
  }
  
  tbody tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  
  @media print {
    body { 
      margin: 0;
      padding: 10px;
    }
    .no-print { 
      display: none;
    }
  }
  
  .print-button {
    margin: 15px 0;
    padding: 10px 20px;
    background: ${primaryColor};
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
  }
  
  .print-button:hover {
    background: ${secondaryColor};
  }
</style>
    </head>
    <body>
      ${sectionsHTML}

      <button class="print-button no-print" onclick="window.print()">Print Invoice</button>
    </body>
    </html>
  `;
};









  const handleLogout = async () => {
    try {
      const auth = firebase.auth();
      await auth.signOut();
      window.location.href = 'login.html';
    } catch (error) {
      console.error('Logout error:', error);
    }
  };

  // Get unique categories
  const categories = [...new Set(products.map(p => p.category).filter(Boolean))];

  // Filter products
  const filteredProducts = products.filter(product => {
    const matchesSearch = product.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                         product.sku.toLowerCase().includes(searchQuery.toLowerCase());
    const matchesCategory = categoryFilter === 'all' || product.category === categoryFilter;
    
    let matchesStock = true;
    if (stockFilter === 'out-of-stock') {
      matchesStock = product.stock === 0;
    } else if (stockFilter === 'low-stock') {
      matchesStock = product.stock > 0 && product.stock <= product.threshold;
    } else if (stockFilter === 'in-stock') {
      matchesStock = product.stock > product.threshold;
    }
    
    return matchesSearch && matchesCategory && matchesStock;
  });


// Filter orders for My Orders section
const filteredOrders = orders.filter(order => {
  const matchesSearch = order.orderNumber.toLowerCase().includes(orderSearchQuery.toLowerCase()) ||
                       order.customerName.toLowerCase().includes(orderSearchQuery.toLowerCase());
  
  const matchesStatus = orderStatusFilter === 'all' || order.status === orderStatusFilter;
  
  let matchesDateRange = true;
  if (orderDateRange.start && order.createdAt) {
    const orderDate = order.createdAt.toDate();
    const startDate = new Date(orderDateRange.start);
    startDate.setHours(0, 0, 0, 0);
    matchesDateRange = orderDate >= startDate;
  }
  if (orderDateRange.end && order.createdAt) {
    const orderDate = order.createdAt.toDate();
    const endDate = new Date(orderDateRange.end);
    endDate.setHours(23, 59, 59, 999);
    matchesDateRange = matchesDateRange && orderDate <= endDate;
  }
  
  return matchesSearch && matchesStatus && matchesDateRange;
});







const modules = userRole === 'admin' 
  ? [
      { id: 'dashboard', name: 'Dashboard', icon: TrendingUp, color: 'from-purple-500 to-pink-500' },
      { id: 'inventory', name: 'Inventory', icon: Package, color: 'from-blue-500 to-cyan-500' },
      { id: 'orders', name: 'Orders', icon: ShoppingCart, color: 'from-orange-500 to-yellow-500' },
      { id: 'suppliers', name: 'Suppliers', icon: Users, color: 'from-teal-500 to-green-500' },
      { id: 'reports', name: 'Reports', icon: BarChart, color: 'from-green-500 to-emerald-500' },
      { id: 'settings', name: 'Settings', icon: Settings, color: 'from-gray-500 to-slate-500' },
    ]
  : [
      { id: 'dashboard', name: 'Dashboard', icon: TrendingUp, color: 'from-purple-500 to-pink-500' },
      { id: 'create-order', name: 'Create Order', icon: ShoppingCart, color: 'from-orange-500 to-yellow-500' },
      { id: 'my-orders', name: 'My Orders', icon: FileText, color: 'from-green-500 to-emerald-500' },
      { id: 'settings', name: 'Settings', icon: Settings, color: 'from-gray-500 to-slate-500' },
    ];

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 via-white to-pink-50 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-gray-600 font-medium">Loading Operix...</p>
        </div>
      </div>
    );
  }

return (
  <div className="min-h-screen bg-gradient-to-br from-purple-50 via-white to-pink-50">
    {/* No Admin Assigned Overlay */}
    {userRole !== 'admin' && !user?.assignedAdminId && (
      <div className="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-md flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md text-center">
          <div className="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <Users className="w-10 h-10 text-yellow-600" />
          </div>
          <h2 className="text-2xl font-bold text-gray-800 mb-4">Account Pending Setup</h2>
          <p className="text-gray-600 mb-6">
            Your account hasn't been assigned to an administrator yet. 
            Please wait for the master administrator to assign you to an admin. 
            You'll be able to access all features once the assignment is complete.
          </p>
          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <p className="text-yellow-800 text-sm">
              <strong>Contact Support:</strong> If this takes longer than expected, 
              please contact your system administrator.
            </p>
          </div>
          <button
            onClick={handleLogout}
            className="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all flex items-center gap-2 mx-auto"
          >
            <LogOut />
            Logout
          </button>
        </div>
      </div>
    )}
    
    {/* Sidebar */}
    <aside className={`fixed left-0 top-0 h-full bg-white shadow-2xl transition-all duration-300 z-40 ${sidebarOpen ? 'w-64' : 'w-20'}`}>
        <div className="p-6 flex items-center justify-between border-b border-gray-100">
          {sidebarOpen ? (
            <div className="flex items-center gap-3">
              <OperixLogo size="small" />
              <span className="font-bold text-xl bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Operix</span>
            </div>
          ) : (
            <div className="mx-auto">
              <OperixLogo size="small" />
            </div>
          )}
        </div>

        <nav className="p-4 space-y-2">
          {modules.map((module) => {
            const Icon = module.icon;
            return (
              <button
                key={module.id}
                onClick={() => setActiveModule(module.id)}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${
                  activeModule === module.id
                    ? `bg-gradient-to-r ${module.color} text-white shadow-lg transform scale-105`
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
              >
                <Icon />
                {sidebarOpen && <span className="font-medium">{module.name}</span>}
              </button>
            );
          })}
        </nav>

        <button
          onClick={() => setSidebarOpen(!sidebarOpen)}
          className="absolute -right-3 top-20 w-6 h-6 bg-white rounded-full shadow-lg flex items-center justify-center border border-gray-200 hover:scale-110 transition-transform"
        >
          {sidebarOpen ? <X /> : <Menu />}
        </button>
      </aside>
{/* Main Content */}
      <div className={`transition-all duration-300 ${sidebarOpen ? 'ml-64' : 'ml-20'}`}>
        {/* Header */}
        <header className="bg-white shadow-sm border-b border-gray-100 sticky top-0 z-30">
          <div className="px-8 py-4 flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-gray-800">
                {modules.find(m => m.id === activeModule)?.name || 'Dashboard'}
              </h1>
              <p className="text-sm text-gray-500 mt-1">
                Welcome back, {user?.displayName || 'User'} 
                <span className="ml-2 px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold">
                  {userRole === 'admin' ? 'Admin' : 'User'}
                </span>
              </p>
            </div>

            <div className="flex items-center gap-4">
              <div className="relative">
                <button 
                  onClick={() => setShowNotificationDropdown(!showNotificationDropdown)}
                  className="relative p-2 hover:bg-gray-100 rounded-lg transition-colors"
                >
                  <Bell />
                  {notifications.filter(n => !n.read).length > 0 && (
                    <span className="absolute top-1 right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs flex items-center justify-center font-bold">
                      {notifications.filter(n => !n.read).length}
                    </span>
                  )}
                </button>
                
                {showNotificationDropdown && (
                  <div className="absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-50 max-h-[500px] overflow-hidden">
                    <div className="p-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-purple-50 to-pink-50">
                      <h3 className="font-semibold text-gray-800">Notifications</h3>
                      {notifications.filter(n => !n.read).length > 0 && (
                        <button
                          onClick={markAllAsRead}
                          className="text-xs text-purple-600 hover:text-purple-800"
                        >
                          Mark all as read
                        </button>
                      )}
                    </div>
                    
                    <div className="overflow-y-auto max-h-[400px]">
                      {notifications.length > 0 ? (
                        notifications.map(notif => (
                          <div
  key={notif.id}
  onClick={(e) => {
    if (!notif.read) {
      markNotificationAsRead(notif.id);
    }
  }}
  className={`p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors ${
    !notif.read ? 'bg-purple-50' : ''
  }`}
>
                            <div className="flex items-start gap-3">
                              <div className={`w-2 h-2 rounded-full mt-2 ${!notif.read ? 'bg-purple-600' : 'bg-gray-300'}`}></div>
                              <div className="flex-1">
                                <div className="flex items-center justify-between mb-1">
                                  <span className={`text-xs px-2 py-1 rounded-full ${
                                    notif.type === 'order' ? 'bg-green-100 text-green-700' :
                                    notif.type === 'stock-alert' ? 'bg-red-100 text-red-700' :
                                    notif.type === 'product-edit' ? 'bg-blue-100 text-blue-700' :
                                    'bg-yellow-100 text-yellow-700'
                                  }`}>
                                    {notif.type === 'order' ? 'ðŸ›’ Order' :
                                     notif.type === 'stock-alert' ? 'âš ï¸ Stock Alert' :
                                     notif.type === 'product-edit' ? 'ðŸ“¦ Product' :
                                     'ðŸ”„ Status Update'}
                                  </span>
                                  <span className="text-xs text-gray-500">{notif.timeAgo}</span>
                                </div>
                                <p className="text-sm font-medium text-gray-800 mb-1">{notif.message}</p>
                                {notif.details && (
                                  <div className="text-xs text-gray-600 space-y-1">
                                    {notif.details.orderNumber && <p>Order: {notif.details.orderNumber}</p>}
                                    {notif.details.customerName && <p>Customer: {notif.details.customerName}</p>}
                                    {notif.details.totalAmount && <p>Amount: ${notif.details.totalAmount.toFixed(2)}</p>}
                                    {notif.details.stock !== undefined && <p>Stock: {notif.details.stock} units</p>}
                                    {notif.details.productName && <p>Product: {notif.details.productName}</p>}
                                    {notif.details.changes && <p>Changes: {notif.details.changes}</p>}
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        ))
                      ) : (
                        <div className="p-8 text-center text-gray-500">
                          <Bell className="w-12 h-12 mx-auto mb-2 text-gray-300" />
                          <p>No notifications yet</p>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>

              <div className="relative">
                <button
                  onClick={() => setShowUserMenu(!showUserMenu)}
                  className="flex items-center gap-2 p-2 hover:bg-gray-100 rounded-lg transition-colors"
                >
                  <div className="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                    {user?.displayName?.charAt(0) || 'U'}
                  </div>
                  <ChevronDown />
                </button>

                {showUserMenu && (
                  <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-100 py-2">
                    <div className="px-4 py-2 border-b border-gray-100">
                      <p className="text-sm font-medium text-gray-700">{user?.displayName}</p>
                      <p className="text-xs text-gray-500">{user?.email}</p>
                    </div>
                    <button
                      onClick={handleLogout}
                      className="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-gray-700"
                    >
                      <LogOut /> Log Out
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        </header>

        {/* Main Content Area */}
        <main className="p-8">
          {/* Dashboard Module */}
          {activeModule === 'dashboard' && (
            <div className="space-y-6">
              {/* Stats Cards */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-gray-500 text-sm font-medium">Total Products</p>
                      <h2 className="text-3xl font-bold text-gray-800 mt-2">{stats.totalProducts}</h2>
                    </div>
                    <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                      <Package className="w-6 h-6 text-purple-600" />
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-gray-500 text-sm font-medium">Out of Stock</p>
                      <h2 className="text-3xl font-bold text-gray-800 mt-2">{stats.outOfStock}</h2>
                    </div>
                    <div className="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                      <XCircle className="w-6 h-6 text-red-600" />
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-gray-500 text-sm font-medium">Low Stock Items</p>
                      <h2 className="text-3xl font-bold text-gray-800 mt-2">{stats.lowStock}</h2>
                    </div>
                    <div className="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                      <AlertTriangle className="w-6 h-6 text-yellow-600" />
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-gray-500 text-sm font-medium">Pending Orders</p>
                      <h2 className="text-3xl font-bold text-gray-800 mt-2">{stats.pendingOrders}</h2>
                    </div>
                    <div className="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                      <ShoppingCart className="w-6 h-6 text-orange-600" />
                    </div>
                  </div>
                </div>
              </div>

              {/* Additional Stats Row */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-gray-500 text-sm font-medium">Today's Sales</p>
                      <h2 className="text-3xl font-bold text-gray-800 mt-2">${stats.todaySales.toFixed(2)}</h2>
                    </div>
                    <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                      <DollarSign className="w-6 h-6 text-green-600" />
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-gray-500 text-sm font-medium">Completed Orders</p>
                      <h2 className="text-3xl font-bold text-gray-800 mt-2">{stats.completedOrders}</h2>
                    </div>
                    <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                      <ShoppingCart className="w-6 h-6 text-blue-600" />
                    </div>
                  </div>
                </div>
              </div>

              {/* Recent Orders & Stock Alerts */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Recent Orders */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <ShoppingCart className="w-5 h-5 text-orange-500" />
                    Recent Orders
                  </h3>
                  <div className="space-y-3">
                    {recentOrders.length > 0 ? (
                      recentOrders.map(order => (
                        <div key={order.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div>
                            <p className="font-medium text-gray-800">{order.orderNumber}</p>
                            <p className="text-sm text-gray-500">{order.customerName}</p>
                          </div>
                          <div className="text-right">
                            <p className="font-semibold text-gray-800">${order.totalAmount.toFixed(2)}</p>
                            <span className={`text-xs px-2 py-1 rounded-full ${
                              order.status === 'completed' ? 'bg-green-100 text-green-700' :
                              order.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                              order.status === 'processing' ? 'bg-blue-100 text-blue-700' :
                              'bg-gray-100 text-gray-700'
                            }`}>
                              {order.status}
                            </span>
                          </div>
                        </div>
                      ))
                    ) : (
                      <p className="text-gray-500 text-center py-4">No recent orders</p>
                    )}
                  </div>
                </div>

                {/* Stock Alerts */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <AlertTriangle className="w-5 h-5 text-yellow-500" />
                    Stock Alerts
                  </h3>
                  <div className="space-y-3 max-h-96 overflow-y-auto">
                    {/* Out of Stock Items */}
                    {outOfStockItems.length > 0 && (
                      <div>
                        <p className="text-xs font-semibold text-red-600 mb-2">OUT OF STOCK</p>
                        {outOfStockItems.map(item => (
                          <div key={item.id} className="flex items-center justify-between p-3 bg-red-50 rounded-lg border-l-4 border-red-500 mb-2">
                            <div>
                              <p className="font-medium text-gray-800">{item.name}</p>
                              <p className="text-sm text-gray-500">{item.sku}</p>
                            </div>
                            <div className="text-right">
                              <p className="font-semibold text-red-700 flex items-center gap-1">
                                <XCircle className="w-4 h-4" />
                                0 {item.unit}
                              </p>
                              <p className="text-xs text-gray-500">Restock needed!</p>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                    
                    {/* Low Stock Items */}
                    {lowStockItems.length > 0 && (
                      <div>
                        <p className="text-xs font-semibold text-yellow-600 mb-2 mt-4">LOW STOCK</p>
                        {lowStockItems.map(item => (
                          <div key={item.id} className="flex items-center justify-between p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-500 mb-2">
                            <div>
                              <p className="font-medium text-gray-800">{item.name}</p>
                              <p className="text-sm text-gray-500">{item.sku}</p>
                            </div>
                            <div className="text-right">
                              <p className="font-semibold text-yellow-700">{item.stock} {item.unit}</p>
                              <p className="text-xs text-gray-500">Threshold: {item.threshold}</p>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                    
                    {outOfStockItems.length === 0 && lowStockItems.length === 0 && (
                      <p className="text-gray-500 text-center py-4">All stock levels are good!</p>
                    )}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Inventory Module (Admin Only) */}
{/* Inventory Module (Admin Only) - TABLE VIEW */}
{activeModule === 'inventory' && userRole === 'admin' && (
  <div className="space-y-6">
    {/* Controls */}
    <div className="bg-white rounded-xl shadow-lg p-6">
      <div className="flex flex-col gap-4">
        {/* Search and Filters */}
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div className="flex-1 flex gap-4">
            <input
              type="text"
              placeholder="Search products..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
            />
            <select
              value={categoryFilter}
              onChange={(e) => setCategoryFilter(e.target.value)}
              className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
            >
              <option value="all">All Categories</option>
              {categories.map(cat => (
                <option key={cat} value={cat}>{cat}</option>
              ))}
            </select>
          </div>
          <button
            onClick={() => { setShowAddProduct(true); resetProductForm(); setEditingProduct(null); }}
            className="flex items-center gap-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all"
          >
            <Plus /> Add Product
          </button>
        </div>

        {/* Stock Filter Tabs */}
        <div className="flex gap-2 border-b border-gray-200">
          <button
            onClick={() => setStockFilter('all')}
            className={`px-4 py-2 font-medium transition-all ${
              stockFilter === 'all'
                ? 'text-purple-600 border-b-2 border-purple-600'
                : 'text-gray-500 hover:text-gray-700'
            }`}
          >
            All Products ({products.length})
          </button>
          <button
            onClick={() => setStockFilter('in-stock')}
            className={`px-4 py-2 font-medium transition-all ${
              stockFilter === 'in-stock'
                ? 'text-green-600 border-b-2 border-green-600'
                : 'text-gray-500 hover:text-gray-700'
            }`}
          >
            In Stock ({products.filter(p => p.stock > p.threshold).length})
          </button>
          <button
            onClick={() => setStockFilter('low-stock')}
            className={`px-4 py-2 font-medium transition-all ${
              stockFilter === 'low-stock'
                ? 'text-yellow-600 border-b-2 border-yellow-600'
                : 'text-gray-500 hover:text-gray-700'
            }`}
          >
            Low Stock ({stats.lowStock})
          </button>
          <button
            onClick={() => setStockFilter('out-of-stock')}
            className={`px-4 py-2 font-medium transition-all ${
              stockFilter === 'out-of-stock'
                ? 'text-red-600 border-b-2 border-red-600'
                : 'text-gray-500 hover:text-gray-700'
            }`}
          >
            Out of Stock ({stats.outOfStock})
          </button>
        </div>
      </div>
    </div>

    {/* Products Table */}
    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
      <div className="overflow-x-auto">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Image</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MOQ</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lead Time</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {filteredProducts.map(product => {
              const isOutOfStock = product.stock === 0;
              const isLowStock = product.stock > 0 && product.stock <= product.threshold;
              
              return (
                <tr key={product.id} className="hover:bg-gray-50">
                  {/* Image */}
                  <td className="px-4 py-4">
                    {product.imageUrl ? (
                      <img 
                        src={product.imageUrl} 
                        alt={product.name} 
                        className={`w-12 h-12 object-cover rounded-lg ${isOutOfStock ? 'grayscale' : ''}`}
                      />
                    ) : (
                      <div className={`w-12 h-12 rounded-lg flex items-center justify-center ${
                        isOutOfStock ? 'bg-red-100' : isLowStock ? 'bg-yellow-100' : 'bg-purple-100'
                      }`}>
                        <Package className={`w-6 h-6 ${
                          isOutOfStock ? 'text-red-400' : isLowStock ? 'text-yellow-400' : 'text-purple-400'
                        }`} />
                      </div>
                    )}
                  </td>
                  
                  {/* Product Name */}
                  <td className="px-6 py-4">
                    <div className="text-sm font-medium text-gray-900">{product.name}</div>
                    {product.description && (
                      <div className="text-xs text-gray-500 truncate max-w-xs">{product.description}</div>
                    )}
                  </td>
                  
                  {/* SKU */}
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-mono">{product.sku}</td>
                  
                  {/* Category */}
                  <td className="px-6 py-4 whitespace-nowrap">
                    {product.category && (
                      <span className="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-700">
                        {product.category}
                      </span>
                    )}
                  </td>
                  
                  {/* Price */}
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                    ${product.price.toFixed(2)}
                  </td>
                  
                  {/* Stock */}
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm font-semibold text-gray-900">{product.stock} {product.unit}</div>
                    <div className="text-xs text-gray-500">Threshold: {product.threshold}</div>
                  </td>
                  
                  {/* MOQ */}
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                    {product.moq || 'N/A'}
                  </td>
                  
                  {/* Lead Time */}
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                    {product.leadTime ? `${product.leadTime} days` : 'N/A'}
                  </td>
                  
                  {/* Supplier */}
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                    {product.supplier || 'N/A'}
                  </td>
                  
                  {/* Status */}
                  <td className="px-6 py-4 whitespace-nowrap">
                    {isOutOfStock ? (
                      <span className="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-700 flex items-center gap-1 w-fit">
                        <XCircle className="w-3 h-3" />
                        Out of Stock
                      </span>
                    ) : isLowStock ? (
                      <span className="px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-700 flex items-center gap-1 w-fit">
                        <AlertTriangle className="w-3 h-3" />
                        Low Stock
                      </span>
                    ) : (
                      <span className="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700 w-fit">
                        In Stock
                      </span>
                    )}
                  </td>
                  
                  {/* Actions */}
                  <td className="px-6 py-4 whitespace-nowrap text-sm">
                    <div className="flex gap-2">
                      <button
                        onClick={() => {
                          setEditingProduct(product);
                          setShowAddProduct(true);
                          setProductForm(product);
                        }}
                        className="text-blue-600 hover:text-blue-800"
                        title="Edit"
                      >
                        <Edit />
                      </button>
                      <button
                        onClick={() => deleteProduct(product.id)}
                        className="text-red-600 hover:text-red-800"
                        title="Delete"
                      >
                        <Trash />
                      </button>
                    </div>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {filteredProducts.length === 0 && (
        <div className="text-center py-12">
          <Package className="w-16 h-16 text-gray-300 mx-auto mb-4" />
          <p className="text-gray-500">No products found</p>
        </div>
      )}
    </div>
  </div>
)}



{/* Suppliers Module (Admin Only) */}
{activeModule === 'suppliers' && userRole === 'admin' && (
  <div className="space-y-6">
    <div className="flex justify-between items-center">
      <h2 className="text-xl font-semibold">Supplier Management</h2>
      <div className="flex gap-3">
        <button
          onClick={() => setShowSupplierSettings(true)}
          className="flex items-center gap-2 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-all"
        >
          <Settings className="w-4 h-4" /> Settings
        </button>
        <button
          onClick={() => { setShowAddSupplier(true); resetSupplierForm(); setEditingSupplier(null); }}
          className="flex items-center gap-2 bg-gradient-to-r from-teal-500 to-green-500 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all"
        >
          <Plus /> Add Supplier
        </button>
      </div>
    </div>

    {/* Suppliers Table */}
    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
      <div className="overflow-x-auto">
        <table className="min-w-full divide-y divide-gray-200">
<thead className="bg-gray-50">
  <tr>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier Code</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact Person</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Terms</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Currency</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shipment Mode</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completion</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
  </tr>
</thead>
          <tbody className="bg-white divide-y divide-gray-200">
{suppliers.map(supplier => {
  const completion = calculateSupplierCompletion(supplier);
  return (
              <tr key={supplier.id} className="hover:bg-gray-50">
                <td className="px-6 py-4 whitespace-nowrap font-mono text-sm font-semibold text-gray-900">
                  {supplier.supplierCode}
                </td>
<td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
  <a href={'supplier-setup.html?id=' + supplier.id} className="text-blue-600 hover:text-blue-800 hover:no-underline transition-colors">{supplier.name}</a>
</td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                  {supplier.contactPerson}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                  {supplier.email}
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                  <span className="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-700">
                    {supplier.paymentTerms}
                  </span>
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                  {supplier.currency}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                  {supplier.modeOfShipment}
                </td>

<td className="px-6 py-4 whitespace-nowrap">
  <div className="flex items-center gap-2">
    <div className="flex-1 bg-gray-200 rounded-full h-2 max-w-[100px]">
      <div className={'h-2 rounded-full transition-all ' + (completion.percentage === 100 ? 'bg-green-500' : completion.percentage >= 70 ? 'bg-blue-500' : completion.percentage >= 40 ? 'bg-yellow-500' : 'bg-red-500')} style={{ width: completion.percentage + '%' }}></div>
    </div>
    <span className={'text-xs font-semibold ' + (completion.percentage === 100 ? 'text-green-600' : completion.percentage >= 70 ? 'text-blue-600' : completion.percentage >= 40 ? 'text-yellow-600' : 'text-red-600')}>{completion.percentage}%</span>
  </div>
  <p className="text-xs text-gray-500 mt-1">{completion.filledFields}/{completion.totalFields} fields</p>
</td>



                <td className="px-6 py-4 whitespace-nowrap text-sm">
                  <div className="flex gap-2">
                    <button
                      onClick={() => {
                        setEditingSupplier(supplier);
                        setShowAddSupplier(true);
                        setSupplierForm(supplier);
                      }}
                      className="text-blue-600 hover:text-blue-800"
                      title="Edit"
                    >
                      <Edit />
                    </button>
                    <button
                      onClick={() => deleteSupplier(supplier.id)}
                      className="text-red-600 hover:text-red-800"
                      title="Delete"
                    >
                      <Trash />
                    </button>
                  </div>
                </td>
              </tr>
);
          })}
          </tbody>
        </table>
      </div>

      {suppliers.length === 0 && (
        <div className="text-center py-12">
          <Users className="w-16 h-16 text-gray-300 mx-auto mb-4" />
          <p className="text-gray-500">No suppliers yet. Add your first supplier to get started.</p>
        </div>
      )}
    </div>
  </div>
)}










{/* Orders Module (Admin) */}
{activeModule === 'orders' && userRole === 'admin' && (
  <div className="space-y-6">
    <div className="flex justify-between items-center">
      <h2 className="text-xl font-semibold">All Orders</h2>
      <button
        onClick={() => setShowCreateOrder(true)}
        className="flex items-center gap-2 bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all"
      >
        <Plus /> New Order
      </button>
    </div>

    {/* Filters */}
    <div className="bg-white rounded-xl shadow-lg p-6">
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="md:col-span-2">
          <label className="block text-sm font-medium text-gray-700 mb-2">Search Orders</label>
          <input
            type="text"
            placeholder="Search by order number or customer name..."
            value={orderSearchQuery}
            onChange={(e) => setOrderSearchQuery(e.target.value)}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Status</label>
          <select
            value={orderStatusFilter}
            onChange={(e) => setOrderStatusFilter(e.target.value)}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
          >
            <option value="all">All Status</option>
            <option value="pending">Pending</option>
            <option value="processing">Processing</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
          <div className="flex gap-2">
            <input
              type="date"
              value={orderDateRange.start}
              onChange={(e) => setOrderDateRange({...orderDateRange, start: e.target.value})}
              className="flex-1 px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none text-sm"
            />
            <input
              type="date"
              value={orderDateRange.end}
              onChange={(e) => setOrderDateRange({...orderDateRange, end: e.target.value})}
              className="flex-1 px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none text-sm"
            />
          </div>
        </div>
      </div>
      
      {(orderSearchQuery || orderStatusFilter !== 'all' || orderDateRange.start || orderDateRange.end) && (
        <div className="mt-4 flex items-center justify-between">
          <p className="text-sm text-gray-600">
            Showing {filteredOrders.length} of {orders.length} orders
          </p>
          <button
            onClick={() => {
              setOrderSearchQuery('');
              setOrderStatusFilter('all');
              setOrderDateRange({ start: '', end: '' });
            }}
            className="text-sm text-purple-600 hover:text-purple-800 font-medium"
          >
            Clear Filters
          </button>
        </div>
      )}
    </div>

    		<div className="bg-white rounded-xl shadow-lg overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order #</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {filteredOrders.map(order => (
                        <tr key={order.id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900">{order.orderNumber}</td>
                          <td className="px-6 py-4">
                            <div className="text-sm">
                              <div className="font-medium text-gray-900">{order.customerName}</div>
                              <div className="text-gray-500">{order.customerEmail}</div>
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {order.items?.length || 0} items
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                            ${order.totalAmount.toFixed(2)}
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                              order.status === 'completed' ? 'bg-green-100 text-green-800' :
                              order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                              order.status === 'processing' ? 'bg-blue-100 text-blue-800' :
                              'bg-red-100 text-red-800'
                            }`}>
                              {order.status}
                            </span>
                          </td>
<td className="px-6 py-4 whitespace-nowrap text-sm">
  <div className="flex gap-2">
    <button
      onClick={() => {
        setSelectedOrder(order);
        setShowOrderDetails(true);
      }}
      className="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors text-xs font-medium"
    >
      View
    </button>
    
    {order.status === 'pending' && (
      <button
        onClick={() => updateOrderStatus(order.id, 'processing')}
        className="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-xs font-medium"
      >
        Process
      </button>
    )}
    
    {(order.status === 'pending' || order.status === 'processing') && (
      <button
        onClick={() => updateOrderStatus(order.id, 'completed')}
        className="px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-xs font-medium"
      >
        Complete
      </button>
    )}
    
    {order.status !== 'cancelled' && order.status !== 'completed' && (
<button
        onClick={() => {
          if (confirm('Are you sure you want to cancel this order? Stock will be returned.')) {
            updateOrderStatus(order.id, 'cancelled');
          }
        }}
        className="px-3 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-xs font-medium"
      >
        Cancel
      </button>
    )}
    
<button
  onClick={() => generateInvoicePDF(order)}
  className={`px-3 py-1 rounded-lg transition-colors text-xs font-medium flex items-center gap-1 ${
    order.invoiceData 
      ? 'bg-green-100 text-green-700 hover:bg-green-200' 
      : 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200'
  }`}
  title={order.invoiceData ? 'View Saved Invoice' : 'Generate Invoice'}
>
  <FileText className="w-3 h-3" />
  {order.invoiceData ? 'View Invoice' : 'Invoice'}
</button>
  </div>
</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                {orders.length === 0 && (
                  <div className="text-center py-12">
                    <ShoppingCart className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                    <p className="text-gray-500">No orders yet</p>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Create Order Module (Regular Users) */}
          {(activeModule === 'create-order' || (activeModule === 'orders' && userRole !== 'admin')) && (
            <div className="space-y-6">
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-xl font-semibold mb-4">Create New Order</h2>
                
                {/* Search Products */}
                <div className="mb-6">
                  <input
                    type="text"
                    placeholder="Search products to add..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                  />
                </div>

                {/* Available Products */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                  {products
                    .filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()) && p.stock > 0)
                    .map(product => (
                      <div key={product.id} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div className="flex items-start gap-3">
                          {product.imageUrl ? (
                            <img src={product.imageUrl} alt={product.name} className="w-16 h-16 object-cover rounded-lg" />
                          ) : (
                            <div className="w-16 h-16 bg-gradient-to-br from-purple-100 to-pink-100 rounded-lg flex items-center justify-center">
                              <Package className="w-8 h-8 text-gray-400" />
                            </div>
                          )}
                          <div className="flex-1">
                            <h3 className="font-medium text-gray-800">{product.name}</h3>
                            <p className="text-sm text-gray-500">{product.sku}</p>
                            <p className="text-lg font-semibold text-purple-600 mt-1">${product.price.toFixed(2)}</p>
                            <p className="text-xs text-gray-500">Stock: {product.stock} {product.unit}</p>
                            <button
                              onClick={() => addToCart(product)}
                              disabled={product.stock === 0}
                              className="mt-2 w-full px-3 py-1 bg-purple-500 text-white rounded-lg hover:bg-purple-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm"
                            >
                              Add to Cart
                            </button>
                          </div>
                        </div>
                      </div>
                    ))}
                </div>

                {/* Cart */}
                {cart.length > 0 && (
                  <div className="border-t border-gray-200 pt-6">
                    <h3 className="text-lg font-semibold mb-4">Cart ({cart.length} items)</h3>
                    <div className="space-y-3 mb-4">
                      {cart.map(item => (
                        <div key={item.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div className="flex-1">
                            <p className="font-medium text-gray-800">{item.name}</p>
                            <p className="text-sm text-gray-500">${item.price.toFixed(2)} per {item.unit}</p>
                          </div>
                          <div className="flex items-center gap-3">
                            <input
                              type="number"
                              min="1"
                              max={item.stock}
                              value={item.quantity}
                              onChange={(e) => updateCartQuantity(item.id, parseInt(e.target.value) || 1)}
                              className="w-20 px-2 py-1 border border-gray-300 rounded-lg text-center"
                            />
                            <span className="font-semibold text-gray-800 w-24 text-right">
                              ${(item.price * item.quantity).toFixed(2)}
                            </span>
                            <button
                              onClick={() => removeFromCart(item.id)}
                              className="text-red-500 hover:text-red-700"
                            >
                              <Trash />
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                    
                    <div className="flex justify-between items-center text-xl font-bold text-gray-800 mb-6 p-4 bg-purple-50 rounded-lg">
                      <span>Total:</span>
                      <span>${calculateTotal().toFixed(2)}</span>
                    </div>

                    {/* Customer Details */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <input
                        type="text"
                        placeholder="Customer Name *"
                        value={orderForm.customerName}
                        onChange={(e) => setOrderForm({...orderForm, customerName: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                      />
                      <input
                        type="email"
                        placeholder="Customer Email *"
                        value={orderForm.customerEmail}
                        onChange={(e) => setOrderForm({...orderForm, customerEmail: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                      />
                      <input
                        type="tel"
                        placeholder="Customer Phone"
                        value={orderForm.customerPhone}
                        onChange={(e) => setOrderForm({...orderForm, customerPhone: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                      />
                      <select
                        value={orderForm.paymentMethod}
                        onChange={(e) => setOrderForm({...orderForm, paymentMethod: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                      >
                        <option value="Cash">Cash</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                      </select>
                    </div>
                    <input
                      type="text"
                      placeholder="Delivery Address *"
                      value={orderForm.deliveryAddress}
                      onChange={(e) => setOrderForm({...orderForm, deliveryAddress: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none mb-4"
                    />
                    <textarea
                      placeholder="Notes / Special Instructions"
                      value={orderForm.notes}
                      onChange={(e) => setOrderForm({...orderForm, notes: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none mb-4"
                      rows="3"
                    />
                    <button
                      onClick={submitOrder}
                      className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all font-semibold"
                    >
                      Submit Order
                    </button>
                  </div>
                )}
              </div>
            </div>
          )}

{activeModule === 'my-orders' && (
  <div className="space-y-6">
    {/* Header with Stats */}
    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-4 text-white">
        <p className="text-sm opacity-90">Total Orders</p>
        <h3 className="text-3xl font-bold mt-1">{orders.length}</h3>
      </div>
      <div className="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl shadow-lg p-4 text-white">
        <p className="text-sm opacity-90">Pending</p>
        <h3 className="text-3xl font-bold mt-1">{orders.filter(o => o.status === 'pending').length}</h3>
      </div>
      <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-4 text-white">
        <p className="text-sm opacity-90">Completed</p>
        <h3 className="text-3xl font-bold mt-1">{orders.filter(o => o.status === 'completed').length}</h3>
      </div>
      <div className="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-4 text-white">
        <p className="text-sm opacity-90">Cancelled</p>
        <h3 className="text-3xl font-bold mt-1">{orders.filter(o => o.status === 'cancelled').length}</h3>
      </div>
    </div>

    {/* Filters */}
    <div className="bg-white rounded-xl shadow-lg p-6">
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="md:col-span-2">
          <label className="block text-sm font-medium text-gray-700 mb-2">Search Orders</label>
          <input
            type="text"
            placeholder="Search by order number or customer name..."
            value={orderSearchQuery}
            onChange={(e) => setOrderSearchQuery(e.target.value)}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Status</label>
          <select
            value={orderStatusFilter}
            onChange={(e) => setOrderStatusFilter(e.target.value)}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
          >
            <option value="all">All Status</option>
            <option value="pending">Pending</option>
            <option value="processing">Processing</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
          <div className="flex gap-2">
            <input
              type="date"
              value={orderDateRange.start}
              onChange={(e) => setOrderDateRange({...orderDateRange, start: e.target.value})}
              className="flex-1 px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none text-sm"
            />
            <input
              type="date"
              value={orderDateRange.end}
              onChange={(e) => setOrderDateRange({...orderDateRange, end: e.target.value})}
              className="flex-1 px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none text-sm"
            />
          </div>
        </div>
      </div>
      
      {(orderSearchQuery || orderStatusFilter !== 'all' || orderDateRange.start || orderDateRange.end) && (
        <div className="mt-4 flex items-center justify-between">
          <p className="text-sm text-gray-600">
            Showing {filteredOrders.length} of {orders.length} orders
          </p>
          <button
            onClick={() => {
              setOrderSearchQuery('');
              setOrderStatusFilter('all');
              setOrderDateRange({ start: '', end: '' });
            }}
            className="text-sm text-purple-600 hover:text-purple-800 font-medium"
          >
            Clear Filters
          </button>
        </div>
      )}
    </div>

    {/* Orders List */}
    <div className="space-y-4">
      {filteredOrders.length > 0 ? (
        filteredOrders.map(order => (
          <div key={order.id} className="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
            {/* Order Header */}
            <div className="bg-gradient-to-r from-purple-50 to-pink-50 px-6 py-4 border-b border-gray-200">
              <div className="flex flex-wrap items-center justify-between gap-4">
                <div className="flex items-center gap-4">
                  <div>
                    <h3 className="text-lg font-bold text-gray-800">{order.orderNumber}</h3>
                    <p className="text-sm text-gray-500">
                      {order.createdAt?.toDate().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })}
                    </p>
                  </div>
                </div>
                
                <div className="flex items-center gap-3">
                  <span className={`px-4 py-2 rounded-full text-sm font-semibold ${
                    order.status === 'completed' ? 'bg-green-100 text-green-800' :
                    order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                    order.status === 'processing' ? 'bg-blue-100 text-blue-800' :
                    'bg-red-100 text-red-800'
                  }`}>
                    {order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                  </span>
                  
                  {order.cancellationRequested && !order.cancellationRejected && (
  <span className="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-semibold">
    Cancellation Pending
  </span>
)}
{order.cancellationRejected && (
  <span className="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">
    Cancellation Rejected
  </span>
)}
                </div>
              </div>
            </div>

            {/* Order Body */}
            <div className="px-6 py-4">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                {/* Customer Info */}
                <div>
                  <p className="text-xs text-gray-500 uppercase font-semibold mb-1">Customer</p>
                  <p className="font-medium text-gray-800">{order.customerName}</p>
                  <p className="text-sm text-gray-600">{order.customerEmail}</p>
                  {order.customerPhone && (
                    <p className="text-sm text-gray-600">{order.customerPhone}</p>
                  )}
                </div>

                {/* Delivery Info */}
                <div>
                  <p className="text-xs text-gray-500 uppercase font-semibold mb-1">Delivery Address</p>
                  <p className="text-sm text-gray-800">{order.deliveryAddress}</p>
                </div>

                {/* Payment Info */}
                <div>
                  <p className="text-xs text-gray-500 uppercase font-semibold mb-1">Payment</p>
                  <p className="text-sm text-gray-800">{order.paymentMethod}</p>
                  <p className="text-2xl font-bold text-purple-600 mt-2">${order.totalAmount.toFixed(2)}</p>
                </div>
              </div>

              {/* Order Items */}
              <div className="border-t border-gray-200 pt-4">
                <p className="text-xs text-gray-500 uppercase font-semibold mb-3">Items ({order.items?.length || 0})</p>
                <div className="space-y-2">
                  {order.items?.map((item, idx) => (
                    <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <div className="flex-1">
                        <p className="font-medium text-gray-800">{item.name}</p>
                        <p className="text-sm text-gray-500">SKU: {item.sku}</p>
                      </div>
                      <div className="text-right">
                        <p className="text-sm text-gray-600">
                          {item.quantity} Ã— ${item.price.toFixed(2)}
                        </p>
                        <p className="font-semibold text-gray-900">${item.subtotal.toFixed(2)}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Notes */}
              {order.notes && (
                <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-100">
                  <p className="text-xs text-gray-500 uppercase font-semibold mb-1">Notes</p>
                  <p className="text-sm text-gray-700">{order.notes}</p>
                </div>
              )}

{/* Cancellation Reason */}
{order.cancellationReason && order.cancellationRequested && !order.cancellationRejected && (
  <div className="mt-4 p-3 bg-orange-50 rounded-lg border border-orange-100">
    <p className="text-xs text-gray-500 uppercase font-semibold mb-1">Cancellation Requested</p>
    <p className="text-sm text-gray-700">{order.cancellationReason}</p>
  </div>
)}
{order.cancellationRejected && order.rejectionReason && (
  <div className="mt-4 p-3 bg-red-50 rounded-lg border border-red-100">
    <p className="text-xs text-gray-500 uppercase font-semibold mb-1">Cancellation Rejected - Reason</p>
    <p className="text-sm text-gray-700">{order.rejectionReason}</p>
  </div>
)}
            </div>

            {/* Order Actions */}
            <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex flex-wrap gap-3 justify-end">
              <button
                onClick={() => {
                  setSelectedOrder(order);
                  setShowOrderDetails(true);
                }}
                className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors text-sm font-medium"
              >
                View Details
              </button>
              
              {(order.status === 'pending' || order.status === 'processing') && 
 !order.cancellationRequested && 
 !order.cancellationRejected && (
  <button
    onClick={() => {
      setSelectedOrder(order);
      setShowCancelRequest(true);
    }}
    className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-medium"
  >
    Request Cancellation
  </button>
)}

{order.cancellationRequested && !order.cancellationRejected && (
  <span className="px-4 py-2 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium">
    Awaiting Cancellation Approval
  </span>
)}

{order.cancellationRejected && (
  <span className="px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-medium">
    Cancellation Request Rejected
  </span>
)}
            </div>
          </div>
        ))
      ) : (
        <div className="text-center py-12 bg-white rounded-xl shadow-lg">
          <ShoppingCart className="w-16 h-16 text-gray-300 mx-auto mb-4" />
          <p className="text-gray-500 mb-2">
            {orderSearchQuery || orderStatusFilter !== 'all' || orderDateRange.start || orderDateRange.end
              ? 'No orders match your filters'
              : "You haven't placed any orders yet"}
          </p>
          {!orderSearchQuery && orderStatusFilter === 'all' && !orderDateRange.start && !orderDateRange.end && (
            <button
              onClick={() => setActiveModule('create-order')}
              className="mt-4 px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600"
            >
              Create Your First Order
            </button>
          )}
        </div>
      )}
    </div>
  </div>
)}






{/* Reports Module (Admin Only) */}
{activeModule === 'reports' && userRole === 'admin' && (
  <div className="space-y-6">
    {/* Innovative Report Selector - Codista Style */}



 {/* Key Metrics Overview - Always Show */}
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
        <div className="flex items-center justify-between mb-2">
          <DollarSign className="w-8 h-8 opacity-80" />
          <span className="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full">Revenue</span>
        </div>
        <h3 className="text-3xl font-bold">
          ${orders.filter(o => o.status !== 'cancelled').reduce((sum, o) => sum + o.totalAmount, 0).toFixed(2)}
        </h3>
        <p className="text-sm opacity-90 mt-1">Total Revenue</p>
        <p className="text-xs opacity-75 mt-2">Today: ${stats.todaySales.toFixed(2)}</p>
      </div>

      <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
        <div className="flex items-center justify-between mb-2">
          <ShoppingCart className="w-8 h-8 opacity-80" />
          <span className="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full">Orders</span>
        </div>
        <h3 className="text-3xl font-bold">{stats.totalOrders}</h3>
        <p className="text-sm opacity-90 mt-1">Total Orders</p>
        <p className="text-xs opacity-75 mt-2">Completed: {stats.completedOrders} | Pending: {stats.pendingOrders}</p>
      </div>

      <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
        <div className="flex items-center justify-between mb-2">
          <Package className="w-8 h-8 opacity-80" />
          <span className="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full">Inventory</span>
        </div>
        <h3 className="text-3xl font-bold">{stats.totalProducts}</h3>
        <p className="text-sm opacity-90 mt-1">Total Products</p>
        <p className="text-xs opacity-75 mt-2">Categories: {categories.length}</p>
      </div>

      <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
        <div className="flex items-center justify-between mb-2">
          <AlertTriangle className="w-8 h-8 opacity-80" />
          <span className="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full">Alerts</span>
        </div>
        <h3 className="text-3xl font-bold">{stats.outOfStock + stats.lowStock}</h3>
        <p className="text-sm opacity-90 mt-1">Stock Alerts</p>
        <p className="text-xs opacity-75 mt-2">Out: {stats.outOfStock} | Low: {stats.lowStock}</p>
      </div>
    </div>

















    <div className="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 rounded-2xl shadow-2xl p-8 border border-purple-200">
      <div className="text-center mb-8">
        <h2 className="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">
          Reports & Analytics Hub
        </h2>
        <p className="text-gray-600">Choose your report type to explore insights</p>
      </div>


      {/* Report Category Selector */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {/* Sales Performance Report */}
        <button
          onClick={() => setActiveReport(activeReport === 'sales-performance' ? null : 'sales-performance')}
          className={`group relative bg-white rounded-xl p-6 shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-2 border-2 ${
            activeReport === 'sales-performance' 
              ? 'border-green-400 ring-4 ring-green-200' 
              : 'border-transparent hover:border-green-400'
          }`}
        >
          <div className={`absolute top-4 right-4 w-12 h-12 bg-gradient-to-br from-green-400 to-emerald-500 rounded-lg flex items-center justify-center transition-transform ${
            activeReport === 'sales-performance' ? 'scale-110' : 'group-hover:scale-110'
          }`}>
            <TrendingUp className="w-6 h-6 text-white" />
          </div>
          <div className="mb-16">
            <h3 className="text-xl font-bold text-gray-800 mb-2">Sales Performance</h3>
            <p className="text-sm text-gray-600">Revenue analysis, order metrics, and growth tracking</p>
          </div>
          <div className="flex items-center justify-between text-sm">
            <span className="text-gray-500">{activeReport === 'sales-performance' ? 'Hide Report' : 'View Report'}</span>
            <span className={`font-semibold transition-transform ${
              activeReport === 'sales-performance' ? 'text-green-500 rotate-90' : 'text-green-500 group-hover:translate-x-2'
            }`}>â†’</span>
          </div>
        </button>



   {/* Inventory Health Report */}
        <button
          onClick={() => setActiveReport(activeReport === 'inventory-health' ? null : 'inventory-health')}
          className={`group relative bg-white rounded-xl p-6 shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-2 border-2 ${
            activeReport === 'inventory-health' 
              ? 'border-purple-400 ring-4 ring-purple-200' 
              : 'border-transparent hover:border-purple-400'
          }`}
        >
          <div className={`absolute top-4 right-4 w-12 h-12 bg-gradient-to-br from-purple-400 to-purple-600 rounded-lg flex items-center justify-center transition-transform ${
            activeReport === 'inventory-health' ? 'scale-110' : 'group-hover:scale-110'
          }`}>
            <Package className="w-6 h-6 text-white" />
          </div>
          <div className="mb-16">
            <h3 className="text-xl font-bold text-gray-800 mb-2">Inventory Health</h3>
            <p className="text-sm text-gray-600">Stock status, alerts, and inventory valuation</p>
          </div>
          <div className="flex items-center justify-between text-sm">
            <span className="text-gray-500">{activeReport === 'inventory-health' ? 'Hide Report' : 'View Report'}</span>
            <span className={`font-semibold transition-transform ${
              activeReport === 'inventory-health' ? 'text-purple-500 rotate-90' : 'text-purple-500 group-hover:translate-x-2'
            }`}>â†’</span>
          </div>
        </button>



     
        {/* Top Products Report */}
        <button
          onClick={() => setActiveReport(activeReport === 'top-products' ? null : 'top-products')}
          className={`group relative bg-white rounded-xl p-6 shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-2 border-2 ${
            activeReport === 'top-products' 
              ? 'border-yellow-400 ring-4 ring-yellow-200' 
              : 'border-transparent hover:border-yellow-400'
          }`}
        >
          <div className={`absolute top-4 right-4 w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center transition-transform ${
            activeReport === 'top-products' ? 'scale-110' : 'group-hover:scale-110'
          }`}>
            <DollarSign className="w-6 h-6 text-white" />
          </div>
          <div className="mb-16">
            <h3 className="text-xl font-bold text-gray-800 mb-2">Top Products</h3>
            <p className="text-sm text-gray-600">Best sellers by revenue and units sold</p>
          </div>
          <div className="flex items-center justify-between text-sm">
            <span className="text-gray-500">{activeReport === 'top-products' ? 'Hide Report' : 'View Report'}</span>
            <span className={`font-semibold transition-transform ${
              activeReport === 'top-products' ? 'text-yellow-500 rotate-90' : 'text-yellow-500 group-hover:translate-x-2'
            }`}>â†’</span>
          </div>
        </button>

        {/* Category Performance Report */}
        <button
          onClick={() => setActiveReport(activeReport === 'category-performance' ? null : 'category-performance')}
          className={`group relative bg-white rounded-xl p-6 shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-2 border-2 ${
            activeReport === 'category-performance' 
              ? 'border-indigo-400 ring-4 ring-indigo-200' 
              : 'border-transparent hover:border-indigo-400'
          }`}
        >
          <div className={`absolute top-4 right-4 w-12 h-12 bg-gradient-to-br from-indigo-400 to-blue-600 rounded-lg flex items-center justify-center transition-transform ${
            activeReport === 'category-performance' ? 'scale-110' : 'group-hover:scale-110'
          }`}>
            <BarChart className="w-6 h-6 text-white" />
          </div>
          <div className="mb-16">
            <h3 className="text-xl font-bold text-gray-800 mb-2">Category Performance</h3>
            <p className="text-sm text-gray-600">Product categories analysis and metrics</p>
          </div>
          <div className="flex items-center justify-between text-sm">
            <span className="text-gray-500">{activeReport === 'category-performance' ? 'Hide Report' : 'View Report'}</span>
            <span className={`font-semibold transition-transform ${
              activeReport === 'category-performance' ? 'text-indigo-500 rotate-90' : 'text-indigo-500 group-hover:translate-x-2'
            }`}>â†’</span>
          </div>
        </button>

        {/* Cancellation Requests Report */}
        <button
          onClick={() => setActiveReport(activeReport === 'cancellation-requests' ? null : 'cancellation-requests')}
          className={`group relative bg-white rounded-xl p-6 shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-2 border-2 ${
            activeReport === 'cancellation-requests' 
              ? 'border-orange-400 ring-4 ring-orange-200' 
              : 'border-transparent hover:border-orange-400'
          }`}
        >
          <div className={`absolute top-4 right-4 w-12 h-12 bg-gradient-to-br from-orange-400 to-red-500 rounded-lg flex items-center justify-center transition-transform ${
            activeReport === 'cancellation-requests' ? 'scale-110' : 'group-hover:scale-110'
          }`}>
            <AlertTriangle className="w-6 h-6 text-white" />
          </div>
          <div className="mb-16">
            <h3 className="text-xl font-bold text-gray-800 mb-2">Cancellations</h3>
            <p className="text-sm text-gray-600">Pending cancellation requests review</p>
          </div>
          <div className="flex items-center justify-between text-sm">
            <span className="text-gray-500">{activeReport === 'cancellation-requests' ? 'Hide Report' : 'View Report'}</span>
            <span className={`font-semibold transition-transform ${
              activeReport === 'cancellation-requests' ? 'text-orange-500 rotate-90' : 'text-orange-500 group-hover:translate-x-2'
            }`}>â†’</span>
          </div>
        </button>

        {/* Invoice Template Manager */}
        <button
          onClick={() => setActiveReport(activeReport === 'invoice-template' ? null : 'invoice-template')}
          className={`group relative bg-white rounded-xl p-6 shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-2 border-2 ${
            activeReport === 'invoice-template' 
              ? 'border-blue-400 ring-4 ring-blue-200' 
              : 'border-transparent hover:border-blue-400'
          }`}
        >
          <div className={`absolute top-4 right-4 w-12 h-12 bg-gradient-to-br from-blue-400 to-cyan-600 rounded-lg flex items-center justify-center transition-transform ${
            activeReport === 'invoice-template' ? 'scale-110' : 'group-hover:scale-110'
          }`}>
            <FileText className="w-6 h-6 text-white" />
          </div>
          <div className="mb-16">
            <h3 className="text-xl font-bold text-gray-800 mb-2">Invoice Template</h3>
            <p className="text-sm text-gray-600">Manage BIR-registered invoice templates</p>
          </div>
          <div className="flex items-center justify-between text-sm">
            <span className="text-gray-500">{activeReport === 'invoice-template' ? 'Hide Manager' : 'View Manager'}</span>
            <span className={`font-semibold transition-transform ${
              activeReport === 'invoice-template' ? 'text-blue-500 rotate-90' : 'text-blue-500 group-hover:translate-x-2'
            }`}>â†’</span>
          </div>
        </button>
      </div>










    {/* Conditionally Rendered Reports with Animation */}
    {activeReport === 'sales-performance' && (
      <div className="animate-fadeIn">
        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
          <div className="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50">
            <h3 className="text-lg font-semibold text-gray-800 flex items-center gap-2">
              <TrendingUp className="w-5 h-5 text-blue-600" />
              Sales Performance Analysis
            </h3>
          </div>
          {/* Rest of Sales Performance content... */}
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metric</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {(() => {
                  const totalRevenue = orders.filter(o => o.status !== 'cancelled').reduce((sum, o) => sum + o.totalAmount, 0);
                  const completedRevenue = orders.filter(o => o.status === 'completed').reduce((sum, o) => sum + o.totalAmount, 0);
                  const pendingRevenue = orders.filter(o => o.status === 'pending').reduce((sum, o) => sum + o.totalAmount, 0);
                  const processingRevenue = orders.filter(o => o.status === 'processing').reduce((sum, o) => sum + o.totalAmount, 0);
                  
                  return [
                    { label: 'Completed Orders', count: stats.completedOrders, amount: completedRevenue, color: 'green' },
                    { label: 'Pending Orders', count: stats.pendingOrders, amount: pendingRevenue, color: 'yellow' },
                    { label: 'Processing Orders', count: orders.filter(o => o.status === 'processing').length, amount: processingRevenue, color: 'blue' },
                    { label: 'Cancelled Orders', count: orders.filter(o => o.status === 'cancelled').length, amount: 0, color: 'red' },
                  ];
                })().map((row, idx) => {
                  const totalRevenue = orders.filter(o => o.status !== 'cancelled').reduce((sum, o) => sum + o.totalAmount, 0);
                  const percentage = totalRevenue > 0 ? ((row.amount / totalRevenue) * 100).toFixed(1) : '0.0';
                  
                  return (
                    <tr key={idx} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                          row.color === 'green' ? 'bg-green-100 text-green-800' :
                          row.color === 'yellow' ? 'bg-yellow-100 text-yellow-800' :
                          row.color === 'blue' ? 'bg-blue-100 text-blue-800' :
                          'bg-red-100 text-red-800'
                        }`}>
                          {row.label}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">{row.count}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${row.amount.toFixed(2)}</td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center gap-2">
                          <div className="flex-1 bg-gray-200 rounded-full h-2 max-w-[100px]">
                            <div 
                              className={`h-2 rounded-full ${
                                row.color === 'green' ? 'bg-green-500' :
                                row.color === 'yellow' ? 'bg-yellow-500' :
                                row.color === 'blue' ? 'bg-blue-500' :
                                'bg-red-500'
                              }`}
                              style={{ width: `${percentage}%` }}
                            ></div>
                          </div>
                          <span className="text-sm text-gray-600">{percentage}%</span>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    )}


{activeReport === 'inventory-health' && (
      <div className="animate-fadeIn">
        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
          <div className="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-pink-50">
            <h3 className="text-lg font-semibold text-gray-800 flex items-center gap-2">
              <Package className="w-5 h-5 text-purple-600" />
              Inventory Health Report
            </h3>
          </div>
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Products</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Units</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Est. Value</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action Required</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {(() => {
                  const inStock = products.filter(p => p.stock > p.threshold);
                  const lowStock = products.filter(p => p.stock > 0 && p.stock <= p.threshold);
                  const outOfStock = products.filter(p => p.stock === 0);
                  
                  return [
                    { 
                      status: 'In Stock', 
                      products: inStock, 
                      color: 'green',
                      action: 'None'
                    },
                    { 
                      status: 'Low Stock', 
                      products: lowStock, 
                      color: 'yellow',
                      action: 'Reorder Soon'
                    },
                    { 
                      status: 'Out of Stock', 
                      products: outOfStock, 
                      color: 'red',
                      action: 'Urgent Restock'
                    },
                  ];
                })().map((row, idx) => {
                  const totalUnits = row.products.reduce((sum, p) => sum + p.stock, 0);
                  const totalValue = row.products.reduce((sum, p) => sum + (p.stock * p.price), 0);
                  
                  return (
                    <tr key={idx} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                          row.color === 'green' ? 'bg-green-100 text-green-800' :
                          row.color === 'yellow' ? 'bg-yellow-100 text-yellow-800' :
                          'bg-red-100 text-red-800'
                        }`}>
                          {row.status}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">{row.products.length}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">{totalUnits}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${totalValue.toFixed(2)}</td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`text-sm font-medium ${
                          row.color === 'green' ? 'text-green-600' :
                          row.color === 'yellow' ? 'text-yellow-600' :
                          'text-red-600'
                        }`}>
                          {row.action}
                        </span>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    )}

    {activeReport === 'top-products' && (
      <div className="animate-fadeIn">
        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
          <div className="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50">
            <h3 className="text-lg font-semibold text-gray-800 flex items-center gap-2">
              <DollarSign className="w-5 h-5 text-green-600" />
              Top 10 Products by Revenue
            </h3>
          </div>
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Units Sold</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Status</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {(() => {
                  const productSales = {};
                  orders.filter(o => o.status !== 'cancelled').forEach(order => {
                    order.items?.forEach(item => {
                      if (!productSales[item.productId]) {
                        productSales[item.productId] = {
                          name: item.name,
                          sku: item.sku,
                          unitsSold: 0,
                          revenue: 0
                        };
                      }
                      productSales[item.productId].unitsSold += item.quantity;
                      productSales[item.productId].revenue += item.subtotal;
                    });
                  });
                  
                  return Object.entries(productSales)
                    .map(([id, data]) => ({
                      id,
                      ...data,
                      product: products.find(p => p.id === id)
                    }))
                    .sort((a, b) => b.revenue - a.revenue)
                    .slice(0, 10);
                })().map((item, idx) => (
                  <tr key={idx} className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
                        idx === 0 ? 'bg-yellow-100 text-yellow-700' :
                        idx === 1 ? 'bg-gray-200 text-gray-700' :
                        idx === 2 ? 'bg-orange-100 text-orange-700' :
                        'bg-gray-100 text-gray-600'
                      }`}>
                        {idx + 1}
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <div className="text-sm font-medium text-gray-900">{item.name}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.sku}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">{item.unitsSold}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-600">${item.revenue.toFixed(2)}</td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      {item.product && (
                        <span className={`px-2 py-1 text-xs rounded-full font-medium ${
                          item.product.stock === 0 ? 'bg-red-100 text-red-700' :
                          item.product.stock <= item.product.threshold ? 'bg-yellow-100 text-yellow-700' :
                          'bg-green-100 text-green-700'
                        }`}>
                          {item.product.stock} in stock
                        </span>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    )}

    {activeReport === 'category-performance' && (
      <div className="animate-fadeIn">
        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
          <div className="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-blue-50">
            <h3 className="text-lg font-semibold text-gray-800 flex items-center gap-2">
              <BarChart className="w-5 h-5 text-indigo-600" />
              Performance by Category
            </h3>
          </div>
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Products</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Stock</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Price</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Value</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {categories.map((category, idx) => {
                  const categoryProducts = products.filter(p => p.category === category);
                  const totalStock = categoryProducts.reduce((sum, p) => sum + p.stock, 0);
                  const avgPrice = categoryProducts.reduce((sum, p) => sum + p.price, 0) / categoryProducts.length;
                  const stockValue = categoryProducts.reduce((sum, p) => sum + (p.stock * p.price), 0);
                  
                  return (
                    <tr key={idx} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                          {category}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">{categoryProducts.length}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">{totalStock}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${avgPrice.toFixed(2)}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-600">${stockValue.toFixed(2)}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    )}

    {activeReport === 'cancellation-requests' && (
      <div className="animate-fadeIn">
        <div className="bg-white rounded-xl shadow-lg p-6">
          <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <AlertTriangle className="w-5 h-5 text-orange-500" />
            Pending Cancellation Requests
          </h3>
          <CancellationRequestsList />
        </div>
      </div>
    )}

{activeReport === 'invoice-template' && (
  <div className="animate-fadeIn">
    <div className="bg-white rounded-xl shadow-lg p-8 text-center">
      <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center mx-auto mb-6">
        <FileText className="w-10 h-10 text-white" />
      </div>
      
      <h3 className="text-2xl font-bold text-gray-800 mb-2">Invoice Template Manager</h3>
      <p className="text-gray-600 mb-6">
        Manage your BIR-registered invoice templates and company settings in a dedicated interface
      </p>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 max-w-2xl mx-auto">
        <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div className="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mx-auto mb-2">1</div>
          <p className="text-sm font-medium text-gray-700">Upload Templates</p>
        </div>
        <div className="p-4 bg-cyan-50 rounded-lg border border-cyan-200">
          <div className="w-8 h-8 bg-cyan-500 text-white rounded-full flex items-center justify-center font-bold mx-auto mb-2">2</div>
          <p className="text-sm font-medium text-gray-700">Configure Settings</p>
        </div>
        <div className="p-4 bg-green-50 rounded-lg border border-green-200">
          <div className="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold mx-auto mb-2">3</div>
          <p className="text-sm font-medium text-gray-700">Generate Invoices</p>
        </div>
      </div>

      <button
        onClick={() => window.location.href = 'invoice-manager.html'}
        className="inline-flex items-center gap-2 px-8 py-4 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg hover:shadow-xl transition-all text-lg font-semibold transform hover:scale-105"
      >
        <FileText />
        Open Invoice Manager
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
        </svg>
      </button>

      <p className="text-xs text-gray-500 mt-4">
        Opens in the same window with full authentication
      </p>
    </div>
  </div>
)}










      {/* Quick Export Actions */}
      <div className="mt-8 pt-8 border-t border-purple-200">
        <h3 className="text-lg font-semibold text-gray-800 mb-4 text-center">Quick Export</h3>
        <div className="flex flex-wrap justify-center gap-3">
          <button 
            onClick={() => {
              const csv = [
                ['Product Name', 'SKU', 'Category', 'Price', 'Stock', 'Unit', 'Supplier'].join(','),
                ...products.map(p => [p.name, p.sku, p.category, p.price, p.stock, p.unit, p.supplier || ''].join(','))
              ].join('\n');
              const blob = new Blob([csv], { type: 'text/csv' });
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `products_${new Date().toISOString().split('T')[0]}.csv`;
              a.click();
            }}
            className="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all text-sm font-medium flex items-center gap-2"
          >
            <FileText className="w-4 h-4" />
            Export Products CSV
          </button>
          <button 
            onClick={() => {
              const csv = [
                ['Order #', 'Customer', 'Email', 'Items', 'Total', 'Status', 'Date'].join(','),
                ...orders.map(o => [
                  o.orderNumber, 
                  o.customerName, 
                  o.customerEmail, 
                  o.items?.length || 0, 
                  o.totalAmount.toFixed(2), 
                  o.status, 
                  o.createdAt?.toDate().toLocaleDateString() || ''
                ].join(','))
              ].join('\n');
              const blob = new Blob([csv], { type: 'text/csv' });
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `orders_${new Date().toISOString().split('T')[0]}.csv`;
              a.click();
            }}
            className="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-lg hover:shadow-lg transition-all text-sm font-medium flex items-center gap-2"
          >
            <FileText className="w-4 h-4" />
            Export Orders CSV
          </button>
        </div>
      </div>
    </div>

   
 {/* Admin Activity Logs - Always Show */}
    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
      <div className="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-slate-50">
        <h3 className="text-lg font-semibold text-gray-800 flex items-center gap-2">
          <FileText className="w-5 h-5 text-gray-600" />
          Recent Admin Activity (Last 20 Actions)
        </h3>
      </div>
      <div className="p-6">
        <div className="space-y-3 max-h-96 overflow-y-auto">
          {notifications
            .filter(n => n.type === 'product-edit' || n.type === 'order-status')
            .slice(0, 20)
            .map(log => (
              <div key={log.id} className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <div className={`w-2 h-2 rounded-full mt-2 ${
                  log.type === 'product-edit' ? 'bg-blue-600' : 'bg-green-600'
                }`}></div>
                <div className="flex-1">
                  <p className="text-sm font-medium text-gray-800">{log.message}</p>
                  {log.details && (
                    <div className="text-xs text-gray-600 mt-1 space-y-0.5">
                      {log.details.productName && <p>â€¢ Product: {log.details.productName}</p>}
                      {log.details.sku && <p>â€¢ SKU: {log.details.sku}</p>}
                      {log.details.action && <p>â€¢ Action: {log.details.action}</p>}
                      {log.details.changes && <p>â€¢ {log.details.changes}</p>}
                      {log.details.orderNumber && <p>â€¢ Order: {log.details.orderNumber}</p>}
                      {log.details.oldStatus && <p>â€¢ Status: {log.details.oldStatus} â†’ {log.details.newStatus}</p>}
                    </div>
                  )}
                  <p className="text-xs text-gray-500 mt-1">{log.timeAgo}</p>
                </div>
              </div>
            ))}
            {notifications.filter(n => n.type === 'product-edit' || n.type === 'order-status').length === 0 && (
              <div className="text-center py-8">
                <FileText className="w-12 h-12 text-gray-300 mx-auto mb-2" />
                <p className="text-center text-gray-500">No activity logs yet</p>
              </div>
            )}
        </div>
      </div>
    </div>

  </div>
)}




{/* Settings Module */}
{activeModule === 'settings' && (
  <div className="space-y-6">
    {/* Profile Card */}
    <div className="bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl shadow-2xl p-8 text-white">
      <div className="flex items-center gap-6">
        <div className="w-24 h-24 bg-white bg-opacity-20 rounded-full flex items-center justify-center backdrop-blur-sm border-4 border-white border-opacity-30">
          <span className="text-5xl font-bold">{user?.displayName?.charAt(0) || 'U'}</span>
        </div>
        <div className="flex-1">
          <h2 className="text-3xl font-bold mb-2">{user?.displayName || 'User'}</h2>
          <p className="text-white text-opacity-90 mb-1">{user?.email}</p>
          <div className="flex items-center gap-2">
            <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-sm font-semibold backdrop-blur-sm flex items-center gap-2">
              {userRole === 'admin' ? (
                <>
                  <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M9.504 1.132a1 1 0 01.992 0l1.75 1a1 1 0 11-.992 1.736L10 3.152l-1.254.716a1 1 0 11-.992-1.736l1.75-1zM5.618 4.504a1 1 0 01-.372 1.364L5.016 6l.23.132a1 1 0 11-.992 1.736L4 7.723V8a1 1 0 01-2 0V6a.996.996 0 01.52-.878l1.734-.99a1 1 0 011.364.372zm8.764 0a1 1 0 011.364-.372l1.733.99A1.002 1.002 0 0118 6v2a1 1 0 11-2 0v-.277l-.254.145a1 1 0 11-.992-1.736l.23-.132-.23-.132a1 1 0 01-.372-1.364zm-7 4a1 1 0 011.364-.372L10 8.848l1.254-.716a1 1 0 11.992 1.736L11 10.58V12a1 1 0 11-2 0v-1.42l-1.246-.712a1 1 0 01-.372-1.364zM3 11a1 1 0 011 1v1.42l1.246.712a1 1 0 11-.992 1.736l-1.75-1A1 1 0 012 14v-2a1 1 0 011-1zm14 0a1 1 0 011 1v2a1 1 0 01-.504.868l-1.75 1a1 1 0 11-.992-1.736L16 13.42V12a1 1 0 011-1zm-9.618 5.504a1 1 0 011.364-.372l.254.145V16a1 1 0 112 0v.277l.254-.145a1 1 0 11.992 1.736l-1.735.992a.995.995 0 01-1.022 0l-1.735-.992a1 1 0 01-.372-1.364z" clipRule="evenodd" />
                  </svg>
                  Administrator
                </>
              ) : (
                <>
                  <Users className="w-4 h-4" />
                  User
                </>
              )}
            </span>
            {user?.companyName && (
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-sm font-semibold backdrop-blur-sm flex items-center gap-2">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                {user.companyName}
              </span>
            )}
          </div>
        </div>
      </div>
    </div>

    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* Account Information */}
      <div className="bg-white rounded-xl shadow-lg p-6">
        <div className="flex items-center justify-between mb-6">
          <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
            <Users className="w-6 h-6 text-purple-600" />
            Account Information
          </h3>
          {userRole === 'admin' && (
            <button
              onClick={() => {
                const newName = prompt('Enter your new full name:', user?.displayName || '');
                if (newName && newName.trim() !== '' && newName !== user?.displayName) {
                  updateUserProfile(newName.trim());
                }
              }}
              className="flex items-center gap-2 px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors text-sm font-medium"
            >
              <Edit className="w-4 h-4" />
              Edit Profile
            </button>
          )}
        </div>

        <div className="space-y-4">
          <div className="p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-200">
            <label className="block text-xs font-semibold text-purple-600 uppercase mb-1">Full Name</label>
            <p className="text-lg font-semibold text-gray-800">{user?.displayName || 'Not Set'}</p>
          </div>

          <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Email Address</label>
            <p className="text-gray-800 font-medium">{user?.email || 'Not Set'}</p>
          </div>

          <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">User ID</label>
            <p className="text-gray-600 font-mono text-sm">{user?.uid || 'Not Set'}</p>
          </div>

          {user?.companyName && (
            <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
              <label className="block text-xs font-semibold text-blue-600 uppercase mb-1">Company Name</label>
              <p className="text-lg font-semibold text-gray-800">{user.companyName}</p>
            </div>
          )}

          <div className="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
            <label className="block text-xs font-semibold text-indigo-600 uppercase mb-1">Account Role</label>
            <div className="flex items-center gap-2">
              {userRole === 'admin' ? (
                <>
                  <svg className="w-5 h-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M9.504 1.132a1 1 0 01.992 0l1.75 1a1 1 0 11-.992 1.736L10 3.152l-1.254.716a1 1 0 11-.992-1.736l1.75-1zM5.618 4.504a1 1 0 01-.372 1.364L5.016 6l.23.132a1 1 0 11-.992 1.736L4 7.723V8a1 1 0 01-2 0V6a.996.996 0 01.52-.878l1.734-.99a1 1 0 011.364.372zm8.764 0a1 1 0 011.364-.372l1.733.99A1.002 1.002 0 0118 6v2a1 1 0 11-2 0v-.277l-.254.145a1 1 0 11-.992-1.736l.23-.132-.23-.132a1 1 0 01-.372-1.364zm-7 4a1 1 0 011.364-.372L10 8.848l1.254-.716a1 1 0 11.992 1.736L11 10.58V12a1 1 0 11-2 0v-1.42l-1.246-.712a1 1 0 01-.372-1.364zM3 11a1 1 0 011 1v1.42l1.246.712a1 1 0 11-.992 1.736l-1.75-1A1 1 0 012 14v-2a1 1 0 011-1zm14 0a1 1 0 011 1v2a1 1 0 01-.504.868l-1.75 1a1 1 0 11-.992-1.736L16 13.42V12a1 1 0 011-1zm-9.618 5.504a1 1 0 011.364-.372l.254.145V16a1 1 0 112 0v.277l.254-.145a1 1 0 11.992 1.736l-1.735.992a.995.995 0 01-1.022 0l-1.735-.992a1 1 0 01-.372-1.364z" clipRule="evenodd" />
                  </svg>
                  <span className="text-gray-800 font-semibold">Administrator</span>
                </>
              ) : (
                <>
                  <Users className="w-5 h-5 text-indigo-600" />
                  <span className="text-gray-800 font-semibold">Regular User</span>
                </>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Account Statistics */}
      <div className="bg-white rounded-xl shadow-lg p-6">
        <h3 className="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
          <BarChart className="w-6 h-6 text-green-600" />
          Account Statistics
        </h3>

        <div className="space-y-4">
          {userRole === 'admin' ? (
            <>
              <div className="p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-xs font-semibold text-green-600 uppercase mb-1">Total Products</p>
                    <p className="text-3xl font-bold text-gray-800">{stats.totalProducts}</p>
                  </div>
                  <Package className="w-12 h-12 text-green-600 opacity-50" />
                </div>
              </div>

              <div className="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border border-blue-200">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-xs font-semibold text-blue-600 uppercase mb-1">Total Orders</p>
                    <p className="text-3xl font-bold text-gray-800">{stats.totalOrders}</p>
                  </div>
                  <ShoppingCart className="w-12 h-12 text-blue-600 opacity-50" />
                </div>
              </div>

              <div className="p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-200">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-xs font-semibold text-purple-600 uppercase mb-1">Total Revenue</p>
                    <p className="text-3xl font-bold text-gray-800">
                      ${orders.filter(o => o.status !== 'cancelled').reduce((sum, o) => sum + o.totalAmount, 0).toFixed(2)}
                    </p>
                  </div>
                  <DollarSign className="w-12 h-12 text-purple-600 opacity-50" />
                </div>
              </div>

              <div className="p-4 bg-gradient-to-r from-orange-50 to-yellow-50 rounded-lg border border-orange-200">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-xs font-semibold text-orange-600 uppercase mb-1">Pending Orders</p>
                    <p className="text-3xl font-bold text-gray-800">{stats.pendingOrders}</p>
                  </div>
                  <AlertTriangle className="w-12 h-12 text-orange-600 opacity-50" />
                </div>
              </div>
            </>
          ) : (
            <>
              <div className="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border border-blue-200">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-xs font-semibold text-blue-600 uppercase mb-1">My Orders</p>
                    <p className="text-3xl font-bold text-gray-800">{orders.length}</p>
                  </div>
                  <ShoppingCart className="w-12 h-12 text-blue-600 opacity-50" />
                </div>
              </div>

              <div className="p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-xs font-semibold text-green-600 uppercase mb-1">Completed</p>
                    <p className="text-3xl font-bold text-gray-800">{orders.filter(o => o.status === 'completed').length}</p>
                  </div>
                  <svg className="w-12 h-12 text-green-600 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
              </div>

              <div className="p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border border-yellow-200">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-xs font-semibold text-yellow-600 uppercase mb-1">Pending</p>
                    <p className="text-3xl font-bold text-gray-800">{orders.filter(o => o.status === 'pending').length}</p>
                  </div>
                  <AlertTriangle className="w-12 h-12 text-yellow-600 opacity-50" />
                </div>
              </div>

              {user?.assignedAdminName && (
                <div className="p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-200">
                  <p className="text-xs font-semibold text-purple-600 uppercase mb-1">Assigned Admin</p>
                  <p className="text-lg font-semibold text-gray-800">{user.assignedAdminName}</p>
                </div>
              )}
            </>
          )}
        </div>
      </div>
    </div>

    {/* Security Settings */}
    <div className="bg-white rounded-xl shadow-lg p-6">
      <h3 className="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
        <Settings className="w-6 h-6 text-red-600" />
        Security & Account Actions
      </h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h4 className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
            <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
            Account Status
          </h4>
          <p className="text-sm text-gray-600 mb-3">Your account is active and in good standing.</p>
          <span className="inline-flex items-center px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold">
            <svg className="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
            </svg>
            Active
          </span>
        </div>

        <div className="p-4 bg-red-50 rounded-lg border border-red-200">
          <h4 className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
            <LogOut className="w-5 h-5 text-red-600" />
            Sign Out
          </h4>
          <p className="text-sm text-gray-600 mb-3">Securely log out of your account.</p>
          <button
            onClick={handleLogout}
            className="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-medium"
          >
            <LogOut className="w-4 h-4" />
            Sign Out
          </button>
        </div>
      </div>
    </div>
  </div>
)}
        </main>
      </div>

      {/* Add/Edit Product Modal */}
{showAddProduct && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
          <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl my-8">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold">{editingProduct ? 'Edit Product' : 'Add New Product'}</h2>
              <button
                onClick={() => {
                  setShowAddProduct(false);
                  setEditingProduct(null);
                  resetProductForm();
                }}
                className="text-gray-400 hover:text-gray-600"
              >
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Product Name *</label>
                <input
                  type="text"
                  placeholder="Enter product name"
                  value={productForm.name}
                  onChange={(e) => setProductForm({...productForm, name: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">SKU *</label>
                <input
                  type="text"
                  placeholder="Enter SKU"
                  value={productForm.sku}
                  onChange={(e) => setProductForm({...productForm, sku: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <input
                  type="text"
                  placeholder="Enter category"
                  value={productForm.category}
                  onChange={(e) => setProductForm({...productForm, category: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Price *</label>
                <input
                  type="number"
                  step="0.01"
                  placeholder="0.00"
                  value={productForm.price}
                  onChange={(e) => setProductForm({...productForm, price: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Stock Quantity *</label>
                <input
                  type="number"
                  placeholder="0"
                  value={productForm.stock}
                  onChange={(e) => setProductForm({...productForm, stock: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Low Stock Threshold</label>
                <input
                  type="number"
                  placeholder="10"
                  value={productForm.threshold}
                  onChange={(e) => setProductForm({...productForm, threshold: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Unit of Measurement</label>
                <select
                  value={productForm.unit}
                  onChange={(e) => setProductForm({...productForm, unit: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                >
                  <option value="pieces">Pieces</option>
                  <option value="kg">Kilograms (kg)</option>
                  <option value="liters">Liters</option>
                  <option value="boxes">Boxes</option>
                  <option value="packs">Packs</option>
                  <option value="meters">Meters</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Supplier Name</label>
                <input
                  type="text"
                  placeholder="Enter supplier name"
                  value={productForm.supplier}
                  onChange={(e) => setProductForm({...productForm, supplier: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                />
              </div>

<div>
  <label className="block text-sm font-medium text-gray-700 mb-1">MOQ (Minimum Order Quantity)</label>
  <input
    type="number"
    placeholder="Enter MOQ"
    value={productForm.moq}
    onChange={(e) => setProductForm({...productForm, moq: e.target.value})}
    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
  />
</div>

<div>
  <label className="block text-sm font-medium text-gray-700 mb-1">Lead Time (Days)</label>
  <input
    type="number"
    placeholder="Enter lead time in days"
    value={productForm.leadTime}
    onChange={(e) => setProductForm({...productForm, leadTime: e.target.value})}
    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
  />
</div>
            </div>

            <div className="mt-4">
              <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
              <textarea
                placeholder="Enter product description"
                value={productForm.description}
                onChange={(e) => setProductForm({...productForm, description: e.target.value})}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                rows="3"
              />
            </div>

            <div className="mt-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">Product Image</label>
              <div className="flex items-center gap-4">
                <input
                  type="file"
                  id="productImage"
                  accept="image/*"
                  style={{ display: 'none' }}
                  onChange={(e) => {
                    const file = e.target.files[0];
                    if (file) uploadToCloudinary(file);
                  }}
                />

                <button
                  onClick={() => document.getElementById('productImage').click()}
                  disabled={uploadingImage}
                  className={`flex items-center gap-2 px-4 py-2 rounded-lg text-white transition-all ${
                    uploadingImage ? 'bg-gray-400 cursor-not-allowed' : 'bg-purple-500 hover:bg-purple-600'
                  }`}
                >
                  <Image />
                  {uploadingImage ? 'Uploading...' : 'Upload Image'}
                </button>

                {productForm.imageUrl && (
                  <div className="relative">
                    <img 
                      src={productForm.imageUrl} 
                      alt="Preview" 
                      className="w-20 h-20 object-cover rounded-lg border-2 border-purple-200"
                    />
                    <button
                      onClick={() => setProductForm({...productForm, imageUrl: ''})}
                      className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600"
                    >
                      <X />
                    </button>
                  </div>
                )}
              </div>
            </div>

            <div className="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
              <button
                onClick={() => {
                  setShowAddProduct(false);
                  setEditingProduct(null);
                  resetProductForm();
                }}
                className="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={saveProduct}
                className="px-6 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:shadow-lg transition-all"
              >
                {editingProduct ? 'Update Product' : 'Add Product'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Create Order Modal */}
      {showCreateOrder && userRole === 'admin' && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
          <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl my-8 max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6 sticky top-0 bg-white pb-4 border-b">
              <h2 className="text-2xl font-bold">Create New Order</h2>
              <button
                onClick={() => {
                  setShowCreateOrder(false);
                  setCart([]);
                  setOrderForm({
                    customerName: '', 
                    customerEmail: '', 
                    customerPhone: '',
                    deliveryAddress: '', 
                    paymentMethod: 'Cash', 
                    notes: ''
                  });
                }}
                className="text-gray-400 hover:text-gray-600"
              >
                <X className="w-6 h-6" />
              </button>
            </div>
            
            {/* Product Selection */}
            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">Add Products to Order</label>
              <input
                type="text"
                placeholder="Search products..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none mb-4"
              />
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-64 overflow-y-auto p-2 border border-gray-200 rounded-lg">
                {products
                  .filter(p => p.stock > 0 && p.name.toLowerCase().includes(searchQuery.toLowerCase()))
                  .map(product => (
                    <div key={product.id} className="border border-gray-200 rounded-lg p-3 hover:shadow-md transition-shadow">
                      <div className="flex items-center gap-3">
                        {product.imageUrl ? (
                          <img src={product.imageUrl} alt={product.name} className="w-12 h-12 object-cover rounded" />
                        ) : (
                          <div className="w-12 h-12 bg-purple-100 rounded flex items-center justify-center">
                            <Package className="w-6 h-6 text-purple-600" />
                          </div>
                        )}
                        <div className="flex-1">
                          <p className="font-medium text-sm">{product.name}</p>
                          <p className="text-xs text-gray-500">${product.price.toFixed(2)} | Stock: {product.stock}</p>
                        </div>
                        <button
                          onClick={() => addToCart(product)}
                          className="px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm"
                        >
                          Add
                        </button>
                      </div>
                    </div>
                  ))}
              </div>
            </div>

            {/* Cart */}
            {cart.length > 0 && (
              <div className="mb-6 border-t border-gray-200 pt-6">
                <h3 className="font-semibold mb-3">Order Items ({cart.length})</h3>
                <div className="space-y-2 mb-4">
                  {cart.map(item => (
                    <div key={item.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <div className="flex-1">
                        <p className="font-medium">{item.name}</p>
                        <p className="text-sm text-gray-500">${item.price.toFixed(2)} per {item.unit}</p>
                      </div>
                      <div className="flex items-center gap-3">
                        <input
                          type="number"
                          min="1"
                          max={item.stock}
                          value={item.quantity}
                          onChange={(e) => updateCartQuantity(item.id, parseInt(e.target.value) || 1)}
                          className="w-20 px-2 py-1 border border-gray-300 rounded text-center"
                        />
                        <span className="font-semibold w-24 text-right">${(item.price * item.quantity).toFixed(2)}</span>
                        <button
                          onClick={() => removeFromCart(item.id)}
                          className="text-red-500 hover:text-red-700"
                        >
                          <Trash />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="flex justify-between items-center text-xl font-bold p-4 bg-purple-50 rounded-lg">
                  <span>Total:</span>
                  <span>${calculateTotal().toFixed(2)}</span>
                </div>
              </div>
            )}

            {/* Customer Details */}
            {cart.length > 0 && (
              <div>
                <h3 className="font-semibold mb-3">Customer Details</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <input
                    type="text"
                    placeholder="Customer Name *"
                    value={orderForm.customerName}
                    onChange={(e) => setOrderForm({...orderForm, customerName: e.target.value})}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                  />
                  <input
                    type="email"
                    placeholder="Customer Email *"
                    value={orderForm.customerEmail}
                    onChange={(e) => setOrderForm({...orderForm, customerEmail: e.target.value})}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                  />
                  <input
                    type="tel"
                    placeholder="Customer Phone"
                    value={orderForm.customerPhone}
                    onChange={(e) => setOrderForm({...orderForm, customerPhone: e.target.value})}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                  />
                  <select
                    value={orderForm.paymentMethod}
                    onChange={(e) => setOrderForm({...orderForm, paymentMethod: e.target.value})}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                  >
                    <option value="Cash">Cash</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Debit Card">Debit Card</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                  </select>
                </div>
                <input
                  type="text"
                  placeholder="Delivery Address *"
                  value={orderForm.deliveryAddress}
                  onChange={(e) => setOrderForm({...orderForm, deliveryAddress: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none mb-4"
                />
                <textarea
                  placeholder="Notes / Special Instructions"
                  value={orderForm.notes}
                  onChange={(e) => setOrderForm({...orderForm, notes: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none mb-4"
                  rows="3"
                />

                <div className="flex justify-end gap-3 pt-6 border-t border-gray-200">
                  <button
                    onClick={() => {
                      setShowCreateOrder(false);
                      setCart([]);
                      setOrderForm({
                        customerName: '', 
                        customerEmail: '', 
                        customerPhone: '',
                        deliveryAddress: '', 
                        paymentMethod: 'Cash', 
                        notes: ''
                      });
                    }}
                    className="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors"
                  >
                    Cancel
                  </button>
                  <button
  onClick={submitOrder}
  disabled={cart.length === 0 || submittingOrder}
  className="px-6 py-2 rounded-lg bg-gradient-to-r from-orange-500 to-yellow-500 text-white hover:shadow-lg transition-all disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2"
>
  {submittingOrder ? (
    <>
      <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
      Processing...
    </>
  ) : (
    'Submit Order'
  )}
</button>
                </div>
              </div>
            )}

            {cart.length === 0 && (
              <div className="text-center py-8">
                <ShoppingCart className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                <p className="text-gray-500">Add products to create an order</p>
              </div>
            )}
          </div>
        </div>
      )}


{/* Order Details Modal */}
{showOrderDetails && selectedOrder && (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-3xl my-8">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-2xl font-bold">Order Details - {selectedOrder.orderNumber}</h2>
        <button
          onClick={() => {
            setShowOrderDetails(false);
            setSelectedOrder(null);
          }}
          className="text-gray-400 hover:text-gray-600"
        >
          <X className="w-6 h-6" />
        </button>
      </div>

      <div className="space-y-6">
        {/* Status */}
        <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <span className="font-semibold text-gray-700">Status:</span>
          <span className={`px-4 py-2 rounded-full text-sm font-semibold ${
            selectedOrder.status === 'completed' ? 'bg-green-100 text-green-800' :
            selectedOrder.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
            selectedOrder.status === 'processing' ? 'bg-blue-100 text-blue-800' :
            'bg-red-100 text-red-800'
          }`}>
            {selectedOrder.status.charAt(0).toUpperCase() + selectedOrder.status.slice(1)}
          </span>
        </div>

        {/* Customer & Delivery */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="p-4 bg-purple-50 rounded-lg">
            <h3 className="font-semibold text-gray-800 mb-2">Customer Information</h3>
            <p className="text-sm text-gray-700"><strong>Name:</strong> {selectedOrder.customerName}</p>
            <p className="text-sm text-gray-700"><strong>Email:</strong> {selectedOrder.customerEmail}</p>
            {selectedOrder.customerPhone && (
              <p className="text-sm text-gray-700"><strong>Phone:</strong> {selectedOrder.customerPhone}</p>
            )}
          </div>

          <div className="p-4 bg-blue-50 rounded-lg">
            <h3 className="font-semibold text-gray-800 mb-2">Delivery Information</h3>
            <p className="text-sm text-gray-700"><strong>Address:</strong> {selectedOrder.deliveryAddress}</p>
            <p className="text-sm text-gray-700"><strong>Payment:</strong> {selectedOrder.paymentMethod}</p>
          </div>
        </div>

        {/* Items */}
        <div>
          <h3 className="font-semibold text-gray-800 mb-3">Order Items</h3>
          <div className="space-y-2">
            {selectedOrder.items?.map((item, idx) => (
              <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                <div className="flex-1">
                  <p className="font-medium text-gray-800">{item.name}</p>
                  <p className="text-sm text-gray-500">SKU: {item.sku} | Qty: {item.quantity} {item.unit}</p>
                </div>
                <div className="text-right">
                  <p className="font-semibold text-gray-900">${item.subtotal.toFixed(2)}</p>
                  <p className="text-xs text-gray-500">${item.price.toFixed(2)} each</p>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Total */}
        <div className="flex items-center justify-between p-4 bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg">
          <span className="text-lg font-bold text-gray-800">Total Amount:</span>
          <span className="text-2xl font-bold text-purple-600">${selectedOrder.totalAmount.toFixed(2)}</span>
        </div>

        {/* Notes */}
        {selectedOrder.notes && (
          <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
            <h3 className="font-semibold text-gray-800 mb-2">Order Notes</h3>
            <p className="text-sm text-gray-700">{selectedOrder.notes}</p>
          </div>
        )}

        {/* Timestamps */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
          <div>
            <strong>Created:</strong> {selectedOrder.createdAt?.toDate().toLocaleString()}
          </div>
          {selectedOrder.updatedAt && (
            <div>
              <strong>Last Updated:</strong> {selectedOrder.updatedAt?.toDate().toLocaleString()}
            </div>
          )}
        </div>
      </div>

      <div className="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
        <button
          onClick={() => {
            setShowOrderDetails(false);
            setSelectedOrder(null);
          }}
          className="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors"
        >
          Close
        </button>
      </div>
    </div>
  </div>
)}

{/* Cancel Request Modal */}
{showCancelRequest && selectedOrder && (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-xl font-bold text-gray-800">Request Order Cancellation</h2>
        <button
          onClick={() => {
            setShowCancelRequest(false);
            setSelectedOrder(null);
            setCancelReason('');
          }}
          className="text-gray-400 hover:text-gray-600"
        >
          <X className="w-6 h-6" />
        </button>
      </div>

      <div className="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
        <p className="text-sm text-gray-700">
          <strong>Order:</strong> {selectedOrder.orderNumber}
        </p>
        <p className="text-sm text-gray-700">
          <strong>Amount:</strong> ${selectedOrder.totalAmount.toFixed(2)}
        </p>
      </div>

      <div className="mb-6">
        <label className="block text-sm font-medium text-gray-700 mb-2">
          Reason for Cancellation *
        </label>
        <textarea
          value={cancelReason}
          onChange={(e) => setCancelReason(e.target.value)}
          placeholder="Please provide a reason for cancelling this order..."
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none"
          rows="4"
        />
      </div>

      <div className="flex justify-end gap-3">
        <button
          onClick={() => {
            setShowCancelRequest(false);
            setSelectedOrder(null);
            setCancelReason('');
          }}
          className="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors"
        >
          Cancel
        </button>
        <button
          onClick={() => {
            if (!cancelReason.trim()) {
              alert('Please provide a reason for cancellation');
              return;
            }
            requestOrderCancellation(selectedOrder.id, cancelReason);
          }}
          className="px-6 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors"
        >
          Submit Request
        </button>
      </div>
    </div>
  </div>
)}






{/* Add/Edit Supplier Modal */}
{showAddSupplier && (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl my-8">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-2xl font-bold">{editingSupplier ? 'Edit Supplier' : 'Add New Supplier'}</h2>
        <button
          onClick={() => {
            setShowAddSupplier(false);
            setEditingSupplier(null);
            resetSupplierForm();
          }}
          className="text-gray-400 hover:text-gray-600"
        >
          <X className="w-6 h-6" />
        </button>
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {editingSupplier && (
          <div className="md:col-span-2">
            <label className="block text-sm font-medium text-gray-700 mb-1">Supplier Code</label>
            <input
              type="text"
              value={supplierForm.supplierCode}
              readOnly
              className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 font-mono"
            />
          </div>
        )}

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Supplier Name *</label>
          <input
            type="text"
            placeholder="Enter supplier name"
            value={supplierForm.name}
            onChange={(e) => setSupplierForm({...supplierForm, name: e.target.value})}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Contact Person</label>
          <input
            type="text"
            placeholder="Enter contact person name"
            value={supplierForm.contactPerson}
            onChange={(e) => setSupplierForm({...supplierForm, contactPerson: e.target.value})}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
          <input
            type="email"
            placeholder="Enter email address"
            value={supplierForm.email}
            onChange={(e) => setSupplierForm({...supplierForm, email: e.target.value})}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Payment Terms</label>
          <select
            value={supplierForm.paymentTerms}
            onChange={(e) => setSupplierForm({...supplierForm, paymentTerms: e.target.value})}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none"
          >
            {supplierSettings.paymentTermsOptions.map(term => (
              <option key={term} value={term}>{term}</option>
            ))}
          </select>
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Currency</label>
          <select
            value={supplierForm.currency}
            onChange={(e) => setSupplierForm({...supplierForm, currency: e.target.value})}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none"
          >
            {supplierSettings.currencyOptions.map(curr => (
              <option key={curr} value={curr}>{curr}</option>
            ))}
          </select>
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Mode of Shipment</label>
          <select
            value={supplierForm.modeOfShipment}
            onChange={(e) => setSupplierForm({...supplierForm, modeOfShipment: e.target.value})}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none"
          >
            {supplierSettings.shipmentModeOptions.map(mode => (
              <option key={mode} value={mode}>{mode}</option>
            ))}
          </select>
        </div>

        <div className="md:col-span-2">
          <label className="block text-sm font-medium text-gray-700 mb-1">Address</label>
          <textarea
            placeholder="Enter complete address"
            value={supplierForm.address}
            onChange={(e) => setSupplierForm({...supplierForm, address: e.target.value})}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none"
            rows="3"
          />
        </div>
      </div>

      <div className="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
        <button
          onClick={() => {
            setShowAddSupplier(false);
            setEditingSupplier(null);
            resetSupplierForm();
          }}
          className="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors"
        >
          Cancel
        </button>
        <button
          onClick={saveSupplier}
          className="px-6 py-2 rounded-lg bg-gradient-to-r from-teal-500 to-green-500 text-white hover:shadow-lg transition-all"
        >
          {editingSupplier ? 'Update Supplier' : 'Add Supplier'}
        </button>
      </div>
    </div>
  </div>
)}

{/* Supplier Settings Modal */}
{showSupplierSettings && (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl my-8">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-2xl font-bold">Supplier Settings</h2>
        <button
          onClick={() => setShowSupplierSettings(false)}
          className="text-gray-400 hover:text-gray-600"
        >
          <X className="w-6 h-6" />
        </button>
      </div>

      <div className="space-y-6">
        {/* Code Settings */}
        <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
          <h3 className="font-semibold text-gray-800 mb-4">Supplier Code Settings</h3>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Code Prefix</label>
              <input
                type="text"
                value={supplierSettings.codePrefix}
                onChange={(e) => setSupplierSettings({...supplierSettings, codePrefix: e.target.value.toUpperCase()})}
                placeholder="SUP"
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
              <p className="text-xs text-gray-500 mt-1">Example: SUP, PUR, VEND</p>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Starting Number</label>
              <input
                type="number"
                min="1"
                value={supplierSettings.startingNumber}
                onChange={(e) => setSupplierSettings({...supplierSettings, startingNumber: parseInt(e.target.value) || 1})}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
              <p className="text-xs text-gray-500 mt-1">Next code: {supplierSettings.codePrefix}-{String(supplierSettings.startingNumber).padStart(4, '0')}</p>
            </div>
          </div>
        </div>

        {/* Payment Terms */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Payment Terms Options</label>
          <div className="space-y-2">
            {supplierSettings.paymentTermsOptions.map((term, idx) => (
              <div key={idx} className="flex items-center gap-2">
                <input
                  type="text"
                  value={term}
                  onChange={(e) => {
                    const newTerms = [...supplierSettings.paymentTermsOptions];
                    newTerms[idx] = e.target.value;
                    setSupplierSettings({...supplierSettings, paymentTermsOptions: newTerms});
                  }}
                  className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                />
                <button
                  onClick={() => {
                    const newTerms = supplierSettings.paymentTermsOptions.filter((_, i) => i !== idx);
                    setSupplierSettings({...supplierSettings, paymentTermsOptions: newTerms});
                  }}
                  className="text-red-600 hover:text-red-800"
                >
                  <Trash className="w-4 h-4" />
                </button>
              </div>
            ))}
            <button
              onClick={() => {
                setSupplierSettings({
                  ...supplierSettings,
                  paymentTermsOptions: [...supplierSettings.paymentTermsOptions, 'New Term']
                });
              }}
              className="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1"
            >
              <Plus className="w-4 h-4" /> Add Payment Term
            </button>
          </div>
        </div>

        {/* Currency Options */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Currency Options</label>
          <div className="space-y-2">
            {supplierSettings.currencyOptions.map((curr, idx) => (
              <div key={idx} className="flex items-center gap-2">
                <input
                  type="text"
                  value={curr}
                  onChange={(e) => {
                    const newCurr = [...supplierSettings.currencyOptions];
                    newCurr[idx] = e.target.value.toUpperCase();
                    setSupplierSettings({...supplierSettings, currencyOptions: newCurr});
                  }}
                  className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                />
                <button
                  onClick={() => {
                    const newCurr = supplierSettings.currencyOptions.filter((_, i) => i !== idx);
                    setSupplierSettings({...supplierSettings, currencyOptions: newCurr});
                  }}
                  className="text-red-600 hover:text-red-800"
                >
                  <Trash className="w-4 h-4" />
                </button>
              </div>
            ))}
            <button
              onClick={() => {
                setSupplierSettings({
                  ...supplierSettings,
                  currencyOptions: [...supplierSettings.currencyOptions, 'XXX']
                });
              }}
              className="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1"
            >
              <Plus className="w-4 h-4" /> Add Currency
            </button>
          </div>
        </div>

        {/* Shipment Mode Options */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Shipment Mode Options</label>
          <div className="space-y-2">
            {supplierSettings.shipmentModeOptions.map((mode, idx) => (
              <div key={idx} className="flex items-center gap-2">
                <input
                  type="text"
                  value={mode}
                  onChange={(e) => {
                    const newModes = [...supplierSettings.shipmentModeOptions];
                    newModes[idx] = e.target.value;
                    setSupplierSettings({...supplierSettings, shipmentModeOptions: newModes});
                  }}
                  className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                />
                <button
                  onClick={() => {
                    const newModes = supplierSettings.shipmentModeOptions.filter((_, i) => i !== idx);
                    setSupplierSettings({...supplierSettings, shipmentModeOptions: newModes});
                  }}
                  className="text-red-600 hover:text-red-800"
                >
                  <Trash className="w-4 h-4" />
                </button>
              </div>
            ))}
            <button
              onClick={() => {
                setSupplierSettings({
                  ...supplierSettings,
                  shipmentModeOptions: [...supplierSettings.shipmentModeOptions, 'New Mode']
                });
              }}
              className="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1"
            >
              <Plus className="w-4 h-4" /> Add Shipment Mode
            </button>
          </div>
        </div>
      </div>

      <div className="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
        <button
          onClick={() => setShowSupplierSettings(false)}
          className="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors"
        >
          Cancel
        </button>
        <button
          onClick={saveSupplierSettings}
          className="px-6 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-indigo-500 text-white hover:shadow-lg transition-all"
        >
          Save Settings
        </button>
      </div>
    </div>
  </div>
)}

{/* Invoice Settings Modal */}
{showInvoiceSettings && (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl my-8">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-2xl font-bold">Invoice Settings</h2>
        <button
          onClick={() => setShowInvoiceSettings(false)}
          className="text-gray-400 hover:text-gray-600"
        >
          <X className="w-6 h-6" />
        </button>
      </div>

      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
          <input
            type="text"
            value={invoiceSettings.companyName}
            onChange={(e) => setInvoiceSettings({...invoiceSettings, companyName: e.target.value})}
            placeholder="Your Company Name"
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 outline-none"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Company TIN</label>
          <input
            type="text"
            value={invoiceSettings.companyTIN}
            onChange={(e) => setInvoiceSettings({...invoiceSettings, companyTIN: e.target.value})}
            placeholder="XXX-XXX-XXX-XXX"
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 outline-none"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Company Address</label>
          <textarea
            value={invoiceSettings.companyAddress}
            onChange={(e) => setInvoiceSettings({...invoiceSettings, companyAddress: e.target.value})}
            placeholder="Complete business address"
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 outline-none"
            rows="3"
          />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Default VAT %</label>
            <input
              type="number"
              step="0.01"
              min="0"
              max="100"
              value={invoiceSettings.defaultVAT}
              onChange={(e) => setInvoiceSettings({...invoiceSettings, defaultVAT: e.target.value})}
              placeholder="12"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 outline-none"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Invoice Prefix</label>
            <input
              type="text"
              value={invoiceSettings.invoicePrefix}
              onChange={(e) => setInvoiceSettings({...invoiceSettings, invoicePrefix: e.target.value.toUpperCase()})}
              placeholder="INV"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 outline-none"
            />
          </div>
        </div>
      </div>

      <div className="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
        <button
          onClick={() => setShowInvoiceSettings(false)}
          className="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors"
        >
          Cancel
        </button>
        <button
          onClick={saveInvoiceSettings}
          className="px-6 py-2 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-500 text-white hover:shadow-lg transition-all"
        >
          Save Settings
        </button>
      </div>
    </div>
  </div>
)}














    </div>
  );
}

ReactDOM.render(<Dashboard />, document.getElementById('root'));

</script>
</body>
</html>
